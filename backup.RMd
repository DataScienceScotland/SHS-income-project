

##### by economic status {#earneco}

Weekly net equivalised median and mean household earnings, aggregated weekly earnings, and number of households by economic status of household head (including all households):

```{r earnings_inc}

tidydata %>%
  filter(type == "earn") %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount,
                                  probs = 0.5,
                                  weights = ppwgt),
            mean = wtd.mean(amount,
                            weights = hhwgt),
            total = sum(amount * equ * hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, desc(total)),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, prefix = "£", accuracy = 1)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, prefix = "£", accuracy = 1)),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, accuracy = 10000))) %>%
    arrange(desc(HIHemp)) %>%
    knitr::kable(align = "llrrrrr")
```

Note that the 95% confidence intervals (C.I.s) of the median are based on a bootstrap methodology. For the HBAI, the boostrapped C.I.s do not account for the complex survey design. They are therefore only illustrative and may be wider. The C.I.s calculated for the SHS take into account the survey design (stratification by council areas).

```{r earnings_ci}

# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "earn",
                              survey == "HBAI",
                              HIHemp %in% empstatnames[1:3]) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "earn",
                              survey == "SHS",
                              HIHemp %in% empstatnames[1:3]) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, desc(Median))) %>%
  filter(n >= 50) %>%
  ggplot() +
  geom_point(aes(x = HIHemp,
                 y = Median,
                 colour = survey),
             size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_hline(yintercept = medianearnings["HBAI"],
             colour = cols_survey[1],
             alpha = 0.2,
             size = 1.5) +
  geom_hline(yintercept = medianearnings["SHS"],
             colour = cols_survey[2],
             alpha = 0.2,
             size = 1.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household earnings',
         subtitle = "Includes all households; lines show overall medians") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800)) +
  theme(panel.grid.major.y = element_blank())
```

Weekly net equivalised median and mean household earnings, aggregated weekly earnings, and number of households reporting any earnings by economic status of household head (excluding households with no earnings):

```{r earnings_exc}

tidydata %>%
  filter(type == "earn",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount,
                                  probs = 0.5,
                                  weights = ppwgt),
            mean = wtd.mean(amount,
                            weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, desc(total)),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£", accuracy = 1)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£", accuracy = 1)),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, accuracy = 10000))) %>%
  arrange(desc(HIHemp)) %>%
  knitr::kable(align = "llrrrrr")
```

##### by household type {#earnhhtype}

Weekly net equivalised median and mean household earnings, aggregated weekly earnings, and number of households by household type (all households):
```{r earnings_hhtype_inc}

tidydata %>%
  filter(type == "earn") %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount,
                                  probs = 0.5,
                                  weights = ppwgt),
            mean = wtd.mean(amount,
                            weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(hhtype) %>%
  mutate(median =  ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£", accuracy = 1)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£", accuracy = 1)),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, accuracy = 10000))) %>%
  knitr::kable(align = "lrrrrrr")
```

Note that the 95% confidence intervals (C.I.s) of the median are based on a bootstrap methodology. For the HBAI, the boostrapped C.I.s do not account for the complex survey design. They are therefore only illustrative and may be wider. The C.I.s calculated for the SHS take into account the survey design (stratification by council areas).

Adults refer to working-age adults without children unless otherwise stated. Pensioners refer to people above state-pension age. Children refer to dependent children.

```{r earnings_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "earn",
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "earn",
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(Median))) %>%
  filter(n >= 50) %>%
  ggplot() +
  geom_point(aes(x = hhtype,
                 y = Median,
                 colour = survey),
             size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_hline(yintercept = medianearnings["HBAI"],
             colour = cols_survey[1],
             alpha = 0.2,
             size = 1.5) +
  geom_hline(yintercept = medianearnings["SHS"],
             colour = cols_survey[2],
             alpha = 0.2,
             size = 1.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household earnings',
         subtitle = str_wrap("Includes households with and without earnings; sample >= 50; lines show overall medians", 75)) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

Weekly net equivalised median and mean household earnings, aggregated weekly earnings, and number of households reporting any earnings by household type (excluding households with no earnings):
```{r earnings_hhtype_exc}

tidydata %>%
  filter(type == "earn",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount,
                                  probs = 0.5,
                                  weights = ppwgt),
            mean = wtd.mean(amount,
                            weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(hhtype) %>%
  mutate(median =  ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£", accuracy = 1)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£", accuracy = 1)),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, accuracy = 10000))) %>%
  knitr::kable(align = "lrrrrrr")
```

##### by income decile {#earndec}

Note that the 95% confidence intervals (C.I.s) of the median are based on a bootstrap methodology. For the HBAI, the boostrapped C.I.s do not account for the complex survey design. They are therefore only illustrative and may be wider. The C.I.s calculated for the SHS take into account the survey design (stratification by council areas).

```{r earnings_deciles}

# Earnings by hhld income decile
# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "decile",
                data = filter(tidydata,
                              type == "earn",
                              survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "decile",
                data = filter(tidydata,
                              type == "earn",
                              survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         decile = factor(decile)) %>%
  filter(!is.na(Median)) %>%
  ggplot() +
  geom_point(aes(x = decile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = decile,
                   xend = decile,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household earnings by household income decile',
         subtitle = 'Includes all households') +
  scale_y_continuous(labels = comma_format(prefix = "£"), breaks = c(0, 200, 400, 600, 800, 1000, 1200)) +
  coord_flip(ylim = c(-25, 1175))
```


##### by council area {#earncounc}

***

Note that the FRS is not designed to provide sub-Scotland disaggregation. The Scottish sample in the FRS is stratified into six regions, but the FRS _grossing regime_ doesn't look below Scotland-level. For the council area analysis further below, we exclude those council areas where the household populations differ by more than 50% between FRS/HBAI and SHS.

```{r hhlds_council}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(sample >= 50) %>%
  select(-sample) %>%
  spread(survey, households) %>%
  filter(!is.na(HBAI)) %>%
  mutate(diff = (HBAI - SHS)/SHS,
         diffsize = ifelse(abs(diff) < 0.5, "HBAI", "SHS"),
         council = fct_reorder(council, diff)) %>%
  ggplot(aes(x = council, y = diff, fill = diffsize)) +
  geom_col(position = "dodge") +
  annotate("text", x = 18, y = 0.6,
           label = "Difference > 50%",
           hjust = 0, colour = cols_survey[2],
           fontface = "bold") +
  scale_y_continuous(labels = percent_format(1)) +
  scale_fill_manual(values = cols_survey, guide = FALSE) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Difference in SHS and HBAI household populations by council area",
       subtitle = str_wrap("Positive values = HBAI population higher than SHS population; excludes councils with < 50 cases", 80))
```

***

Weekly net equivalised household earnings by council area (including all households, but excluding council areas where population differences are > 50%):
```{r earnings_council_inc}

tidydata %>%
  filter(type == "earn",
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(council, survey) %>%
  mutate(median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1 , prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000))) %>%
  knitr::kable(align = "llrrrrr")
```

Note that the FRS is not designed to provide sub-Scotland disaggregation. The Scottish sample in the FRS is stratified into six regions, but the FRS _grossing regime_ doesn't look below Scotland-level. For the council area analysis further below, we exclude those council areas where the household populations differ by more than 50% between FRS/HBAI and SHS.

```{r earnings_council_ci}

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "earn",
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "earn",
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(council = fct_reorder2(council, survey, desc(Median))) %>%
  ggplot() +
  geom_point(aes(x = council, y = Median, colour = survey),
             size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_hline(yintercept = medianearnings["HBAI"],
             colour = cols_survey[1],
             alpha = 0.2,
             size = 1.5) +
  geom_hline(yintercept = medianearnings["SHS"],
             colour = cols_survey[2],
             alpha = 0.2,
             size = 1.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household earnings by council area',
         subtitle = str_wrap('Includes all households, councils with >= 50 cases, and councils where household population is off by < 50%; lines show Scotland medians', 80)) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-250, 800))
```

Weekly net equivalised household earnings by council area (excludes households with zero earnings, and council areas where population differences are > 50%):
```{r earnings_council_exc}

tidydata %>%
  filter(type == "earn",
         amount != 0,
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(council, survey) %>%
  mutate(median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1 , prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000))) %>%
  knitr::kable(align = "llrrrrr")
```

#### Benefit income {#benefits}

##### Summary stats {#bensumm}

Weekly benefit household income, equivalised median and mean, aggregated total, and number of households (including all households):
```{r median_benefits_inc}

all <- tidydata %>%
  filter(type == "ben") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "All") %>%
  select(group, everything())

waa <- tidydata %>%
  filter(type == "ben",
         pnwgt == 0,
         chwgt == 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Working-age households with no children") %>%
  select(group, everything())

waakids <- tidydata %>%
  filter(type == "ben",
         pnwgt == 0,
         chwgt > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Working-age households with children") %>%
  select(group, everything())

pns <- tidydata %>%
  filter(type == "ben",
         pnwgt > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Pensioner households") %>%
  select(group, everything())

rbind(all, waa, waakids, pns) %>%
  knitr::kable(align = "llrrrrr")
```

Weekly benefit household income, equivalised median and mean, aggregated total, and number of households receiving benefits (excludes households with no benefit income):
```{r median_benefits_exc}

all <- tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "All") %>%
  select(group, everything())

waa <- tidydata %>%
  filter(type == "ben",
         pnwgt == 0,
         chwgt == 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Working-age households with no children") %>%
  select(group, everything())

waakids <- tidydata %>%
  filter(type == "ben",
         pnwgt == 0,
         chwgt > 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Working-age households with children") %>%
  select(group, everything())

pns <- tidydata %>%
  filter(type == "ben",
         pnwgt > 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000),
         group = "Pensioner households") %>%
  select(group, everything())

rbind(all, waa, waakids, pns) %>%
  knitr::kable(align = "llrrrrr")
```

##### by decile and benefit type {#benincdec}

We combined the following disability and carers' benefits into "Disability":

- Personal Independence Payment
- Disability Living Allowance
- Employment and Support Allowance
- Attendance Allowance
- Carer's Allowance
- Incapacity Benefit
- Severe Disablement Allowance
- Industrial Injuries Disablement Benefit

We included Carer’s Allowance in this list as I expect most carers to live in the same household as the person they care for.

```{r benefits_types_decile_waa}

tidybens %>%
  filter(pnwgt == 0,
         chwgt == 0) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, decile, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            total = sum(hhwgt*amount*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey, decile) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(decile = factor(decile),
         type = fct_reorder(type, mean)) %>%
  ggplot(aes(x = decile, y = mean, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "Working-age households with no children - main benefits",
       subtitle = str_wrap("Weekly equivalised mean benefit income of the five largest benefits in each income decile; includes households with and without any benefit income", 80),
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "right",
        panel.grid.major.x = element_blank())
```

```{r benefits_types_decile_waakids}

tidybens %>%
  filter(pnwgt == 0,
         chwgt > 0) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, decile, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            total = sum(hhwgt*amount*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey, decile) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(decile = factor(decile),
         type = fct_reorder(type, total)) %>%
  ggplot(aes(x = decile, y = mean, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "Working-age households with children - main benefits",
       subtitle = str_wrap("Weekly equivalised mean benefit income of the five largest benefits in each income decile; includes households with and without any benefit income", 80),
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "right",
        panel.grid.major.x = element_blank())
```

```{r benefits_types_decile_pn}

tidybens %>%
  filter(pnwgt > 0) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, decile, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            total = sum(hhwgt*amount*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey, decile) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(decile = factor(decile),
         type = fct_reorder(type, total)) %>%
  ggplot(aes(x = decile, y = mean, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "Pensioner households - main benefits",
       subtitle = str_wrap("Weekly equivalised mean benefit income of the five largest benefits in each income decile; includes households with and without any benefit income", 80),
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "right",
        panel.grid.major.x = element_blank())
```

##### by household type {#benhhtype}

Weekly household benefit income by household type, equivalised median and mean, aggregated total, and number of households  (including all households):
```{r benefits_hhtype_inc}

tidydata %>%
  filter(type == "ben") %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = sum(n)) %>%
  ungroup() %>%
  mutate(total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
         hhtype = factor(hhtype, levels = hhtypenames),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£"))) %>%
  arrange(hhtype, survey) %>%
  knitr::kable(align = "llrrrrr")
```


Note that this chart excludes the Two adults with children group due to too many zero values in the HBAI sample for this group.
```{r bens_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "ben",
                              survey == "HBAI",
                              hhtype != "Two adults with children") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "ben",
                              survey == "SHS",
                              hhtype != "Two adults with children") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, Median)) %>%
  filter(!is.na(Median)) %>%
  ggplot() +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Equivalised weekly median household benefit income',
         subtitle = str_wrap("Includes households with and without benefit income; sample >= 50; excludes household type Two Adults with Children", 75)) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

Weekly household benefit income by household type, equivalised median and mean, aggregated total, and number of households with benefit income (excludes households with no benefit income):
```{r benefits_hhtype_exc}

tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = sum(n)) %>%
  ungroup() %>%
  mutate(total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
         hhtype = factor(hhtype, levels = hhtypenames),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£"))) %>%
  arrange(hhtype, survey) %>%
  knitr::kable(align = "llrrrrr")
```

##### by economic status {#beneco}

Weekly household benefit income by economic status of the household head, equivalised median and mean, aggregated total, and number of households (including all households):
```{r benefits_eco_inc}

tidydata %>%
  filter(type == "ben") %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames),
         total = ifelse(survey == "HBAI" & sample < 100, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 50, "..", comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 100, "..", comma(mean, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 100, "..", comma(median, prefix = "£"))) %>%
  arrange(HIHemp, survey) %>%
  knitr::kable(align = "llrrrrr")
```

```{r bens_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "ben",
                              survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "ben",
                              survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, Median)) %>%
  filter(!is.na(Median)) %>%
  ggplot() +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Equivalised weekly median household benefit income',
         subtitle = "Includes households with and without benefit income; sample >= 50") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

Weekly household benefit income by economic status of the household head, equivalised median and mean, aggregated total, and number of households with benefit income (excludes households with no benefit income):
```{r benefits_eco_exc}

tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames),
         total = ifelse(survey == "HBAI" & sample < 100, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 50, "..", comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 100, "..", comma(mean, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 100, "..", comma(median, prefix = "£"))) %>%
  arrange(HIHemp, survey) %>%
  knitr::kable(align = "llrrrrr")
```

```{r benefits_eco_types, fig.asp = 0.8}

tidybens %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, HIHemp, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            total = sum(hhwgt*amount*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey, HIHemp) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(HIHemp = factor(HIHemp),
         type = fct_reorder(type, total)) %>%
  ggplot(aes(x = HIHemp, y = mean, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "Main benefits by economic status",
       subtitle = str_wrap("Weekly equivalised mean benefit income of the five largest benefits for each group; includes households with and without any benefit income", 80),
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip() +
  theme(legend.position = "right",
        panel.grid.major.y = element_blank())
```

##### by council area {#bencounc}

Weekly benefit household income by council area, equivalised median and mean, aggegrated total and number of households (including all households; but excludes council areas with < 50 cases, and council areas where population differences between surveys are > 50%):
```{r benefits_council_inc}

tidydata %>%
  filter(type == "ben",
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(council, survey) %>%
  mutate(median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1 , prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",  comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000))) %>%
  knitr::kable(align = "llrrrrr")
```

```{r benefits_council_ci}

# Get councils with a large enough sample size (households with earnings > 0)
councilsn50 <- filter(tidydata,
       type == "ben",
       amount != 0,
       survey == "HBAI") %>%
  group_by(council) %>%
  count() %>%
  filter(n >= 50) %>%
  select(council) %>% pull()

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "ben",
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "ben",
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         council = factor(council),
         council = fct_reorder2(council, survey, desc(Median))) %>%
  filter(!is.na(Median)) %>%
  ggplot() +
  geom_point(aes(x = council, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median benefit household income by council area',
         subtitle = str_wrap('Includes households with and without benefit income; councils with >= 50 cases; councils where household populations are off by < 50%', 80)) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

Weekly benefit household income by council area, equivalised median and mean, aggegrated total and number of households with benefit income (excludes households with no benefit income, council areas with < 50 cases, and council areas where population differences between surveys are > 50%):
```{r benefits_council_exc}

tidydata %>%
  filter(type == "ben",
         amount != 0,
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(council, survey) %>%
  mutate(median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1 , prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",  comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000))) %>%
  knitr::kable(align = "llrrrrr")
```

#### Types of benefits {#types}

##### Overview over all benefits {#typover}

Aggregated weekly benefit amounts, and how much of the actual amounts (based on admin data) are captured by each survey:
```{r ben_types}

tidybens_agg %>%
  group_by(survey) %>%
  summarise(amount = sum(amount),
            type = "total") %>%
  spread(survey, amount) %>%
  mutate(capt_HBAI = percent(HBAI/Admin, 1),
         capt_SHS = percent(SHS/Admin, 1)) %>%
  mutate_at(c("Admin", "HBAI", "SHS"), comma_format(scale = 1E-6, accuracy = 1, prefix = "£", suffix = " million")) %>%
  knitr::kable(align = "lrrrrrrrr", col.names = c("", "Admin (aggr.)", "HBAI (aggr.)", "SHS (aggr.)", "HBAI (capt.)", "SHS (capt.)"))
```

Aggregated weekly benefit amounts for each of the largest twelve benefits, each benefit's share of total benefit income (in the admin data and for each survey), how fully the _actual amounts_ (based on admin data) are captured by each survey, and how much each benefit contributes to the total benefit income difference between the two surveys:
```{r ben_types_detailed}

tidybens_agg %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(totshare = amount/sum(amount)) %>%
  gather(key, value, -survey, -type) %>%
  unite(measure, c(key, survey)) %>%
  spread(measure, value) %>%
  arrange(desc(amount_Admin)) %>%
  mutate(capt_HBAI = percent(amount_HBAI/amount_Admin, 1),
         capt_SHS = percent(amount_SHS/amount_Admin, 1),
         diff = abs(amount_HBAI - amount_SHS),
         totdiff = sum(diff, na.rm = TRUE),
         diffcontr = percent(diff/totdiff, 1)) %>%
  select(-totdiff, -diff) %>%
  mutate_at(c("amount_Admin", "amount_HBAI", "amount_SHS"),
            comma_format(scale = 1E-6, accuracy = 1, prefix = "£", suffix = " million")) %>%
  mutate_at(c("totshare_Admin", "totshare_HBAI", "totshare_SHS"), percent_format(1)) %>%
  head(12L) %>%
  knitr::kable(align = "lrrrrrrrrr", col.names = c("", "Admin (aggr.)", "HBAI (aggr.)", "SHS (aggr.)", "Admin (share)", "HBAI (share)", "SHS (share)", "HBAI (capt.)", "SHS (capt.)", "Contribution to HBAI-SHS difference"))
```

```{r ben_types_chart, fig.asp = 0.8}

tidybens_agg %>%
  filter(type %in% tail(levels(type), 14L)) %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount)) %>%
  ggplot(aes(x = fct_reorder2(type, desc(survey), desc(amount)), y = amount, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(y = amount + 8E5,
                label = str_c("£", comma(amount, scale = 1E-6), " m"), colour = survey),
            position =  position_dodge(width = 1),
            hjust = 0) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million", prefix = "£")) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Aggregated weekly benefit income of the largest benefits") +
  theme(panel.grid.major.y = element_blank())
```


Weekly equivalised mean benefit amounts for each of the largest twelve benefits (includes all households):
```{r ben_types_detailed_ave}

tidybens %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  group_by(survey, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(sample >= 50) %>%
  select(-sample) %>%
  mutate(type = factor(type),
         type = fct_reorder2(type, survey, mean)) %>%
  arrange(type) %>%
  spread(survey, mean) %>%
  mutate_at(c("HBAI", "SHS"), comma_format(prefix = "£", 0.01)) %>%
  head(12L) %>%
  knitr::kable(align = "lrr", col.names = c("", "HBAI mean amount", "SHS mean amount"))
```

Weekly equivalised **mean** benefit amounts for each of the most generous benefits (includes only households that receive the benefit; sample >= 50):
```{r ben_types_detailed_ave_inc}

tidybens %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  filter(amount != 0) %>%
  group_by(survey, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(sample >= 50) %>%
  select(-sample) %>%
  mutate(type = factor(type),
         type = fct_reorder2(type, desc(survey), mean)) %>%
  arrange(type) %>%
  spread(survey, mean) %>%
  mutate(HBAI = ifelse(is.na(HBAI), "..", comma(HBAI, prefix = "£")),
         SHS = ifelse(is.na(SHS), "..", comma(SHS, prefix = "£"))) %>%
  head(20L) %>%
  knitr::kable(align = "lrr", col.names = c("", "HBAI mean amount", "SHS mean amount"))
```

##### State Pension {#typstatepen}

See [Pensioners' incomes][Pensioners' incomes]

##### Disability benefits - which are the most important? {#disimportant}

Disability benefits include:

- Employment and Support Allowance
- Disability Living Allowance
- Personal Independence Payment
- Attendance Allowance
- Carer's Allowance
- Severe Disablement Allowance
- Industrial Injuries Disablement Benefit
- Incapacity Benefit

Further below, these benefits are combined into a single "Disability" category. I also included Carer’s Allowance in this list as I expect most carers to live in the same household as the person they care for.

Individual disability benefits, aggregated weekly total, equivalised weekly median and mean, and numbers of households where someone received this benefit (excludes households who didn't report receiving this benefit):
```{r dis_benefits}

tidybens %>%
  filter(type %in% str_trunc(disbens, 30),
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = factor(type),
         type = fct_reorder(type, total),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£")),
         households = ifelse(sample < 100 & survey == "HBAI", "..", comma(households, 10000))) %>%
  arrange(desc(type)) %>%
  knitr::kable(align = "llrrrrr")
```

##### Disability benefits - who gets them? {#diswho}

Combined disability and carer's benefits, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of a disability/carer's benefit:
```{r disability_all}

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, prefix = "£")),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000))) %>%
  knitr::kable(align = "llrrrrr")

```

Household types

Combined disability and carer's benefits, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of a disability/carer's benefit:
```{r disability_hhtype}

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(hhtype = fct_reorder2(hhtype, survey, total),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, prefix = "£")),
         households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000))) %>%
  arrange(hhtype) %>%
  knitr::kable(align = "llrrrrr")

```

Economic status of the household head

Combined disability and carer's benefits, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of a disability/carer's benefit:
```{r disability_eco}

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, total),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, prefix = "£")),
         households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000))) %>%
  arrange(HIHemp) %>%
  knitr::kable(align = "llrrrrr")

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Share of aggregated disability benefit income by economic status", 65)) +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())

```

##### Tax credits {#tc}

Tax credits, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of tax credits by economic status of household head:
```{r tax_credits}

tidybens %>%
  filter(type == "Tax Credits",
         amount != 0,
         HIHemp %in% c("Part-time Employee", "Full-time Employee", "Self-Employed")) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  arrange(HIHemp) %>%
  knitr::kable(align = "llrrrrr")
```

##### Housing Benefit {#hb}

Housing benefit, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of housing benefit by tenure:
```{r housing_benefit}

tidybens %>%
  filter(type == "Housing Benefit",
         amount != 0) %>%
  group_by(survey, tenure) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(tenure = factor(tenure),
         tenure = fct_reorder2(tenure, survey, desc(total)),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  arrange(desc(tenure)) %>%
  knitr::kable(align = "llrrrrr")
```

##### Child Benefit {#cb}

Child benefit, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of child benefit by household type (excludes households without any children and those not reporting any child benefit):
```{r child_benefit}

tidybens %>%
  filter(type == "Child Benefit",
         amount != 0,
         chwgt > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrrrrr")
```

##### Universal credit {#uc}

Universal Credit, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of universal credit (excludes households with no universal credit):
```{r universal_credit}

tidybens %>%
  filter(type == "Universal Credit",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "llrrrrr")
```

##### Pension credit {#pc}

Pension Credit, aggregated weekly amount, equivalised weekly mean and median, and number of households in receipt of pension credit (excludes households with no pension credit):
```{r pension_credit}

tidybens %>%
  filter(type == "Pension Credit",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "llrrrrr")
```


#### Single working-age adult benefit income {#singleadult}

Weekly benefit income (from all benefits) for single working-age adult households, aggregated total, equivalised median and mean, and number of single adult households (includes all households):
```{r single_adult_bens_inc}

tidydata %>%
  filter(hhtype == "Single adult",
         type == "ben") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "lrrrrr")
```

Weekly benefit income (from all benefits) for single working-age adult households, aggregated total, equivalised median and mean, and number of single adult households receiving benefits (excludes households with no benefit income):
```{r single_adult_bens_exc}

tidydata %>%
  filter(hhtype == "Single adult",
         type == "ben",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  filter(sample > 30) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "lrrrrr")
```

Weekly benefit income for single working-age adult households from the largest benefits - aggregated total, equivalised median and mean, and number of single adult households receiving each benefit:
```{r single_adult_bens_types}

tidybens %>%
  mutate(type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  filter(hhtype == "Single adult",
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = factor(type),
         type = fct_reorder2(type, survey, desc(total)),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  filter(sample > 30) %>%
  arrange(desc(type)) %>%
  head(6L) %>%
  knitr::kable(align = "llrrrrr")
```

#### Investment income {#investment}

Weekly investment income, equivalised mean and median, aggregated total, and number of households with investment income (excludes households with no investment income):
```{r investment_inc}

tidydata %>%
  filter(type == "inv") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "llrrrr")
```

Weekly investment income, equivalised mean and median, aggregated total, and number of households with investment income (excludes households with no investment income):
```{r investment_exc}

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  knitr::kable(align = "llrrrr")
```

Who has income from investments?

```{r investment_eco}

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         hhtype = fct_reorder(hhtype, share)) %>%
  ggplot(aes(x = hhtype, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, decile) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across income deciles") +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())
```

#### Pensioners' incomes {#pensioners}

##### Pensioners' income sources {#pensources}

Weekly mean equivalised total income and income sources (includes all pensioner households):
```{r pensiones_sources_b}

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner"),
         type %in% c("total", "earn", "ben", "occ", "inv")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt, na.rm = TRUE),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(prefix = "£")) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Mean equivalised weekly income and main income sources for pensioner households", 70)) +
   theme(panel.grid.major.x = element_blank())
```

Number of pensioner households who report they receive each type of income (income types based on fewer than 100 cases in the sample are excluded):
```{r pensioners_sources_c}

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner"),
         amount != 0,
         type %in% c("earn", "ben", "occ", "inv")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(households = sum(hhwgt),
            sample = n()) %>%
  filter(sample >= 100) %>%
  select(hhtype, type, households, survey) %>%
  spread(survey, households) %>%
  mutate(HBAI = ifelse(is.na(HBAI), "..", comma(HBAI, 10000)),
         SHS = ifelse(is.na(SHS), "..", comma(SHS, 10000))) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrr")
```

##### Pensioners' benefit types {#penbens}

```{r benefits_types_pntype}

tidybens %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, hhtype, type) %>%
  summarise(total = sum(hhwgt*amount*equ),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  group_by(survey, hhtype) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(type = fct_reorder(type, mean)) %>%
  ggplot(aes(x = hhtype, y = mean, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "What are the main benefits for each type of pensioner household?",
       subtitle = str_wrap("Weekly mean benefit income of the five most common benefits in each household type; includes all pensioner households", 80),
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "right") +
   theme(panel.grid.major.x = element_blank())
```

##### State pension {#statepen}

State Pension - aggregate weekly amount, equivalised weekly median and mean, and number of pensioner households (includes all pensioner households):
```{r state_pension_hhtype_inc}

tidybens %>%
  filter(type == "State Pension",
         pnwgt > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         hhtype = "All pensioner households") %>%
  select(survey, hhtype, everything()) %>%
  knitr::kable(align = "lrrrrr")

tidybens %>%
  filter(type == "State Pension",
         pnwgt > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(hhtype = fct_reorder2(hhtype, survey, desc(total)),
         households = ifelse(survey == "HBAI" & sample < 100, "..", comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..", comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..", comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..", comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrrrrr")
```

State Pension - aggregate weekly amount, equivalised weekly median and mean, and number of pensioner households in receipt of State Pension (excluding households with no state pension):
```{r state_pension_hhtype_exc}

tidybens %>%
  filter(type == "State Pension",
         pnwgt > 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£", suffix = " million")),
         hhtype = "All pensioner households") %>%
  select(survey, hhtype, everything()) %>%
  knitr::kable(align = "lrrrrr")

tidybens %>%
  filter(type == "State Pension",
         pnwgt > 0,
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(hhtype = fct_reorder2(hhtype, survey, desc(total)),
         households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
            mean = ifelse(survey == "HBAI" & sample < 50, "..",
                          comma(mean, 1, prefix = "£")),
            median = ifelse(survey == "HBAI" & sample < 50, "..",
                            comma(median, 1, prefix = "£")),
            total = ifelse(survey == "HBAI" & sample < 50, "..",
                           comma(total, scale = 1E-6, prefix = "£", suffix = " million"))) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrrrrr")
```

##### Occupational pensions {#occpen}

Occupational Pensions - aggregate weekly amount, equivalised weekly median and mean, and number of households (includes all households):
```{r occ_pension_inc}

pns <- tidydata %>%
  filter(type == "occ",
         pnwgt > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6,
                              prefix = "£",
                              suffix = " million")),
         group = "Pensioner households") %>%
  select(group, everything())
waa <- tidydata %>%
  filter(type == "occ",
         pnwgt == 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total,
                              scale = 1E-6,
                              prefix = "£",
                              suffix = " million")),
         group = "Working-age households") %>%
  select(group, everything())
all <- tidydata %>%
  filter(type == "occ") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total,
                              scale = 1E-6,
                              prefix = "£",
                              suffix = " million")),
         group = "All households") %>%
  select(group, everything())

rbind(all, pns, waa) %>%
  knitr::kable(align = "lllrrrrr")
```

```{r occ_pen_eco}

tidydata %>%
  filter(type == "occ") %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Who gets occupational pensions?",
       subtitle = str_wrap("Share of aggregated occupational pensions income
                           across household types", 80)) +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())
```

```{r occ_pen_hhtype}

tidydata %>%
  filter(type == "occ") %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         hhtype = fct_reorder(hhtype, share)) %>%
  ggplot(aes(x = hhtype, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Who gets occupational pensions?",
       subtitle = str_wrap("Share of aggregated occupational pensions income
                           by economic status of household head", 75)) +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())
```

```{r occ_pen_dec}

tidydata %>%
  filter(type == "occ") %>%
  group_by(survey, decile) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  labs(x = NULL, y = NULL,
       title = "Who gets occupational pensions?",
       subtitle = str_wrap("Share of aggregated occupational pensions income
                           across household income deciles", 80)) +
  coord_flip() +
   theme(panel.grid.major.y = element_blank())
```

Occupational Pensions - aggregate weekly amount, equivalised weekly median and mean, and number of households in receipt of occupational pensions (excluding households with no occupational pensions):
```{r occ_pension_exc}

pns <- tidydata %>%
  filter(type == "occ",
         pnwgt > 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total,
                              scale = 1E-6,
                              prefix = "£",
                              suffix = " million")),
         group = "Pensioner households") %>%
  select(group, everything())

waa <- tidydata %>%
  filter(type == "occ",
         pnwgt == 0,
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total,
                              scale = 1E-6,
                              prefix = "£",
                              suffix = " million")),
         group = "Working-age households") %>%
  select(group, everything())

all <- tidydata %>%
  filter(type == "occ",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100, "..",
                             comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50, "..",
                       comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50, "..",
                         comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50, "..",
                        comma(total, scale = 1E-6, prefix = "£",
                              suffix = " million")),
         group = "All households") %>%
  select(group, everything())
rbind(all, pns, waa) %>%
  knitr::kable(align = "lllrrrrr")
```

#### Self-employed's incomes {#selfemp}

Total weekly income and income sources of households with a self-employed household head - equivalised mean and median, aggregated total, and number of households (all households):
```{r selfemployed_sources}
tidydata %>%
  filter(HIHemp == "Self-Employed") %>%
  group_by(survey, type) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(households = ifelse(survey == "HBAI" & sample < 100 | survey == "SHS"
                             & sample < 30, "..", comma(households, 10000)),
         mean = ifelse(survey == "HBAI" & sample < 50 | survey == "SHS"
                       & sample < 30, "..", comma(mean, 1, prefix = "£")),
         median = ifelse(survey == "HBAI" & sample < 50 | survey == "SHS"
                         & sample < 30, "..", comma(median, 1, prefix = "£")),
         total = ifelse(survey == "HBAI" & sample < 50 | survey == "SHS"
                        & sample < 30, "..", comma(total, scale = 1E-6,
                                                   prefix = "£",
                                                   suffix = " million"))) %>%
  #filter(sample >=30 ) %>%
  arrange(type) %>%
  knitr::kable(align = "llrrrrr")
```

#### Income components {#components}

##### Overview over income components {#compover}

In each survey, how much does each income source contribute to total income? The income components are earnings, benefits, occupational pensions, investment income, other, private benefits, and deductions.

```{r components}

tidydata %>%
  group_by(survey, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt)) %>%
  ggplot(aes(x = type,
           y = mean,
           fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = ifelse(type == "ded", mean + 50, mean + 20),
                label = comma(mean),
                colour = survey),
            show.legend = FALSE,
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(prefix = "£")) +
  labs(title = str_wrap("Weekly equivalised mean income - total income and
                        income components", 70), x = NULL, y = NULL) +
   theme(panel.grid.major.x = element_blank())
```

And how much does each income component contribute to the _difference_ in total income?

Equivalised weekly mean amount in each survey, the absolute difference between the surveys for each income component, and how much each component contributes to the difference in total mean income. Note that these contributions are based on absolute differences and are therefore all positive percentages. There are of course other ways to illustrate the relative importance of each income component:
```{r mean_components}

tidydata %>%
  group_by(survey, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt)) %>%
  spread(survey, mean) %>%
  mutate(diff = HBAI - SHS,
         absdiff = abs(diff),
         totdiff = sum(absdiff[2:8]),
         diffcontr = ifelse(type == "total", 1, abs(diff)/totdiff)) %>%
  mutate(HBAI = comma(HBAI, prefix = "£"),
         SHS = comma(SHS, prefix = "£"),
         diff = comma(diff, prefix = "£"),
         diffcontr = percent(diffcontr, 1)) %>%
  select(type, HBAI, SHS, diff, diffcontr) %>%
  mutate(type = factor(type, levels = inctypes)) %>%
  knitr::kable(align = "lrrrr")
```


##### What drives the survey differences across the income distribution {#compdist}

For each household income decile, we looked at the equivalised weekly mean income of the main income components, earnings and benefits. This shows that it is _earnings_ that drive the total income distribution, resulting in lower SHS incomes in the lower income deciles, and higher SHS incomes in the top income deciles:
```{r mean_comp_quintiles, fig.asp = 0.8}

tidydata %>%
  filter(type %in% c("earn", "ben")) %>%
  group_by(survey, decile, type) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Weekly mean net equivalised household income for the
                        main income types by income decile", 70),
       subtitle = "Includes all households") +
  theme(panel.grid.major.x = element_blank()) +
  facet_wrap(~type, ncol = 1)
```

##### Income sources by income decile {#compdec}

```{r component_shares_decile}

# Make table showing differences in income and income compononents
tidydata %>%
  filter(type != "total",
         type != "ded",
         amount >= 0) %>%
  group_by(survey, decile, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  group_by(survey, decile) %>%
  ggplot(aes(x = decile, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = percent_format()) +
  labs(x  = NULL, y = NULL,
       title = str_wrap("Income sources as a share of aggregated total income
                        by (total) household income decile", 70),
       subtitle = "Excludes negative incomes and deductions") +
  facet_wrap(~survey, nrow = 2) +
  theme(legend.position = "right",
        axis.ticks = element_blank()) +
   theme(panel.grid.major.x = element_blank())
```

```{r component_shares_decile_abs, fig.asp = 1}

tidydata %>%
  filter(type != "total") %>%
  group_by(survey, decile, type) %>%
  summarise(mean = wtd.mean(amount, weights = hhwgt),
            sample =  n()) %>%
  ungroup() %>%
  filter(decile < 5) %>%
  mutate(decile = factor(decile)) %>%

  group_by(survey, decile) %>%
  mutate(total = sum(mean)) %>%
  ggplot(aes(x = survey, y = mean, fill = type)) +
  geom_col(position = "stack") +
  geom_point(aes(y = total), show.legend = FALSE) +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x  = NULL, y = NULL,
       title = str_wrap("Weekly mean equivalised total income and income components in the bottom four (total) household income deciles", 70),
       subtitle = "Includes all income types and all households; dots show mean total income") +
  facet_wrap(~decile) +
  theme(legend.position = "right",
        axis.ticks = element_blank()) +
   theme(panel.grid.major.x = element_blank())
```

##### Income sources by council area and urban/rural area {#comparea}

```{r inc_sources_council, fig.asp = 0.9}
tidydata %>%
  filter(type != "total",
         type != "ded",
         survey == "SHS") %>%
  group_by(survey, type, council) %>%
  summarise(total = sum(amount),
            n = n()) %>%
  group_by(survey, council) %>%
  mutate(share = total/sum(total)) %>%
  ungroup() %>%
  mutate(survey = fct_reorder(survey, share),
         type = fct_shift(type, 2),
         council = fct_reorder2(council, desc(type), desc(share))) %>%
  filter(n >= 50) %>%
  ggplot(aes(x = council, y = share, fill = type)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = percent_format()) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = str_wrap("Income sources as a share of aggregated total income by council area, SHS", 65),
       subtitle = "Excludes deductions") +
  theme(legend.position = "right") +
   theme(panel.grid.major.y = element_blank())

```

```{r inc_sources_urbrur}
tidydata %>%
  filter(type != "total",
         type != "ded",
         survey == "SHS") %>%
  group_by(type, urbrur) %>%
  summarise(total = sum(amount),
            n = n()) %>%
  group_by(urbrur) %>%
  mutate(share = total/sum(total)) %>%
  ungroup() %>%
  mutate(type = fct_shift(type, 2),
         urbrur = fct_rev(urbrur)) %>%
  ggplot(aes(x = urbrur, y = share, fill = type)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = percent_format() ) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = str_wrap("Income sources as a share of aggregated total income by urban/rural class, SHS", 65),
       subtitle = "Excludes deductions") +
  theme(legend.position = "right") +
   theme(panel.grid.major.y = element_blank())

```

##### Age profile of council areas and urban/rural areas {#ageprofile}

```{r ages_council, fig.asp = 0.9}
tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(council) %>%
  summarise(sample = n(),
            people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(children = children/people,
         adults = waadults/people,
         pensioners = pensioners/people) %>%
  select(council, children, adults, pensioners) %>%
  gather(group, share, -council) %>%
  ungroup() %>%
  mutate(group = factor(group, levels = people),
         group = fct_rev(group),
         council = fct_reorder2(council, desc(group), desc(share))) %>%
  ggplot(aes(x = council, y = share, fill = group)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = wes_palettes[["IsleofDogs1"]]) +
  scale_y_continuous(labels = percent_format()) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Age profile of council areas, SHS",
       subtitle = "Proportion of children, working-age adults and pensioners in each council") +
  guides(fill = guide_legend(reverse = TRUE)) +
   theme(panel.grid.major.y = element_blank())

```

```{r ages_urbrur}
tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(urbrur) %>%
  summarise(sample = n(),
            people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(children = children/people,
         adults = waadults/people,
         pensioners = pensioners/people) %>%
  select(urbrur, children, adults, pensioners) %>%
  gather(group, share, -urbrur) %>%
  ungroup() %>%
  mutate(group = factor(group, levels = people),
         group = fct_rev(group),
         urbrur = fct_rev(urbrur)) %>%
  ggplot(aes(x = urbrur, y = share, fill = group)) +
  geom_col(position = "stack") +
  geom_text(aes(y = ifelse(group == "children", 0.05, ifelse(group == "pensioners", 0.85, 0.5)),
                label = percent(share, 1)),
            colour = "white",
            hjust = 0,
            fontface = "bold") +
  scale_fill_manual(values = wes_palettes[["IsleofDogs1"]]) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Age profile of urban/rural areas, SHS") +
  theme(axis.text.x = element_blank(),
        axis.ticks = element_blank()) +
  guides(fill = guide_legend(reverse = TRUE)) +
   theme(panel.grid.major.y = element_blank(),
         panel.grid.major.x = element_blank())

```

##### Income sources by household type and economic status {#comptype}

```{r component_shares_hhtype}
# Make table showing differences in income and income compononents
tidydata %>%
  filter(type != "total",
         type != "ded") %>%
  group_by(survey, hhtype, type) %>%
  summarise(amount = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, desc(type), desc(amount))) %>%
  ggplot(aes(x = hhtype, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = percent_format()) +
  labs(x  = NULL, y = NULL,
       title = str_wrap("Income sources as a share of aggregated total income by household type", 60),
       subtitle = "Excludes deductions") +
  coord_flip() +
  facet_wrap(~survey, ncol = 2) +
  theme(legend.position = "right") +
   theme(panel.grid.major.y = element_blank())
```

```{r component_shares_eco}
# Make table showing differences in income and income compononents
tidydata %>%
  filter(type != "total",
         type != "ded") %>%
  group_by(survey, HIHemp, type) %>%
  summarise(amount = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, desc(type), desc(amount))) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = HIHemp, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  scale_y_continuous(labels = percent_format()) +
  labs(x  = NULL, y = NULL,
       title = str_wrap("Income sources as a share of aggregated total income by economic status of household head", 60),
       subtitle = "Excludes deductions; sample >= 50") +
  coord_flip() +
  facet_wrap(~survey, ncol = 2) +
  theme(legend.position = "right") +
   theme(panel.grid.major.y = element_blank())
```

#### Total income {#income}
##### Income distribution {#incdist}

```{r income_distributions}
tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>%
  mutate(weight = ppwgt/sum(ppwgt)) %>%
  ggplot(aes(x = amount,
             weight = weight,
             colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  geom_density(size = 1, alpha = 0.5, bw = 0.02) +
  scale_x_log10(labels = comma_format(prefix = "£"), limits = c(20, 10000)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "Net equivalised household income density distributions",
       subtitle = "Vertical lines show poverty thresholds and medians; note log x scale",
       x = "Weekly equivalised net household income",
       y = NULL) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  theme(panel.grid.major.y = element_blank(),
         panel.grid.major.x = element_blank(),
         panel.grid.minor.x = element_blank())
tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>%
  ggplot(aes(x = amount, weight = ppwgt, colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  coord_cartesian(xlim = c(0, 1000)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  geom_text(data = tail(tidydata, 1L),
            aes(x = HBAImedian + 20, y = 1, label = "Medians"),
            colour = "grey20",
            hjust = 0,
            show.legend = FALSE) +
  geom_text(data = tail(tidydata, 1L),
            aes(x = 0.6*HBAImedian + 10, y = 1, label = "Poverty lines"),
            colour = "grey20",
            hjust = 0,
            show.legend = FALSE) +
  scale_x_continuous(labels = comma_format(prefix = "£"), breaks = c(0, 200, 400, 600, 800, 1000)) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "Cumulative net equivalised household income distributions",
       subtitle = "Note linear x scale",
       x = "Weekly equivalised net household income",
       y = "Proportion of people") +
   theme(panel.grid.minor.x = element_blank(),
         axis.text.y = element_text())
```

##### Median income by income decile {#incdec}

```{r income_deciles}
tidydata %>%
  filter(type == "total") %>%
  group_by(survey, decile) %>%
  summarise(median = wtd.quantile(amount, probs=0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = median, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(median, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x = NULL, y = NULL,
       title = "Weekly median net equivalised household income by income decile",
       subtitle = "All households") +
  theme(panel.grid.major.x = element_blank())
```

```{r income_deciles_pn}
tidydata %>%
  filter(type == "total",
         pnwgt > 0) %>%
  group_by(survey, decile) %>%
  summarise(median = wtd.quantile(amount, probs=0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = median, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(median, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x = NULL, y = NULL,
       title = "Weekly median net equivalised household income by income decile",
       subtitle = "Pensioner households") +
  theme(panel.grid.major.x = element_blank())
```

```{r income_deciles_wa}
tidydata %>%
  filter(type == "total",
         pnwgt == 0,
         chwgt == 0) %>%
  group_by(survey, decile) %>%
  summarise(median = wtd.quantile(amount, probs=0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = median, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(median, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x = NULL, y = NULL,
       title = "Weekly median net equivalised household income by income decile",
       subtitle = "Working-age households without children") +
  theme(panel.grid.major.x = element_blank())
```

```{r income_deciles_ch}
tidydata %>%
  filter(type == "total",
         pnwgt == 0,
         chwgt > 0) %>%
  group_by(survey, decile) %>%
  summarise(median = wtd.quantile(amount, probs=0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = median, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(median, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  labs(x = NULL, y = NULL,
       title = "Weekly median net equivalised household income by income decile",
       subtitle = "Households with children") +
  theme(panel.grid.major.x = element_blank())
```

##### Median income by council area {#inccounc}

Weekly median net equivalised household income and 95% confidence interval of the median:
```{r median_council_ci, fig.asp = 0.7}
# Chart - Median income by council with C.I.
# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI",
                              council %in% popokcouncils) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
HBAI_CI_all <- groupwiseMedian2(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3) %>%
  mutate(survey = "HBAI") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)
# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS",
                              council %in% popokcouncils) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
SHS_CI_all <- groupwiseMedian3(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3) %>%
  mutate(survey = "SHS") %>%
  select(survey, Median, Normal.lower, Normal.upper, Conf.level,  n)
rbind(HBAI_CI_all, SHS_CI_all) %>%
  select(survey, Median, Normal.lower, Normal.upper, Conf.level,  n) %>%
  mutate_at(c("Median", "Normal.lower", "Normal.upper"), comma_format(1, prefix = "£")) %>%
           knitr::kable(align = "lrrrrr")
SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"
rbind(HBAI_CI, SHS_CI) %>%
  mutate(council = fct_reorder2(council, survey, desc(Median))) %>%
  ggplot() +
  geom_hline(yintercept = HBAImedian,
             colour = cols_survey[1],
             alpha = 0.2,
             size = 1.5) +
  geom_hline(yintercept = SHSmedian,
             colour = cols_survey[2],
             alpha = 0.2,
             size = 1.5) +
  geom_point(aes(x = council,
                 y = Median,
                 colour = survey),
             size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                   y = Normal.lower,
                   yend = Normal.upper,
                   colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household income',
         subtitle = str_wrap('Excludes council areas with large population discrepancies; lines show Scotland median', 80)) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))

```

##### Median income by urban/rural area {#incarea}

```{r median_urbrur_ci}
# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"
rbind(HBAI_CI, SHS_CI) %>%
  filter(!is.na(Median)) %>%
  ggplot(aes(x = fct_rev(urbrur), y = Median)) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(colour = survey), size = 2) +
  geom_segment(aes(xend = urbrur,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household income',
         subtitle = 'Lines show Scotland median') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

##### Median income by age group {#incage}

```{r median_agegroup_ci}
# Note that HBAI bootstrap mechanism is SRS!
ch_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI") %>%
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
wa_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI") %>%
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
pn_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata
ch_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
wa_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
pn_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
ch_HBAI_CI$group <- "Children"
wa_HBAI_CI$group <- "WorkingAgeAdults"
pn_HBAI_CI$group <- "Pensioners"
ch_SHS_CI$group <- "Children"
wa_SHS_CI$group <- "WorkingAgeAdults"
pn_SHS_CI$group <- "Pensioners"
HBAI_CI <- rbind(ch_HBAI_CI, wa_HBAI_CI, pn_HBAI_CI) %>%
  mutate(survey = "HBAI")
SHS_CI <- rbind(ch_SHS_CI, wa_SHS_CI, pn_SHS_CI) %>%
  mutate(survey = "SHS")
rbind(HBAI_CI, SHS_CI) %>%
  select(survey, group, Median, Normal.lower, Normal.upper, n) %>%
  mutate(group = factor(group, levels = agegrouplevels),
         group = fct_rev(group)) %>%
  ggplot() +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = group, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = group,
                   xend = group,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household income',
         subtitle = 'Lines show Scotland median') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

##### Median income by household type {#inchhtype}

```{r median_hhtype_ci}
# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"
rbind(HBAI_CI, SHS_CI) %>%
  filter(n >= 50) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(Median))) %>%
  ggplot(aes(x = hhtype, y = Median)) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = hhtype, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household income',
         subtitle = 'Lines show Scotland median') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```

##### Median income by economic status of highest income householder {#inceco}

```{r median_eco_ci}
# Note that HBAI bootstrap mechanism is SRS!
HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "total",
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata
SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata,
                              type == "total",
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"
rbind(HBAI_CI, SHS_CI) %>%
  mutate(HIHemp <- factor(HIHemp, levels = empstatnames),
         HIHemp = fct_reorder2(HIHemp, survey, Median)) %>%
  filter(n >= 50 ) %>%
  ggplot() +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower,
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net equivalised household income',
         subtitle = "Sample >= 50; lines show Scotland median") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  coord_flip(ylim = c(-200, 800))
```


## Poverty

```{r load_pov_data, message=FALSE, warning=FALSE, include=FALSE}
source("scr/prepPovertydata.R")
```

This section summarises the poverty analysis in the [Annex][ANNEX].

We compared relative poverty estimates before housing costs (BHC) that are based on SHS income data with those based on HBAI income data^[In contrast to the income analysis shared previously, the HBAI income variable used here is the 'standard' income used in official statistics, and the HBAI poverty threshold is based on the UK median.] and CiLIF data (Children in low-income families)^[https://www.gov.uk/government/publications/children-in-low-income-families-local-area-statistics-background-information-and-methodology/background-information-and-methodology-children-in-low-income-families-local-area-statistics]. CiLIF is DWP and HMRC's new admin-data based local child poverty measure. CiLIF numbers of children in relative poverty were calibrated to match (three-year-averaged) HBAI numbers broken down by UK region, work status, family type, and child age.

### SHS and HBAI

While we would expect poverty rates and numbers to differ slightly when using different data sources, we need to test that the SHS and HBAI identify the same household characteristics to be associated with a high (and a low) poverty risk. As we will show, this is the case.

We found that more people are in poverty in the SHS compared to the HBAI. This is largely driven by pensioners, whose poverty risk is exaggerated in the SHS (as discussed in the [Income analysis summary][Income analysis summary]). However, we also have slightly more working-age adults and children in poverty in the SHS than in the HBAI, and similarly, higher poverty rates. The composition of children and working-age adults in poverty is similar across surveys.

Disaggregating the Scottish child and working-age population by household type, economic status, tenure, council area (where available) and urban/rural area shows good agreement between SHS and HBAI. While poverty rates are generally slightly higher in the SHS, those groups of the population who have an elevated poverty risk in the HBAI also have an elevated poverty risk in the SHS.

While there is generally good agreement in the disaggregated poverty estimates between surveys, there are some discrepancies when disaggregating by economic status. These were expected and can be explained by the income data quality issues identified in the SHS income analysis: benefit underreporting contributes to fairly large differences in poverty rates between SHS and HBAI for inactive and retired households^[Poverty rates for retired, disabled and other inactive households are considerably higher in the SHS, but no significance testing was undertaken.], and similarly, the higher self-employed incomes in the SHS lead to much lower poverty rates in the SHS compared to the HBAI for this group.

All other discrepancies between disaggregated groups in the SHS and HBAI are likely to be within the measurement uncertainty of the two surveys, with the SHS poverty rates generally slightly higher than the HBAI poverty rate.

### SHS and CiLIF

SHS and CiLIF child poverty estimates for all children also match well. We therefore expect child poverty numbers to be comparable as well in the disaggregated data that follows.

Disaggregating child poverty numbers by family type, family work status, council area and urban/rural area shows very good agreement between SHS and CiLIF numbers. There are only two discrepancies: the number of children in poverty who live in non-working families (more children in poverty in the SHS), and those who live in East Renfrewshire (fewer children in poverty in the SHS). Non-working families are likely to depend on benefits, which are underreported in the SHS. This contributes to the higher numbers in poverty in the SHS. There is no obvious reason for East Renfrewhsire to have fewer children in poverty in the SHS, but the estimate is based on only 40 cases and may not less robust than those for larger council areas.

The implications of all findings for poverty measurement are as follows:

- The SHS income variable can produce reliable (BHC) poverty estimates for children and working-age adults, although some care needs to be taken when looking specifically at economically inactive or self-employed households.
- SHS-based poverty estimates differ from the Official Statistics and can therefore not be compared directly
- Guidance is required that clearly explains when to use which data source, with the Official Statistics taking priority over SHS-based poverty estimates.


### Detailed poverty analysis

#### HBAI and SHS - relative poverty

In the analysis that follows, we compare SHS-derived poverty estimates (SHS 2018 data) to HBAI-derived poverty estimates (HBAI 2018/19 data)^[While the different reporting periods may contribute to differences in the income distributions, we expect this contribution to be small compared to, for example, questionnaire differences.]. Note that we use the standard HBAI poverty definition which is based on UK median income^[The 'standard' HBAI income variable is used to produce official income and poverty statistics. It differs in two important ways from the SHS income variable: First, in includes children's incomes, and second, it is adjusted for top incomes underreporting.] and the standard HBAI income variable (as opposed to the more comparable HBAI income variable that was used in the detailed income analysis done previously). The SHS-based poverty estimates are based on Scottish median income.

Ranges show the 95% confidence intervals for SHS-based estimates. We did not calculate the equivalent HBAI confidence intervals but they are likely to be wider, as they are based on smaller samples.

The tables below show that there are more people in poverty in the SHS compared to the HBAI. This is largely driven by pensioners, whose poverty risk is exaggerated in the SHS (as discussed in [Income analysis summary][Income analysis summary]). However, if we exclude pensioners, we still have slightly more^[When comparing central estimates, more people are in relative poverty in the SHS than the HBAI. While we cannot accurately calculate uncertainty estimates for HBAI data, we don't expect the differences for working-age adults and children to be statistically significant. We expect uncertainty around HBAI-based estimates to be at least as large as uncertainty around SHS-based estimates, as sample sizes are smaller in the HBAI.] working-age adults and children in poverty in the SHS than in the HBAI. We therefore also expect slightly higher poverty rates in the SHS in the analysis that follows.

```{r poverty_numbers}

SHS_CI_ch <- confint(svytotal(~low60bhc, SHSdesign_ch))
SHS_CI_wa <- confint(svytotal(~low60bhc, SHSdesign_wa))
SHS_CI_pn <- confint(svytotal(~low60bhc, SHSdesign_pn))
SHS_CI_pp <- confint(svytotal(~low60bhc, SHSdesign_pp))

ch <- tidypovdata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(children = sum(chwgt)) %>%
  spread(survey, children) %>%
  mutate(group = "Children",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_ch[1], 10000),
                     "-",
                     comma(SHS_CI_ch[2], 10000),
                     ")"))

wa <- tidypovdata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(adults = sum(wawgt)) %>%
  spread(survey, adults) %>%
  mutate(group = "Working-age adults",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_wa[1], 10000),
                     "-",
                     comma(SHS_CI_wa[2], 10000),
                     ")"))

pn <- tidypovdata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(pensioners = sum(pnwgt)) %>%
  spread(survey, pensioners) %>%
  mutate(group = "Pensioners",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_pn[1], 10000),
                     "-",
                     comma(SHS_CI_pn[2], 10000),
                     ")"))

pp <- tidypovdata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(total = sum(ppwgt)) %>%
  spread(survey, total) %>%
  mutate(group = "Total",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_pp[1], 10000),
                     "-",
                     comma(SHS_CI_pp[2], 10000),
                     ")"))

rbind(ch, wa, pn, pp) %>%
  select(group, HBAI, SHS) %>%
  knitr::kable(align = "lrr", caption = "Numbers in relative poverty")

```

**Pensioners are excluded from the analysis that follows.**

```{r poverty_rates_exc}

ch <- svymean(~low60bhc, SHSdesign_ch)[[1]]
ch_lower <- confint(svymean(~low60bhc, SHSdesign_ch))[[1]]
ch_upper <- confint(svymean(~low60bhc, SHSdesign_ch))[[2]]

wa <- svymean(~low60bhc, SHSdesign_wa)[[1]]
wa_lower <- confint(svymean(~low60bhc, SHSdesign_wa))[[1]]
wa_upper <- confint(svymean(~low60bhc, SHSdesign_wa))[[2]]

pp <- svymean(~low60bhc, SHSdesign_chwa)[[1]]
pp_lower <- confint(svymean(~low60bhc, SHSdesign_chwa))[[1]]
pp_upper <- confint(svymean(~low60bhc, SHSdesign_chwa))[[2]]

SHS <- tribble(
  ~group, ~rate, ~lower, ~upper,
  "Children", ch, ch_lower, ch_upper,
  "Working-age adults", wa, wa_lower, wa_upper,
  "Total", pp, pp_lower, pp_upper)

SHS <- SHS %>%
  mutate(SHS = str_c(percent(rate, 1), " (", percent(lower, 1), "-", percent(upper, 1), ")" )) %>%
  select(group, SHS)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(low60bhc) %>%
  summarise(children = sum(chwgt),
            adults = sum(wawgt),
            total = sum(ppwgt)) %>%
  mutate(chrate = children/sum(children),
         warate = adults/sum(adults),
         pprate = total/sum(total))  %>%
  filter(low60bhc == 1) %>%
  select(chrate, warate, pprate) %>%
  gather(group, HBAI) %>%
  mutate(group = ifelse(group == "chrate", "Children",
                        ifelse(group == "warate", "Working-age adults", "Total")),
         HBAI = percent(HBAI, 1)) %>%
  left_join(SHS, by = "group") %>%
  knitr::kable(align = "lrr", caption = "Relative poverty rates (excluding pensioners)")

```

```{r poverty_comp_exc}

tidypovdata %>%
  filter(survey != "Admin") %>%
  group_by(survey, low60bhc) %>%
  summarise(children = sum(chwgt),
            adults = sum(wawgt),
            total = sum(chwgt + wawgt)) %>%
  filter(low60bhc == 1) %>%
  mutate(ch = children/total,
         ad = adults/total,
         all = 1) %>%
  select(survey, ch, ad, all) %>%
  gather(group, comp, -survey) %>%
  spread(survey, comp) %>%
  arrange(HBAI) %>%
  mutate(group = ifelse(group == "ch", "Children",
                        ifelse(group == "ad", "Working-age adults", "Total")),
         HBAI = percent(HBAI, 1),
         SHS = percent(SHS, 1)) %>%

  knitr::kable(align = "lrr", caption = "Composition of groups in relative poverty (excluding pensioners)")

```

##### by household type

For this analysis, note that

a) we expect SHS poverty rates (central estimates) to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_hhtype}

SHS_pp_rate <- svyby(~low60bhc, ~hhtype, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, hhtype, rate, lower, upper)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(hhtype) %>%
  mutate(allpeople = sum(chwgt+wawgt),
         sample = n()) %>%
  group_by(hhtype, low60bhc) %>%
  summarise(people = sum(chwgt+wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, hhtype, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(rate))) %>%
  filter(hhtype != "Two pensioners",
         hhtype != "Single pensioner") %>%
  ggplot(aes(x = hhtype, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf,
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"),
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by household type", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))

```

##### by economic status

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates,
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals,
c) self-employed incomes are higher in the SHS, and therefore contrary to a), we expect the poverty rate to be lower for this group, and
d) households who depend on benefits such as disability-related ones tend to underreport income in the SHS compared to the HBAI; we therefore expect poverty rates to be higher in the SHS for these groups.

```{r pov_eco}

SHS_pp_rate <- svyby(~low60bhc, ~HIHemp, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, HIHemp, rate, lower, upper)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(HIHemp) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(HIHemp, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, HIHemp, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, desc(rate))) %>%
  ggplot(aes(x = HIHemp, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf,
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"),
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by economic status of household head", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))

```

##### by council area

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_council, fig.asp = 0.9}

SHS_pp_rate <- svyby(~low60bhc, ~council, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, council, rate, lower, upper)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(council) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(council, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, council, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, survey, desc(rate))) %>%
  ggplot(aes(x = council, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf,
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"),
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by council area", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))

```

##### by urban/rural area

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_urb}

SHS_pp_rate <- svyby(~low60bhc, ~urbrur, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, urbrur, rate, lower, upper)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(urbrur) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(urbrur, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, urbrur, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(urbrur = factor(urbrur),
         urbrur = fct_reorder2(urbrur, survey, desc(rate))) %>%
  ggplot(aes(x = urbrur, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf,
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"),
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by urban / rural area", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))

```

##### by tenure

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_tenure}

SHS_pp_rate <- svyby(~low60bhc, ~tenure, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, tenure, rate, lower, upper)

tidypovdata %>%
  filter(survey == "HBAI") %>%
  group_by(tenure) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(tenure, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, tenure, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(tenure = factor(tenure),
         tenure = fct_reorder2(tenure, survey, desc(rate))) %>%
  ggplot(aes(x = tenure, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf,
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"),
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by tenure", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 55))

```

#### CiLIF and SHS - relative child poverty

Children in low-income families (CiLIF)^[https://www.gov.uk/government/publications/children-in-low-income-families-local-area-statistics-background-information-and-methodology/background-information-and-methodology-children-in-low-income-families-local-area-statistics] is DWP and HMRC's new admin-data based local child poverty measure. CiLIF numbers of children in relative poverty were calibrated to match (three-year-averaged) HBAI numbers broken down by UK region, work status, family type, and child age.

By definition, the CiLIF figure matches the official child poverty estimate for Scotland (200,000 children), which is the three-year average of the HBAI-based number of children in relative poverty befre housing costs in Scotland. The HBAI estimate in the table below (180,000) however is the single-year estimate.

Child poverty rates are not available for CiLIF because we don't have accurate estimates of the dependent child population^[A dependent child is any person aged 0-15, or aged 16-19 who is still in full-time non-advanced education and living at home.] for the disaggegrations included below.

We can see that SHS and CiLIF child poverty estimates match fairly well. We therefore expect child poverty numbers in the disaggregated data that follows to be comparable as well. (Note that the analysis compares SHS 2018 data and CiliF 2016-19 data.)


```{r cilif_all}

allcilif <- cilif_council %>%
  summarise(CiLIF = sum(Cilif))

SHS_CI <- confint(svytotal(~low60bhc, SHSdesign_ch))

tidypovdata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(SHS = sum(chwgt)) %>%
  spread(survey, SHS) %>%
  cbind(allcilif) %>%
  mutate(CiLIF = comma(CiLIF),
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI[1], 10000),
                     "-",
                     comma(SHS_CI[2], 10000),
                     ")")) %>%
  knitr::kable(align = "rrr", caption = "Number of children in relative poverty")


```

##### by family type

```{r cilif_hhtype}

svyby(~low60bhc, ~hhtype, SHSdesign_ch, svytotal, vartype = c("ci","ci")) %>%
  filter(hhtype %in% c("Single adult with children", "Two adults with children")) %>%
  left_join(cilif_hhtype, by = "hhtype") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(hhtype, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

##### by work status

Note that the term 'working' refers to adults who are in paid employment or self-employment.

```{r cilif_eco}

svyby(~low60bhc, ~work, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_work, by = "work") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(work, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

##### by council area

```{r cilif_council, fig.asp = 0.8}

cp <- tidypovdata %>%
  filter(survey == "SHS") %>%
  group_by(council) %>%
  mutate(allchildren = sum(chwgt),
         sample = n()) %>%
  group_by(council, low60bhc) %>%
  mutate(samplepov = ifelse(low60bhc == 1, sum(n()), 0)) %>%
  ungroup() %>%
  filter(samplepov >= 30)

cpnumbers <- svyby(~low60bhc, ~council, SHSdesign_ch, svytotal, vartype = c("ci","ci"))

cilifcomparison <- cpnumbers %>%
  left_join(cilif_council, by = "council") %>%
  mutate(council = fct_reorder(council, Cilif)) %>%
  rename(SHS = low60bhc) %>%
  gather(source, children, -council,  -ci_l, -ci_u) %>%
  arrange(source)

corr <- cor.test(cilifcomparison$children[1:(length(cilifcomparison$children)/2)],
                 cilifcomparison$children[(1 + length(cilifcomparison$children)/2):length(cilifcomparison$children)],
                 method = c("pearson", "kendall", "spearman"))

Pearson <- corr$estimate

cilifcomparison %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, source, desc(children))) %>%
  ggplot(aes(x = council, y = children, colour = source)) +
  geom_point(aes(size = source)) +
  geom_errorbar(data = filter(cilifcomparison, source == "SHS"),
                aes(ymin = ci_l,
                    ymax = ci_u)) +
  coord_flip() +
  scale_colour_manual(values = wes_palettes[["Moonrise2"]]) +
  scale_size_manual(values = c(3,2)) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Number of children in relative poverty BHC by council, SHS and CiLIF", 50),
       subtitle = str_wrap("Excludes council areas with SHS samples (in poverty) < 30", 60)) +
  annotate("text", x = 3, y = Inf, label = str_c("Pearson correlation: ", percent(Pearson, 0.1)), hjust = 1)

```

##### by urban/rural area

```{r cilif_urbrur}

cilif_urbrur <- cilif_urbrur %>%
  mutate(urbrur = ifelse(urbrur %in% c("Accessible Small Towns", "Remote Small Towns"), "Small Towns",
                         ifelse(urbrur %in% c("Accessible Rural", "Remote Rural"), "Rural", urbrur))) %>%
  group_by(urbrur) %>%
  summarise(Cilif = sum(Cilif))


svyby(~low60bhc, ~urbrur, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_urbrur, by = "urbrur") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(urbrur, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

## Quality assurance
