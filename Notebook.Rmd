---
title: "Income analysis"
output: 
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 1
    css: "scr/styles.css"
    
editor_options: 
  chunk_output_type: inline
---

```{r setup, include = FALSE}

# Set global chunk options

knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.5)

# Load packages

library(plyr) # needed for groupwiseMedian function
library(tidyverse)
library(naniar) # for dealing with missing values
library(labelled) # to remove labels from imported data
library(scales) # for comma and percent formats
library(ggrepel) # for non-overlapping chart annotation
library(Hmisc) # for weighted quartiles
library(boot) # needed for groupwiseMedian function
library(readxl)
library(kableExtra) # for making nice-looking tables

# Load functions

source("scr/functions.R")

# Load colour scheme and other strings

source("scr/strings.R")
source("scr/colours.R")



# Load datasets

adult_1819 <- readRDS("output/adult_1819.rds")
househol_1819 <- readRDS("output/househol_1819.rds")
benefits_1819 <- readRDS("output/benefits_1819.rds")
hbai1819 <- readRDS("output/hbai1819.rds")
person18 <- readRDS("output/person18.rds")
hhold18 <- readRDS("output/hhold18.rds")


# Create tidy datasets

source("scr/prepSHSdata.R")
source("scr/prepHBAIdata.R")


# Combine all data

source("scr/prepdata.R")

```

Documents:

* [PID (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A27886326/details)
* [Project plan (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A28035002/details)

# Earnings 

## Summary stats

Median, mean and aggregated weekly earnings (including households with no earnings).

```{r median_earnings}

tidydata %>%
  filter(type == "earn") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

```

Median, mean and aggregated weekly earnings (excluding households with no earnings).

```{r median_earnings2}

tidydata %>%
  filter(type == "earn",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

```

## by income decile

```{r earnings_deciles}

# Earnings by hhld income decile

# Note that HBAI bootstrap mechanism is SRS!

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI",
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS",
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         decile = factor(decile)) %>%
  filter(!is.na(Median))

ggplot(data = earn_CI) +
  geom_point(aes(x = decile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = decile,
                   xend = decile,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings by household income decile',
         subtitle = 'Excludes hhlds with no earnings income') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(100, 1200))

```

<div class = "box">

- Median earnings are higher in the SHS compared to the HBAI
- however, for lower income deciles, SHS earnings are slightly lower
- across income deciles, median earnings match fairly well
- There is more earnings variation in the top decile and the lowest four deciles, and less in 5th to 9th decile.
- In the 3rd decile (this is where the poverty thresholds sits), median earnings C.I.s don't overlap between the two surveys

</div>

## by economic status


Median, mean and aggregated weekly earnings by economic status of household head (excludes those with zero earnings).

```{r earnings_exc}


tidydata %>%
  filter(type == "earn",
         HIHemp %in% empstatnames[1:3],
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  arrange(HIHemp) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrrrr") %>%
  kable_styling("striped")

```

```{r earnings_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI", 
                              HIHemp %in% empstatnames[1:3],
                              amount != 0) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS", 
                              HIHemp %in% empstatnames[1:3],
                              amount != 0) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, desc(Median))) %>%
  filter(n >= 50) %>%
  ggplot() +
  geom_point(aes(x = HIHemp, 
                 y = Median, 
                 colour = survey), 
             size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household earnings',
         subtitle = "Excludes households with zero earnings") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```


<div class = "box">

- Employed earnings match fairly well, but self-employed earnings do not. (Note that I redid this analysis using the yet unpublished SHS 2019 dataset - this showed this same trend)
- Self-employed earnings are a source of the earnings differences, but not the only source (as only few people have self-employed earnings)

</div>

## by household type


Median, mean and aggregated weekly earnings by household type (excludes those with zero earnings).

```{r earnings_hhtype_exc}

tidydata %>%
  filter(type == "earn",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, 
                                  probs = 0.5, 
                                  weights = ppwgt),
            mean = wtd.mean(amount, 
                            weights = hhwgt),
            sum = sum(amount*equ*hhwgt),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(hhtype) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  filter(sample >= 50) %>%
  knitr::kable(align = "lrrrrrr") %>%
  kable_styling("striped")

```

```{r earnings_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI", 
                              amount != 0) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS", 
                              amount != 0) %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(Median))) %>%
  filter(n >= 50) %>%
  ggplot() +
  geom_point(aes(x = hhtype, 
                 y = Median, 
                 colour = survey), 
             size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household earnings',
         subtitle = "Excludes households with zero earnings; sample >= 50") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```


<div class = "box">

- Reported earnings are generally higher in the SHS than in the HBAI. {>> check this isn't due to net/gross or deductions such as pension contributions and NI<<}

</div>

## by council area

Note that the FRS is not designed to provide sub-Scotland disaggregation. The Scottish sample is stratified into 6 regions, but FRS grossing regime doesn't look below Scotland-level.

```{r hhlds_council}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(sample >= 50) %>%
  select(-sample) %>%
  spread(survey, households) %>%
  filter(!is.na(HBAI)) %>%
  mutate(diff = (HBAI - SHS)/SHS,
         diffsize = ifelse(abs(diff) < 0.5, "HBAI", "SHS"),
         council = fct_reorder(council, diff)) %>%
  ggplot(aes(x = council, y = diff, fill = diffsize)) +
  geom_col(position = "dodge") +
  annotate("text", x = 18, y = 0.6, 
           label = "Difference > 50%",
           hjust = 0, colour = cols_survey[2],
           fontface = "bold") +
  scale_y_continuous(labels = percent_format(1)) +
  scale_fill_manual(values = cols_survey, guide = FALSE) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Difference in household populations (SHS vs HBAI) by council area",
       subtitle = "Positive values = HBAI population too high; excludes councils with < 50 cases") +
  theme(legend.title = element_blank(),
        legend.position = "top")

# Get council areas where hhld pop difference isn't too large

popokcouncils <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(households = sum(hhwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(sample >= 50) %>%
  select(-sample) %>%
  spread(survey, households) %>%
  mutate(diff = (HBAI - SHS)/SHS) %>%
  filter(abs(diff) < 0.5) %>%
  select(council) %>%
  pull()

```

Weekly earnings by council area (excludes households with zero earnings, council areas with < 50 cases, and council areas where pop differences are > 50%) - this leaves only 10 councils where earnings can be compared between surveys:

```{r earnings_council}

# Get councils with a large enough sample size (households with earnings > 0)

councilsn50 <- filter(tidydata, 
       type == "earn",
       amount != 0,
       survey == "HBAI") %>%
  group_by(council) %>%
  count() %>%
  filter(n >= 50) %>%
  select(council) %>% pull()

tidydata %>%
  filter(type == "earn",
         amount != 0,
         council %in% councilsn50,
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%

  arrange(council, survey) %>%
  mutate(median = comma(median, 1, prefix = "£"),
         mean = comma(mean, 1 , prefix = "£"),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, 10000)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")


```
```{r earnings_council_ci}

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "earn", 
                              amount != 0,
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "earn", 
                              amount != 0,
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(council = fct_reorder2(council, survey, desc(Median)))

ggplot(data = earn_CI) +
  geom_point(aes(x = council, y = Median, colour = survey), 
             size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings by council area',
         subtitle = 'Excludes hhlds with no earnings, councils with < 50 cases, councils where hhld pop off by > 50%') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(100, 1000))

```

<div class = "box">

- HBAI data cannot meaningfully be analysed at a sub-Scotland level, as the weighting regime for the FRS doesn't account for geography within Scotland. Therefore, when looking at household population by council area, there are large discrepancies between SHS and HBAI.
- When only comparing the ten council areas where household numbers were similar between SHS and HBAI, median earnings matched fairly well

</div>



# Benefit income

## Summary stats

Weekly benefit income (excluding households with no benefit income).

```{r median_benefits}

tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

```

Weekly benefit income for households with no pensioners (excluding households with no benefit income):

```{r median_benefits_wa}

tidydata %>%
  filter(type == "ben",
         amount != 0,
         pnwgt == 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

```

Weekly benefit income for households with pensioners only (excluding households with no benefit income):

```{r median_benefits_pn}

tidydata %>%
  filter(type == "ben",
         amount != 0,
         pnwgt > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

```

## by income deciles

Households with no pensioners:
```{r benefits_deciles_waa}

# Benefits by hhld income decile

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI",
                              amount != 0,
                              pnwgt == 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS",
                              amount != 0,
                              pnwgt == 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         decile = factor(decile)) %>%
  filter(!is.na(Median))

ggplot(data = CI) +
  geom_point(aes(x = decile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = decile,
                   xend = decile,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Working-age adults - weekly median benefit income by household income decile',
         subtitle = 'Excludes hhlds with no benefit income and households with pensioners') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(-100, 400))

```

Types of benefits (PIP, DLA, ESA, AA, CA, IB, SDA, IIDB combined into "Disability"):
```{r benefits_types_decile_waa}

mainbens <- tidybens_agg %>%
  filter(survey == "HBAI") %>%
  mutate(type = fct_collapse(type, Disability = str_trunc(disbens, 30)),
         type = fct_reorder(type, desc(amount))) %>%
  group_by(type) %>%
  summarise(amount = sum(amount)) %>%
  head(length(cols_bens)) %>%
  select(type) %>% 
  pull()

names(cols_bens) <- mainbens

tidybens %>%
  filter(pnwgt == 0) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  count(survey, decile, type, wt = hhwgt*amount*equ, name = "total") %>%
  group_by(survey, decile) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(decile = factor(decile),
         type = fct_reorder(type, total)) %>%
  ggplot(aes(x = decile, y = total, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "What are the main benefits in each income decile?", 
       subtitle = "Aggregated weekly benefit income of the 5 most common benefits in each income decile; excludes households with pensioners",
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  theme(legend.title = element_blank())

```

Households with pensioners only:
```{r benefits_deciles_pn}

# Benefits by hhld income decile

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI",
                              amount != 0,
                              pnwgt > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS",
                              amount != 0,
                              pnwgt > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         decile = factor(decile)) %>%
  filter(!is.na(Median))

ggplot(data = CI) +
  geom_point(aes(x = decile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = decile,
                   xend = decile,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Pensioner hhlds - weekly median benefit income by household income decile',
         subtitle = 'Includes hhlds with pensioners only; excludes hhlds with no benefit income') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(-100, 400))

```

Types of benefits (PIP, DLA, ESA, AA, CA, IB, SDA, IIDB combined into "Disability"):
```{r benefits_types_decile_pn}

tidybens %>%
  filter(pnwgt > 0) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  count(survey, decile, type, wt = hhwgt*amount*equ, name = "total") %>%
  group_by(survey, decile) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(decile = factor(decile),
         type = fct_reorder(type, total)) %>%
  ggplot(aes(x = decile, y = total, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "What are the main benefits in each income decile?", 
       subtitle = "Aggregated weekly benefit income of the 5 most common benefits in each income decile; includes pensioner households only",
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  theme(legend.title = element_blank())

```

<div class = "box">

- The following analysis excludes households with no benefit income.
- Average benefit incomes and benefit income distribution are very different for households with pensioners compared to those without. Benefit incomes for working-age households are much lower than for pensioners, due to the universally provided state pension, the largest benefit.
- Mean, median and total benefit income for pensioner households is lower in the SHS than the HBAI. There are also fewer pensioner households receiving any benefits in the SHS compared to HBAI.
- Across income deciles, median benefit incomes for pensioner households are generally below, or at a similar level to the HBAI.
- Median benefit incomes for _low-income_ pensioner households differ markedly between surveys. For income deciles 3 to 10, median benefit incomes match reasonably well, although vary widely in both surveys.
- For households with no pensioners, mean, median and total benefit income is also lower in the SHS, and more markedly so, but there are more households in receipt of any benefit income in the SHS compared to the HBAI.
- Median benefit income of non-pensioner households is relatively small and driven by child benefit, housing benefit and disability benefits. Towards the lower income deciles, median benefit income increases and has a larger uncertainty.

</div>

## by household type


Equivalised weekly household income from benefits (excludes households with no benefit income):
```{r benefits_hhtype}

tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = sum(n)) %>%
  filter(sample >= 50 ) %>%
  mutate(sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn"),
         households = comma(households, 10000),
         hhtype = factor(hhtype, levels = hhtypenames)) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(hhtype, survey) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped") %>%
  row_spec(1:2, background = cols_types[5])

```

```{r bens_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI", 
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS", 
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, Median)) %>%
  filter(!is.na(Median))

ggplot(data = CI) +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Equivalised weekly median household benefit income',
         subtitle = "Excludes households with no benefit income") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(-100, 400)) 

```

## by economic status

```{r benefits_eco}

tidydata %>%
  filter(type == "ben",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = sum(n)) %>%
  filter(sample >= 50 ) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn"),
         households = comma(households, 10000)) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(HIHemp, survey) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped") %>%
  row_spec(8:11, background = cols_types[5])

```

```{r bens_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI", 
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS", 
                              amount != 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, Median)) %>%
  filter(!is.na(Median))

ggplot(data = CI) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Equivalised weekly median household benefit income',
         subtitle = "Excludes households with no benefit income") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(-90, 410)) 

```

## by council area

Weekly benefit income by council area (excludes households with no benefit income, council areas with < 50 cases, and council areas where pop differences are > 50%) - this leaves only 13 councils where benefit income can be compared between surveys:

```{r benefits_council}

# Get councils with a large enough sample size (households with earnings > 0)

councilsn50 <- filter(tidydata, 
       type == "ben",
       amount != 0,
       survey == "HBAI") %>%
  group_by(council) %>%
  count() %>%
  filter(n >= 50) %>%
  select(council) %>% pull()

tidydata %>%
  filter(type == "ben",
         amount != 0,
         council %in% councilsn50,
         council %in% popokcouncils) %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            households = sum(hhwgt),
            sample = n()) %>%
  arrange(council, survey) %>%
  mutate(median = comma(median, 1, prefix = "£"),
         mean = comma(mean, 1 , prefix = "£"),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, 10000)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped") 


```
```{r benefits_council_ci}

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "ben", 
                              amount != 0,
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "ben", 
                              amount != 0,
                              council %in% councilsn50,
                              council %in% popokcouncils,
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         council = factor(council),
         council = fct_reorder2(council, survey, Median)) %>%
  filter(!is.na(Median))

ggplot(data = CI) +
  geom_point(aes(x = council, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median benefit income by council area',
         subtitle = 'Excludes hhlds with no benefit income, councils with < 50 cases, councils where hhld pop off by > 50%') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(-100, 400))

```

# Types of benefits

Aggregated weekly benefit amounts, and how well real (= admin) data is captured by the surveys:
```{r ben_types}

tidybens_agg %>%
  group_by(survey) %>%
  summarise(amount = sum(amount),
            type = "total") %>%
  spread(survey, amount) %>%
  mutate(capt_HBAI = percent(HBAI/Admin, 1),
         capt_SHS = percent(SHS/Admin, 1)) %>%
  mutate_at(c("Admin", "HBAI", "SHS"), comma_format(scale = 1E-6, accuracy = 1)) %>%
  knitr::kable(align = "lrrrrrrrr", col.names = c("", "Admin", "HBAI", "SHS", "HBAI", "SHS")) %>%
  add_header_above(c(" " = 1, "Aggregated amount (£ million)" = 3, "Captured admin data level" = 2))

```
```{r ben_types_detailed}

tidybens_agg %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(totshare = amount/sum(amount)) %>%
  gather(key, value, -survey, -type) %>%
  unite(measure, c(key, survey)) %>%
  spread(measure, value) %>%
  arrange(desc(amount_Admin)) %>%
  mutate(capt_HBAI = percent(amount_HBAI/amount_Admin, 1),
         capt_SHS = percent(amount_SHS/amount_Admin, 1),
         totdiff = sum(amount_HBAI, na.rm = TRUE) - sum(amount_SHS, na.rm = TRUE),
         diff = amount_HBAI-amount_SHS,
         diffcontr = percent(diff/totdiff, 1)) %>%
  select(-totdiff, -diff) %>%
  mutate_at(c("amount_Admin", "amount_HBAI", "amount_SHS"), comma_format(scale = 1E-6, accuracy = 1)) %>%
  mutate_at(c("totshare_Admin", "totshare_HBAI", "totshare_SHS"), percent_format(1)) %>%
  head(14L) %>%
  knitr::kable(align = "lrrrrrrrrr", col.names = c("", "Admin", "HBAI", "SHS", "Admin", "HBAI", "SHS", "HBAI", "SHS", " ")) %>%
  add_header_above(c(" " = 1, "Aggregated amount (£ million)" = 3, "Share of total benefit income" = 3, "Captured admin data level" = 2, "Contribution to HBAI/SHS difference" = 1))

```
```{r ben_types_chart}
tidybens_agg %>%
  filter(type %in% tail(levels(type), 14L)) %>%
  mutate(type = as.character(type),
         type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount)) %>%
  ggplot(aes(x = fct_reorder2(type, desc(survey), desc(amount)), y = amount, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(y = amount + 8E5,
                label = comma(amount, scale = 1E-6), colour = survey),
            position =  position_dodge(width = 1),
            hjust = 0) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million", prefix = "£")) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Aggregated weekly benefit income of the largest benefits") +
  theme(legend.position = "top",
        legend.title = element_blank())

```
## State Pension

See [Pensioners' incomes][Pensioners' incomes]

## Disability benefits

Disability benefits combine:

- Employment and Support Allowance
- Disability Living Allowance
- Personal Independence Payment
- Attendance Allowance
- Carer's Allowance
- Severe Disablement Allowance
- Industrial Injuries Disablement Benefit
- Incapacity Benefit 

```{r dis_benefits}

tidybens %>%
  filter(type %in% str_trunc(disbens, 30),
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = fct_reorder2(type, survey, desc(mean))) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  coord_flip() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Mean disability-related benefit income per hhld",
       subtitle = "Excludes households who receive none of these benefits; sample >= 50")

tidybens %>%
  filter(type %in% str_trunc(disbens, 30),
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = fct_reorder2(type, survey, desc(n))) %>%
  filter(sample >= 100) %>%
  ggplot(aes(x = type, y = n, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  coord_flip() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of people in households receiving disability-related benefits",
       subtitle = "Sample >= 100")


```

```{r disability_hhtype}

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         hhtype = fct_reorder2(hhtype, desc(survey), desc(share))) %>%
  ggplot(aes(x = hhtype, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated disability benefits across household types") +
  coord_flip()

```

```{r disability_eco}

tidybens %>%
  filter(type %in% disbens,
         survey != "Admin",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder2(HIHemp, desc(survey), desc(share))) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated disability benefits across household types") +
  coord_flip()

```

<div class = "box">

- Disability benefit is subject to both, underreporting of the amount, and non-reporting of receipt for SHS, compared to HBAI

</div>


## Tax credits

```{r tax_credits}

tidybens %>%
  filter(type == "Tax Credits",
         amount != 0,
         HIHemp %in% c("Part-time Employee", "Full-time Employee")) %>%
  group_by(survey, HIHemp) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = n()) %>%
  filter(sample >= 50) %>%
  arrange(desc(HIHemp)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Tax credits are also underreported in the SHS compared to the HBAI. This affects mainly part-time employees.

</div>


## Housing Benefit

```{r housing_benefit}

tidybens %>%
  filter(type == "Housing Benefit",
         amount != 0) %>%
  group_by(survey, tenure) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = n()) %>%
  filter(sample >= 50) %>%
  arrange(desc(tenure)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Housing benefit amounts and numbers match fairly well between surveys; however, both surveys underreport this benefit to a similar degree.

</div>

## Child Benefit

```{r child_benefit}

tidybens %>%
  filter(type == "Child Benefit",
         amount != 0,
         chwgt > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = comma(n())) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Child benefit income in the SHS is only slightly lower than in the HBAI, due to some households with two adults and children not reporting receipt of this benefit.

</div>

## Universal credit

```{r universal_credit}

tidybens %>%
  filter(type == "Universal Credit",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = n()) %>%
  #filter(sample >= 50) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```
<div class = "box">

- Sample sizes are too small for breakdowns, but data (see above) shows that the aggregated Universal Credit amount is vastly underreported in the SHS, compared to HBAI, and even more compared to admin data.

</div>

## Pension credit

```{r pension_credit}

tidybens %>%
  filter(type == "Pension Credit",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = n()) %>%
  #filter(sample >= 50) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Sample sizes are too small for further breakdowns, but pension credit is subject to both, underreporting of the amount, and non-reporting of receipt for SHS, compared to HBAI.

</div>

# Single working-age adult benefit income

Total weekly benefit income for single working-age adult households:
```{r single_adult_bens}

tidybens %>%
  filter(hhtype == "Single adult",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(total = comma(sum(amount*hhwgt*equ), 
                          scale = 1E-6, prefix = "£",
                          suffix = " million"),
            median = comma(wtd.quantile(amount, probs = 0.5, 
                                  weights = ppwgt), 
                           prefix = "£"),
            mean = comma(wtd.mean(amount, weights = hhwgt), 
                         prefix = "£"),
            households = comma(sum(hhwgt), 10000),
            sample = n()) %>%
  knitr::kable(align = "lrrrrr") %>%
  kable_styling("striped")

```

Total weekly benefit income for single working-age adult households - main benefits:
```{r single_adult_bens_types}

tidybens %>%
  mutate(type = ifelse(type %in% str_trunc(disbens, 30), "Disability", type)) %>%
  filter(hhtype == "Single adult",
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(total = comma(sum(amount*hhwgt*equ),
                          scale = 1E-6, prefix = "£",
                          suffix = " million"),
            median = comma(wtd.quantile(amount, probs = 0.5, 
                                        weights = ppwgt),
                           prefix = "£"),
            mean = comma(wtd.mean(amount, weights = hhwgt), 
                         prefix = "£"),
            households = comma(sum(ppwgt), 10000),
            sample = n()) %>%
  filter(sample >= 110) %>%
  arrange(type) %>%
  knitr::kable(align = "llrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Many more single adult households in the SHS than the HBAI report (any) benefit income, and therefore _aggregated_ benefit income for single adult households is higher in the SHS compared to the HBAI. However, we have seen that _average_ benefit income is lower for this group in the SHS. This is mainly driven by underreporting of disability benefits, which, combined, are the most important benefits for this group.

</div>


# Investment income

Weekly equivalised investment income (excludes households with no investment income):
```{r investment}

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(total = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            households = sum(hhwgt)) %>%
  mutate(total = comma(total, scale = 1E-6, 
                       prefix  ="£", suffix = " million"),
         mean = comma(mean, prefix = "£"),
         median = comma(median, prefix = "£"),
         sample = comma(sample),
         households = comma(households, 10000)) %>%
  knitr::kable(align = "lrrrrr") %>%
  kable_styling("striped")

```

```{r investment_eco}

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip()

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         hhtype = fct_reorder(hhtype, share)) %>%
  ggplot(aes(x = hhtype, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip()

tidydata %>%
  filter(type == "inv",
         amount != 0) %>%
  group_by(survey, decile) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across income deciles") +
  coord_flip()

```

<div class = "box">

- Investment income is hugely underreported in the SHS compared to the HBAI, even though we are using the HBAI data before top-income adjustments (which would correct top incomes upwards). This is largely due to non-reporting of any investment income.
- most of investment income is held by retired households, and by working-age two adult households, therefore the underreporting in the SHS might affect the incomes of these groups more.
- similarly, most of investment income is held by the richest households

</div>

# Pensioners' incomes

```{r pensioners_sources}

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            sample = n()) %>% 
  filter(sample >= 50) %>%
  ggplot(aes(x = type, y = tot, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(scale = 1E-6,
                                           prefix = "£", 
                                           suffix = " m")) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL, 
       title = "Aggregated weekly income and income sources for pensioner households") +
  theme(legend.title = element_blank(),
        legend.position = "top")

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(mean = wtd.mean(ifelse(amount != 0, amount, NA), 
                            weights = hhwgt, na.rm = TRUE),
            sample = n()) %>% 
  filter(sample >=50) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(prefix = "£")) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL, 
       title = "Mean equivalised weekly income and income sources for pensioner households",
       subtitle = "Each bar only includes hhlds who have that type of income; sample >= 50") +
  theme(legend.title = element_blank(),
        legend.position = "top")

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(households = sum(ifelse(amount != 0, hhwgt, 0)),
            sample = n()) %>% 
  filter(sample >= 100) %>%
  ggplot(aes(x = type, y = households, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(10000)) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL, 
       title = "Numbers of pensioner households receiving income and each income type",
       subtitle = "Sample >= 100") +
  theme(legend.title = element_blank(),
        legend.position = "top")
```

Types of benefits (PIP, DLA, ESA, AA, CA, IB, SDA, IIDB combined into "Disability"):
```{r benefits_types_pntype}

tidybens %>%
  filter(pnwgt > 0,
         hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  mutate(type = factor(type),
         type = fct_collapse(type, Disability = str_trunc(disbens, 30))) %>%
  group_by(survey, hhtype, type) %>%
  summarise(total = sum(hhwgt*amount*equ)) %>%
  ungroup() %>%
  group_by(survey, hhtype) %>%
  filter(type %in% type[order(-total)[1:5]]) %>%
  ungroup() %>%
  mutate(type = fct_reorder(type, total)) %>%
  ggplot(aes(x = hhtype, y = total, fill = type)) +
  geom_col() +
  scale_fill_manual(values = cols_bens) +
  facet_wrap(~survey, nrow = 2) +
  labs(title = "What are the main benefits for each type of pensioner household?", 
       subtitle = "Aggregated weekly benefit income of the 5 most common benefits; includes pensioner households only",
       x = NULL, y = NULL) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  theme(legend.title = element_blank())

```

State Pension (sample >= 100):
```{r state_pension_hhtype}

tidybens %>%
  filter(type == "State Pension",
         amount != 0,
         pnwgt > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(households = comma(sum(hhwgt), 10000),
            mean = comma(wtd.mean(amount, weights = hhwgt), 1, prefix = "£"),
            median = comma(wtd.quantile(amount, probs = 0.5, weights = ppwgt), 1, prefix = "£"),
            total = comma(sum(hhwgt*amount*equ), scale = 1E-6, prefix = "£", suffix = " million"),
            sample = n()) %>%
  filter(sample >= 100) %>%
  arrange(desc(hhtype)) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class="box">

- aggregated income for One pensioner, one adult matches better between SHS and HBAI than aggregated income for Single pensioners and Pensioner Couples. This is because this group's income comes largely from earnings and much less from benefits. Earnings are higher in the SHS, whereas the other main income types (mainly benefits) are much lower.
- the differences in income come mainly from benefit income (state pension?), occupational pensions and investment income. 
- the difference in investment income is caused by much fewer people reporting any investment income in the SHS compared to the HBAI.

</div>

Pensioners households receiving State Pension:
```{r state_pension}

tidybens %>%
  filter(type == "State Pension",
         amount != 0,
         hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, hhtype) %>%
  summarise(total = comma(sum(amount*hhwgt*equ), scale = 1E-6,
                          prefix = "£", suffix = " million"),
            median = comma(wtd.quantile(amount, 
                                        probs = 0.5, 
                                        weights = ppwgt), 
                           prefix = "£"),
            mean = comma(wtd.mean(amount, 
                            weights = hhwgt),
                         prefix = "£"),
            households = comma(sum(hhwgt), 10000),
            sample = n()) %>%
  arrange(hhtype) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- The average amount of state pension received matches well between HBAI and SHS
- However, the SHS reports fewer recipients of state pension

</div>

Households receiving occupational pensions:
```{r occ_pension}

tidydata %>%
  filter(type == "occ",
         amount != 0) %>%
  group_by(survey) %>%
  summarise(total = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, 
                                  probs = 0.5, 
                                  weights = ppwgt),
            
            households = sum(hhwgt),
            sample = n()) %>%
  mutate(total = comma(total, scale = 1E-6, prefix  ="£", suffix = " million"),
         mean = comma(mean, prefix = "£"),
         median = comma(median, prefix = "£"),
         households = comma(households, 10000),
         sample = comma(sample)) %>%
  knitr::kable(align = "lrrrrr") %>%
  kable_styling("striped")

tidydata %>%
  filter(type == "occ",
         amount != 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = percent_format(1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated occupational pensions income across household types") +
  coord_flip()

```

<div class = "box">

- the SHS only slightly underreports income from occupational pensions compared to the HBAI.
- the underreporting is due to non-reporting
- most of occ pension income goes to retired people

</div>

# Self-employed's incomes

```{r selfemployed_sources}

tidydata %>%
  filter(HIHemp == "Self-Employed",
         amount != 0) %>%
  group_by(survey, type) %>%
  summarise(median = comma(wtd.quantile(amount, 
                                  weights = ppwgt, 
                                  probs = 0.5), 
                           prefix = "£"),
            mean = comma(wtd.mean(amount, weights = hhwgt), 
                         prefix = "£"),
            total = comma(sum(amount*hhwgt*equ),
                          scale=1E-6, prefix = "£",
                          suffix = " million"),
            households = comma(sum(hhwgt), 10000),
            sample = n()) %>% 
  filter(sample >= 100) %>%
  arrange(type) %>%
  knitr::kable(align = "llrrrrr") %>%
  kable_styling("striped")

```

<div class = "box">

- Households with self-employed head have higher earnings in SHS
- this is consistent with SHS 2019 
- maybe because SHS doesn't account for self-employed losses? Maybe definitions of self-employment differ between surveys?
- Households with self-employed head have lower benefits
- Households with self-employed head have higher incomes, driven by higher earnings

</div>

# Income components

In SHS and FRS, which income sources contribute how much to total income? 

```{r components}

tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ggplot(aes(x = type,
           y = amount,
           fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = ifelse(type == "ded", amount + 140000000, amount + 70000000),
                label = comma(amount, scale = 1E-6),
                colour = survey),
            show.legend = FALSE,
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(scale = 1E-9, 
                                          prefix = "£", 
                                          suffix = " billion", 
                                          accuracy = 0.1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Aggregated weekly income by income type", x = NULL, y = NULL)

```

How much contributes each income component to the difference in total income?

```{r aggregate_components}

tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  spread(survey, amount) %>%
  mutate(totdiff = sum(abs(HBAI[2:length(HBAI)])) - sum(abs(SHS[2:length(SHS)])),
         diff = HBAI - SHS,
         reldiff = diff/HBAI,
         diffcontr = ifelse(type == "total", 1, abs(diff)/totdiff)) %>%
  mutate(HBAI = comma(HBAI, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         SHS = comma(SHS, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         absdiff = comma(diff, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         diffcontr = percent(diffcontr, 1),
         reldiff = percent(reldiff)) %>%
  select(type, HBAI, SHS, absdiff, diffcontr) %>%
  mutate(type = factor(type, levels = inctypes)) %>%
  knitr::kable(align = "lrrrr") %>%
  kable_styling("striped")

incdiff <- tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  spread(survey, amount) %>%
  head(1L) %>%
  mutate(diff = percent(1- SHS/HBAI, accuracy = 0.1)) %>%
  select(diff) %>% 
  pull()

```

<div class = "box">

- Total income aggregated to the  whole of Scotland is largely made up of earnings, followed by benefits (which include the state pension) and occupational pensions. 
- Overall, SHS total income is `r incdiff` lower than HBAI total income. The differences come mainly from lower benefit and much lower investment income in the SHS, and then also from lower occupational pensions. Income from earnings are higher in the SHS. Other income components are relatively small and therefore contribute little to the overall differences in income.
- We have seen that the lower benefit income mostly affects pensioners (through the state pension) and households with disabled household members (though disability benefits).
- We have also seen that most of the investment income goes to the wealthiest households. This will affect the income distribution most at the tope, and might therefore not matter as much when looking at low income households. However, a large part of investment income goes to retired households, so this could ascerbate the income underreporting of these households even more.

</div>

```{r aggr_comp_quintiles}

tidydata %>%
  group_by(survey, type, quintile) %>%
  summarise(aggr = sum(hhwgt*amount*equ)) %>%
  ungroup() %>%
  arrange(quintile, type) %>%
  mutate(diff = ifelse(survey == "SHS", lag(aggr)-aggr, 0)) %>%
  filter(survey == "SHS") %>%
  select(type, diff, quintile) %>%
  ggplot(aes(x = type,
           y = diff)) +
  geom_col(position = 'dodge', aes(fill = ifelse(type == "total", 1, 0)), show.legend = FALSE) +
  scale_y_continuous(label = comma_format(scale = 1E-6, prefix = "£", suffix = " mn", accuracy = 1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Difference in aggregated weekly income by income type and income quintile",
       subtitle = "Positive values = HBAI incomes are larger / HBAI deductions are smaller", x = NULL, y = NULL) +
  facet_wrap(vars(quintile))

```

```{r component_shares_decile}

# Make table showing differences in income and income compononents

tidydata %>%
  filter(type != "total",
         type != "ded",
         amount >= 0) %>%
  group_by(survey, decile, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  group_by(survey, decile) %>%
  ggplot(aes(x = decile, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  labs(x  = NULL, y = NULL,
       title = "Share of aggregated total income by type of income and total income decile",
       subtitle = "Excludes deductions; excludes households with negative income components") +
  facet_wrap(~survey, nrow = 2) +
  theme(legend.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

```

<div class = "box">

- For all quintiles, the aggregated total income is higher in the HBAI compared to SHS, with the largest differences at the top and at the bottom quintile. However, we will see later that the _average_ income difference decreases with higher incomes.
- For the lowest income quintile, the difference is driven equally by lower earnings and lower benefits in the SHS.
- In the second income quintile (this is where the poverty threshold typically sits), the difference is smaller and mainly driven by lower earnings in the SHS.
- In the third and fourth income quintiles, SHS earnings are now higher than HBAI earnings. However, differences in benefit, occupational pension, and inverstment incomes lead to a lower total income in the SHS in these quintiles.
- In the top quintile, total income differences are due to differences in incomes from all major sources, but in particular investment income and occupational pensions. Note that this difference is mainly driven by non-reporting rather than undereporting. Therefore, the _average_ income difference at the top is small compared to lower down the income distributions.
- The lower the total income is, the less important earnings and the more important benefits become.

</div>

```{r inc_sources_council}

tidydata %>%
  filter(type != "total",
         type != "ded",
         survey == "SHS") %>%
  group_by(survey, type, council) %>%
  summarise(total = sum(amount),
            n = n()) %>%
  group_by(survey, council) %>%
  mutate(share = total/sum(total)) %>%
  ungroup() %>%
  mutate(survey = fct_reorder(survey, share),
         type = fct_shift(type, 2),
         council = fct_reorder2(council, desc(type), desc(share))) %>%
  filter(n >= 50) %>%
  ggplot(aes(x = council, y = share, fill = type)) + 
  geom_col(position = "stack") +
  scale_fill_manual(values = cols_types) +
  coord_flip() +
  labs(x = NULL, y = NULL, 
       title = "Income sources by council area, SHS",
       subtitle = "Excludes deductions") +
  theme(legend.title = element_blank())
  
```

```{r inc_sources_urbrur}

tidydata %>%
  filter(type != "total",
         type != "ded",
         survey == "SHS") %>%
  group_by(type, urbrur) %>%
  summarise(total = sum(amount),
            n = n()) %>%
  group_by(urbrur) %>%
  mutate(share = total/sum(total)) %>%
  ungroup() %>%
  mutate(type = fct_shift(type, 2),
         urbrur = fct_rev(urbrur)) %>%
  filter(n >= 50) %>%
  ggplot(aes(x = urbrur, y = share, fill = type)) + 
  geom_col(position = "stack") +
  scale_fill_manual(values = cols_types) +
  coord_flip() +
  labs(x = NULL, y = NULL, 
       title = "Income sources by urban/rural class, SHS",
       subtitle = "Sample >= 50; excludes deductions") +
  theme(legend.title = element_blank())
  
```

```{r ages_council}

tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(council) %>%
  summarise(sample = n(),
            people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(children = children/people,
         adults = waadults/people,
         pensioners = pensioners/people) %>%
  select(council, children, adults, pensioners) %>%
  gather(group, share, -council) %>%
  ungroup() %>%
  mutate(group = factor(group, levels = people),
         group = fct_rev(group),
         council = fct_reorder2(council, desc(group), desc(share))) %>%
  ggplot(aes(x = council, y = share, fill = group)) + 
  geom_col(position = "stack") +
  scale_fill_manual(values = wes_palettes[["IsleofDogs1"]]) +
  scale_y_continuous(labels = percent_format()) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Age profile of council areas, SHS") +
  theme(legend.title = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(reverse = TRUE))
  
```

```{r ages_urbrur}

tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(urbrur) %>%
  summarise(sample = n(),
            people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(children = children/people,
         adults = waadults/people,
         pensioners = pensioners/people) %>%
  select(urbrur, children, adults, pensioners) %>%
  gather(group, share, -urbrur) %>%
  ungroup() %>%
  mutate(group = factor(group, levels = people),
         group = fct_rev(group),
         urbrur = fct_rev(urbrur)) %>%
  ggplot(aes(x = urbrur, y = share, fill = group)) + 
  geom_col(position = "stack") +
  geom_text(aes(y = ifelse(group == "children", 0.05, ifelse(group == "pensioners", 0.85, 0.5)),
                label = percent(share, 1)),
            colour = "white",
            hjust = 0,
            fontface = "bold") +
  scale_fill_manual(values = wes_palettes[["IsleofDogs1"]]) +
  coord_flip() +
  labs(x = NULL, y = NULL,
       title = "Age profile of urban/rural areas, SHS",
       subtitle = "Sample >= 50") +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank(),
        axis.ticks = element_blank()) +
  guides(fill = guide_legend(reverse = TRUE))
  
```

<div class = "box">

- The six council areas with the highest benefit shares are, according to SHS data, Dumfries & Galloway, Inverclyde, North Ayrshire, East Ayrshire, West Dunbartonshire, and Dundee City. 
- The eight council areas with the largest proportion of pensioners are Na h-Eileanan Siar, Argyl & Bute, Dumfries & Galloway, South Ayrshire, Scottish Borders, Orkney Islands, Angus, and Perth and Kinross.
- Breaking the country down to urban and rural areas, small towns and other (not large) urban areas have the highest shares of benefit income. 
- Remote small towns and remote rural areas on the other hand have the largest proportions of pensioners.

</div>

```{r component_shares_hhtype}

# Make table showing differences in income and income compononents

tidydata %>%
  filter(type != "total",
         type != "ded") %>%
  group_by(survey, hhtype, type) %>%
  summarise(amount = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, desc(type), desc(amount))) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = hhtype, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  labs(x  = NULL, y = NULL,
       title = "Aggregated total income by income source and household type",
       subtitle = "Excludes deductions") +
  coord_flip() +
  facet_wrap(~survey, ncol = 2) +
  theme(legend.title = element_blank())

```

```{r component_shares_eco}

# Make table showing differences in income and income compononents

tidydata %>%
  filter(type != "total",
         type != "ded") %>%
  group_by(survey, HIHemp, type) %>%
  summarise(amount = sum(amount*hhwgt*equ),
            sample = n()) %>%
  ungroup() %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, desc(type), desc(amount))) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = HIHemp, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  labs(x  = NULL, y = NULL,
       title = "Aggregated total income by income source and economic status of household head",
       subtitle = "Sample >= 50; excludes deductions") +
  coord_flip() +
  facet_wrap(~survey, ncol = 2) +
  theme(legend.title = element_blank())

```

# Total income
## Income distribution

```{r income_distributions}

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, 
             weight = ppwgt/sum(ppwgt), 
             colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  geom_density(size = 1, alpha = 0.5, bw = 0.02) +
  scale_x_log10(limits = c(20, 20000), 
                labels = comma_format(prefix = "£")) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "Household income distributions",
       subtitle = "Vertical lines show poverty thresholds and medians",
       x = "Weekly equivalised household income",
       y = NULL) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = ppwgt, colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  coord_cartesian(xlim = c(100,1500)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  geom_text(data = tail(tidydata, 1L), 
            aes(x = HBAImedian + 20, y = 1, label = "Medians"), 
            colour = "grey20",
            hjust = 0, 
            show.legend = FALSE) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "Cumulative household income distributions",
       subtitle = "Vertical lines show relative poverty (BHC) thresholds and medians",
       x = "Weekly equivalised household income",
       y = "Proportion of people") +
  theme(legend.position = "top",
        legend.title = element_blank())

```

<div class = "box">

- The income distributions look largely similar, with the SHS income distribution being slightly wider.
- Near the relative poverty thresholds, the SHS cumulative income curve is higher, meaning more households sit below that threshold in the SHS compared to the HBAI.

</div>

## Income decile points

```{r income_deciles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, 
                                        probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), 
                                        weights = ppwgt)))) %>%
  unnest(x) %>%
  ggplot(aes(x = name, y = value, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(value, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  scale_x_discrete(labels = sprintf("%1.0f", seq(1,9))) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Income decile points",
       subtitle = "These are the nine income thresholds that split the population into 10 equal-sized groups")


```

<div class = "box">

- The income decile points are at similar levels for high incomes and diverge towards lower incomes, with (average) income increasingly underreported in the SHS at lower incomes.

</div>

## Median income by council area

```{r median_council_ci}

# Chart - Median income by council with C.I.
# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI",
                              council %in% popokcouncils) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

HBAI_CI_all <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3) %>%
  mutate(survey = "HBAI") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS",
                              council %in% popokcouncils) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI_all <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3) %>%
  mutate(survey = "SHS") %>%
  select(survey, Median, Normal.lower, Normal.upper, Conf.level,  n)

rbind(HBAI_CI_all, SHS_CI_all) %>%
  select(survey, Median, Normal.lower, Normal.upper, Conf.level,  n) %>%
  mutate_at(c("Median", "Normal.lower", "Normal.upper"), comma_format(1, prefix = "£")) %>%
           knitr::kable(align = "lrrrrr") %>%
  kable_styling("striped")


SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(council = fct_reorder2(council, survey, desc(Median)))

ggplot(CI) +
  geom_hline(yintercept = HBAImedian, 
             colour = cols_survey[1], 
             alpha = 0.2, 
             size = 1.5) +
  geom_hline(yintercept = SHSmedian, 
             colour = cols_survey[2], 
             alpha = 0.2, 
             size = 1.5) +
  geom_point(aes(x = council,
                 y = Median, 
                 colour = survey), 
             size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                   y = Normal.lower, 
                   yend = Normal.upper,
                   colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(data = filter(CI, survey == "HBAI"),
            mapping = aes(x = council, y = 780, label =  n),
            hjust = 1,
            colour = cols_survey[1],
            show.legend = FALSE) +
  geom_text(data = filter(CI, survey == "SHS"),
            mapping = aes(x = council, y = 810, label =  n),
            hjust = 1,
            colour = cols_survey[2],
            show.legend = FALSE) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household income, SHS 2018 and HBAI 2018/19',
         subtitle = 'Sample sizes shown on right; excludes council areas with large population discrepancies') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 
  
```

<div class = "box">

- Using 95% confidence intervals (C.I.), median incomes overlap (to some degree) for all council areas where the HBAI sample size is large enough to estimate the median (sample >=50, true for 22 out of the 32 council areas).
- For the HBAI, the C.I. are calculated using a bootstrapping method which resamples the dataset without accounting for the complex survey design. The HBAI C.I. are therefore only illustrative and may be wider.
- For some council areas, the overlaps are only marginal, such as Renfrewshire, Aberdeenshire, East Dunbartonshire, and Stirling even though some of these have relatively large HBAI sample sizes (Aberdeenshire, Renfrewshire).
- It would be good to check what the overlaps look like for different data years, i.e. SHS 2019 (pre-release access only) or HBAI 2017/18.

</div>

## Median income by urban/rural area


```{r median_urbrur_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  filter(!is.na(Median)) %>%
  ggplot(aes(x = fct_rev(urbrur), y = Median)) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(colour = survey), size = 2) +
  geom_segment(aes(xend = urbrur,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(aes(y = ifelse(survey == "HBAI", 700, 750), 
                label = comma(Median, accuracy = 1, prefix = "£"),
                colour = survey),
            hjust = 1,
            show.legend = FALSE) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household income, SHS 2018 and HBAI 1819',
         subtitle = 'Median values shown on right') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- Incomes overlap fairly well for urban and accessible rural areas.
- Incomes in remote rural areas overlap slightly less, but also have the smalles HBAI sample.
- Income in small towns overlaps the least.

</div>

## Median income by age group 

- child, working-age, pensioners
- also: age group of HIH??

```{r median_agegroup_ci}

# Note that HBAI bootstrap mechanism is SRS!

ch_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI") %>% 
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI") %>% 
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ch_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>% 
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>% 
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>% 
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ch_HBAI_CI$group <- "Children"
wa_HBAI_CI$group <- "WorkingAgeAdults"
pn_HBAI_CI$group <- "Pensioners"

ch_SHS_CI$group <- "Children"
wa_SHS_CI$group <- "WorkingAgeAdults"
pn_SHS_CI$group <- "Pensioners"

Age_HBAI_CI <- rbind(ch_HBAI_CI, wa_HBAI_CI, pn_HBAI_CI) %>%
  mutate(survey = "HBAI")

Age_SHS_CI <- rbind(ch_SHS_CI, wa_SHS_CI, pn_SHS_CI) %>%
  mutate(survey = "SHS")

rbind(Age_HBAI_CI, Age_SHS_CI) %>%
  select(survey, group, Median, Normal.lower, Normal.upper, n) %>%
  mutate(group = factor(group, levels = agegrouplevels),
         group = fct_rev(group)) %>%
  ggplot() +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = group, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = group,
                   xend = group,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(aes(x = group, 
                y = ifelse(survey == "HBAI", 700, 740), 
                colour = survey, 
                label = comma(Median, prefix = "£", accuracy = 1)),
            show.legend = FALSE,
            hjust = 1) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- Working-age adults' and children's incomes overlap well.
- Pensioners' incomes don't overlap.

</div>

## Median income by household type

```{r median_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  filter(n >= 50) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(Median))) %>%
  ggplot(aes(x = hhtype, y = Median)) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = hhtype, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household income') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box" >

- Incomes for most hhld types overlap well, except pensioners
- Single pensioner and pensioner couples' income don't overlap, with SHS pensioners' incomes lower than in the HBAI.
- Incomes of households with 3 or more adults and no children overlap little, but have very wide C.I., indicating large variation of incomes in this group.

</div>

## Median income by economic status of highest income householder

```{r median_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "HBAI") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "total", 
                              survey == "SHS") %>%
                mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

rbind(HBAI_CI, SHS_CI) %>%
  mutate(HIHemp <- factor(HIHemp, levels = empstatnames),
         HIHemp = fct_reorder2(HIHemp, survey, Median)) %>%
  filter(n >= 50 ) %>% 
  ggplot() +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median equivalised household income',
         subtitle = "Sample >= 50") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- incomes of full- and part-time employees match well, suggesting that income from employed earnings may also match well.
- self-employed income varies widely and overlaps only little between the two surveys.
- The HBAI unemployed sample is too small to produce estimates.
- Incomes of the retired don't match well, similarly to pensioners' incomes in the household type breakdown.
- Incomes of the disabled also doesn't match too well.

</div>
