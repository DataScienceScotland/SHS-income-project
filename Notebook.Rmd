---
title: "Income analysis"
output: 
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 1
    css: "scr/styles.css"
    
editor_options: 
  chunk_output_type: inline
---

```{r setup, include = FALSE}

# Set global chunk options

knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.5)

# Load packages

library(plyr) # needed for groupwiseMedian function
library(tidyverse)
library(naniar) # for dealing with missing values
library(labelled) # to remove labels from imported data
library(scales) # for comma and percent formats
library(ggrepel) # for non-overlapping chart annotation
library(Hmisc) # for weighted quartiles
library(boot) # needed for groupwiseMedian function
library(readxl)

# Load functions

source("scr/functions.R")

# Load colour scheme and other strings

source("scr/colours.R")
source("scr/strings.R")


# Load datasets

adult_1819 <- readRDS("output/adult_1819.rds")
househol_1819 <- readRDS("output/househol_1819.rds")
benefits_1819 <- readRDS("output/benefits_1819.rds")
hbai1819 <- readRDS("output/hbai1819.rds")
person18 <- readRDS("output/person18.rds")
hhold18 <- readRDS("output/hhold18.rds")


# Create tidy datasets

source("scr/prepSHSdata.R")
source("scr/prepHBAIdata.R")


# Combine all data

source("scr/prepdata.R")

```

Documents:

* [PID (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A27886326/details)
* [Project plan (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A28035002/details)

# Earnings 

## Summary stats

Median, mean and aggregated earnings (including all households, whether or not they have any earnings).

```{r median_earnings}

tidydata %>%
  filter(type == "earn") %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr")

```

Median, mean and aggregated earnings (excluding households with no earnings).

```{r median_earnings2}

tidydata %>%
  filter(type == "earn",
         amount > 0) %>%
  group_by(survey) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            total = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         total = comma(total, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrr")

```

## by income decile

```{r earnings_deciles}

# Earnings by hhld income decile

# Note that HBAI bootstrap mechanism is SRS!

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI",
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "decile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS",
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         decile = factor(decile)) %>%
  filter(!is.na(Median))

ggplot(data = earn_CI) +
  geom_point(aes(x = decile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = decile,
                   xend = decile,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings by household income decile',
         subtitle = 'Excludes hhlds with no earnings income') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(100, 1200))

```

<div class = "box">

- Median earnings are higher in the SHS compared to the HBAI
- however, for lower income deciles, SHS earnings are slightly lower
- across income deciles, median earnings match fairly well
- There is more earnings variation in the top decile and the lowest four deciles, and less in 5th to 9th decile.
- In the 3rd decile (this is where the poverty thresholds sits), median earnings C.I.s don't overlap between the two surveys

</div>

## by economic status


Median, mean and aggregated earnings by economic status of household head (excludes those with zero earnings).

```{r earnings_exc}


tidydata %>%
  filter(type == "earn",
         HIHemp %in% empstatnames[1:3],
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  arrange(HIHemp) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrrrr")

```

Median, mean and aggregated earnings by economic status of household head (includes those with zero earnings).

```{r earnings_inc}


tidydata %>%
  filter(type == "earn",
         HIHemp %in% empstatnames[1:3]) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*equ*hhwgt),
            households = sum(hhwgt)) %>%
  arrange(HIHemp) %>%
  mutate(median =  comma(median, prefix = "£", accuracy = 1),
         mean = comma(mean, prefix = "£", accuracy = 1),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " million"),
         households = comma(households, accuracy = 10000)) %>%
  knitr::kable(align = "lrrrrrr")

```

```{r earnings_ci}

# Note that HBAI bootstrap mechanism is SRS!

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI", 
                              HIHemp %in% empstatnames[1:3]) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS", 
                              HIHemp %in% empstatnames[1:3]) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

earn_CI$HIHemp = factor(earn_CI$HIHemp, levels = empstatnames)

ggplot(data = earn_CI) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings',
         subtitle = "Includes households with zero earnings") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 700)) 


```


<div class = "box">

- Median and mean earnings in the SHS are higher than in the HBAI; however, aggregated earnings are lower, indicating fewer households with earnings in the SHS compared to the HBAI.
- Employed earnings match fairly well, but self-employed earnings do not. (Note that I redid this analysis using the yet unpublished SHS 2019 dataset - this showed this same trend)
- Self-employed earnings are a source of the earnings differences, but not the only source (as only few people have self-employed earnings)

</div>


# Benefit income

- Look at this by geographic area - this hadn't been done previously

## Benefit income by household type

```{r benefits_hhtype, include = FALSE}

tidydata %>%
  filter(type == "ben", 
         amount > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            people = sum(ppwgt),
            sample = n()) %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn")) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(hhtype, survey) %>%
  knitr::kable(align = "llrrrrr")


```

```{r bens_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

ben_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI", 
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ben_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS", 
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ben_SHS_CI$survey <- "SHS"
ben_HBAI_CI$survey <- "HBAI"

ben_CI <- rbind(ben_HBAI_CI, ben_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

ben_CI$hhtype = factor(ben_CI$hhtype, levels = hhtypenames)

ggplot(data = ben_CI) +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Median household benefit income, SHS 2018 and HBAI 1819',
         subtitle = "Households with zero benefit income excluded") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(0, 500)) 

```

<div class = "box">

- Median benefit income doesn't match well between SHS and HBAI, with some exceptions: Two adults with children, households with aone adults and one pensioner match ok. Generally, SHS benefit income is lower than HBAI benefit income.
- The household type with the largest difference in benefit income is single adults, followed by single adults with children and pensioner couples. Pensioner couples are the only group where C.I. don't overlap.

</div>

## Benefit income by economic status

```{r benefits_eco, include = FALSE}

tidydata %>%
  filter(type == "ben",
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            sum = sum(amount*hhwgt*equ),
            sample = sum(n)) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn")) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(HIHemp, survey) %>%
  knitr::kable(align = "llrrrr")

```

```{r bens_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!

ben_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI", 
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ben_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS", 
                              amount > 0) %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ben_SHS_CI$survey <- "SHS"
ben_HBAI_CI$survey <- "HBAI"

ben_CI <- rbind(ben_HBAI_CI, ben_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

ben_CI$HIHemp = factor(ben_CI$HIHemp, levels = empstatnames)

ggplot(data = ben_CI) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Median household benefit income, SHS 2018 and HBAI 1819',
         subtitle = "Households with zero benefit income excluded") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(0, 500)) 

```

<div class = "box">

- Median benefit incomes for households where the highest income householder is a full-time employee match well and show a small benefit amount and little variation.
- There is more variation and discrepancy in median benefit incomes for part-time employee and seld-employed households.
- Median benefit incomes from SHS and HBAI do not overlap for retired and disabled households, with the SHS benefit incomes consistently below HBAI benefit incomes.

</div>

## Types of benefits

### HBAI

```{r ben_types_frs}

tidybens %>%
  filter(survey == "HBAI") %>%
  group_by(type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ungroup() %>%
  mutate(type = factor(type)) %>%
  arrange(desc(amount)) %>%
  mutate(type = fct_reorder(type, amount),
         share = amount/sum(amount),
         cumshare = cumsum(share),
         total = comma(sum(amount), scale = 1E-6, prefix = "£", suffix = " million", precision = 1),
         amount = comma(amount, 
                        scale = 1E-6, 
                        prefix = "£", 
                        suffix  = " million", 
                        accuracy = 0.1),
         share = percent(share, 0.01),
         cumshare = percent(cumshare, 0.1)) %>%
  knitr::kable(align = "lrrrr")

```

### SHS

```{r ben_types_shs}

# De-equivalise this!!

tidybens %>%
  filter(survey == "SHS") %>%
  group_by(type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ungroup() %>%
  mutate(type = factor(type)) %>%
  arrange(desc(amount)) %>%
  mutate(type = fct_reorder(type, amount),
         share = amount/sum(amount),
         cumshare = cumsum(share),
         total = comma(sum(amount), scale = 1E-6, prefix = "£", suffix = " million", precision = 1),
         amount = comma(amount, 
                        scale = 1E-6, 
                        prefix = "£", 
                        suffix  = " million", 
                        accuracy = 0.1),
         share = percent(share, 0.01),
         cumshare = percent(cumshare, 0.1)) %>%
  knitr::kable(align = "lrrrr")

```


### Comparison SHS vs. HBAI

Total amount of benefit income in £million.

```{r ben_types_comparison}

tidybens_agg %>%
  filter(survey != "Admin") %>%
  mutate(type = factor(type, ordered = TRUE)) %>%
  arrange(desc(amount)) %>%
  mutate(type = fct_reorder(type, amount)) %>%
  spread(survey, amount) %>%
  mutate(diff = HBAI-SHS,
         totdiff = sum(diff, na.rm = TRUE),
         contr = percent(diff/totdiff)) %>%
  arrange(desc(abs(diff/totdiff))) %>%
  mutate_at(vars(HBAI, SHS, diff), comma_format(scale = 1E-6, accuracy = 0.1)) %>%
  select(-totdiff) %>%
  knitr::kable(align = "lrrrr")

```

### Comparison with administrative data

Weekly benefit amounts in million £.

```{r ben_types_comparison_admin, fig.asp = 0.8}

# Chart

tidybens_agg %>%
  filter(type %in% tail(levels(type), 14L)) %>%
  ggplot(aes(x = type, y = amount, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = amount + 8E5,
                label = comma(amount, scale = 1e-6, accuracy = 0.1), colour = survey),
            position =  position_dodge(width = 1),
            hjust = 0) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, prefix = "£", suffix = " million")) +
  labs(x = NULL, y = NULL, title = "Weekly total amount of largest benefits, Scotland") +
  theme(legend.position = "top", 
        legend.title = element_blank()) +
  coord_flip()

# Chart without State Pension

tidybens_agg %>%
  filter(type != "State Pension",
         type %in% tail(levels(type), 14L)) %>%
  ggplot(aes(x = type, y = amount, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = amount + 8E5,
                label = comma(amount, scale = 1e-6, accuracy = 0.1), colour = survey),
            position =  position_dodge(width = 1),
            hjust = 0) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, prefix = "£", suffix = " million")) +
  labs(x = NULL, y = NULL, title = "Weekly total amount of largest benefits (except state pension), Scotland") +
  theme(legend.position = "top", 
        legend.title = element_blank()) +
  coord_flip()

# Table

tidybens_agg %>%
  spread(survey, amount) %>%
  arrange(desc(Admin)) %>%
  mutate(HBAI_capt = ifelse(is.na(HBAI*Admin), NA, percent(HBAI/Admin)),
         SHS_capt = ifelse(is.na(SHS*Admin), NA, percent(SHS/Admin))) %>%
  mutate_at(vars(Admin, HBAI, SHS), comma_format(scale = 1E-6, accuracy = 0.1)) %>%
  select(type, Admin, HBAI, HBAI_capt, SHS, SHS_capt) %>%
  knitr::kable(align = "lrrrrr")

```



## Pension credit

<div class = "box">

- Sample sizes are too small for further breakdowns, but pension credit is subject to both, underreporting of the amount, and non-reporting of receipt for SHS, compared to HBAI.

</div>

## Disability benefits

```{r dis_benefits}

tidybens %>%
  filter(type %in% str_trunc(c("Employment and Support Allowance",
                     "Personal Independence Payment",
                     "Disability Living Allowance",
                     "Attendance Allowance"), 30),
         amount > 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = fct_reorder2(type, survey, desc(n))) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  coord_flip() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Average amount of disability-related benefits per hhld",
       subtitle = "Only hhlds who receive each benefit are included")

tidybens %>%
  filter(type %in% str_trunc(c("Employment and Support Allowance",
                     "Personal Independence Payment",
                     "Disability Living Allowance",
                     "Attendance Allowance"), 30),
         amount > 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  mutate(type = fct_reorder2(type, survey, desc(n))) %>%
  filter(sample >= 100) %>%
  ggplot(aes(x = type, y = n, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  coord_flip() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of people in households receiving disability-related benefits",
       subtitle = "Sample >= 100")


```


<div class = "box">

- Disability benefit is subject to both, underreporting of the amount, and non-reporting of receipt for SHS, compared to HBAI

</div>

## Universal credit

<div class = "box">

- Sample sizes are too small for breakdowns, but data (see above) shows that the aggregated Universal Credit amount is vastly underreported in the SHS, compared to HBAI, and even more compared to admin data.

</div>

## Tax credits

```{r tax_credits}

tidybens %>%
  filter(type == "Tax Credits",
         amount >= 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, desc(mean))) %>%
  ggplot(aes(x = HIHemp, y = tot, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Aggregated total amount of tax credits by hhld type",
       subtitle = "Sample >= 50") +
  coord_flip()

tidybens %>%
  filter(type == "Tax Credits",
         amount >= 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, desc(mean))) %>%
  ggplot(aes(x = HIHemp, y = mean, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Average amount of tax credits per hhld",
       subtitle = "Only includes hhlds in receipt of tax credits; sample >= 50") +
  coord_flip()

tidybens %>%
  filter(type == "Tax Credits",
         amount >= 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 100) %>%
  ungroup() %>%
  mutate(HIHemp = fct_reorder2(HIHemp, survey, desc(mean))) %>%
  ggplot(aes(x = HIHemp, y = n, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of people in hhlds receiving tax credits",
       subtitle = "Sample >= 100") +
  coord_flip()

```

<div class = "box">

- Tax credits are also underreported in the SHS compared to the HBAI. This affects mainly part-time employees, although it is, on average, only a small payment.

</div>


## Housing Benefit

```{r housing_benefit}

tidybens %>%
  filter(type == "Housing Benefit",
         amount >= 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  ggplot(aes(x = survey, y = tot, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Aggregated total amount of housing benefit by hhld type",
       subtitle = "Sample >= 50") +
  coord_flip()

tidybens %>%
  filter(type == "Housing Benefit",
         amount >= 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  ggplot(aes(x = survey, y = mean, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Average amount of housing benefit per hhld",
       subtitle = "Only includes hhlds in receipt of housing benefit; sample >= 50") +
  coord_flip()

tidybens %>%
  filter(type == "Housing Benefit",
         amount >= 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 100) %>%
  ungroup() %>%
  ggplot(aes(x = survey, y = n, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of people in hhlds receiving housing benefit",
       subtitle = "Sample >= 100") +
  coord_flip()

```

## Single adult benefit income

```{r single_adult_bens}

tidybens %>%
  filter(hhtype == "Single adult",
         amount > 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  arrange(survey) %>%
  ggplot(aes(x = survey, y = tot, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Aggregated amount of benefits for single adult households") +
  coord_flip()

tidybens %>%
  filter(hhtype == "Single adult",
         amount > 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  ungroup() %>%
  arrange(survey) %>%
  ggplot(aes(x = survey, y = n, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of single adult households receiving (any) benefits") +
  coord_flip()

tidybens %>%
  filter(hhtype == "Single adult",
         amount > 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  arrange(type, survey) %>%
  mutate(keep = ifelse(type == lag(type), 1, 0),
         keep = ifelse(lead(keep) == 1, 1, keep)) %>%
  filter(keep == 1) %>%
  ggplot(aes(x = type, y = tot, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Aggregated amount of benefits for single adult households",
       subtitle = "Sample >= 50") +
  coord_flip()

tidybens %>%
  filter(hhtype == "Single adult",
         amount > 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 50) %>%
  ungroup() %>%
  arrange(type, survey) %>%
  mutate(keep = ifelse(type == lag(type), 1, 0),
         keep = ifelse(lead(keep) == 1, 1, keep)) %>%
  filter(keep == 1) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Mean benefit amount for single adult households",
       subtitle = "Sample >= 50") +
  coord_flip()

tidybens %>%
  filter(hhtype == "Single adult",
         amount > 0) %>%
  group_by(survey, type) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ppwgt),
            sample = n()) %>%
  filter(sample >= 100) %>%
  ungroup() %>%
  arrange(type, survey) %>%
  mutate(keep = ifelse(type == lag(type), 1, 0),
         keep = ifelse(lead(keep) == 1, 1, keep)) %>%
  filter(keep == 1) %>%
  ggplot(aes(x = type, y = n, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of single adult households receiving benefits",
       subtitle = "Sample >= 100") +
  coord_flip()

```

<div class = "box">

- Many more single adult households in the SHS than the HBAI report (any) benefit income, and therefore aggregated benefit income for single adult households is higher in the SHS compared to the HBAI. But the average amount (all benefits added up) is smaller in the SHS. This might be because people underestimate their benefit amounts, or they miss out some benefits.

</div>


# Investment income

```{r investment}

tidydata %>%
  filter(type == "inv",
         amount > 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  mutate(tot = comma(tot, scale = 1E-6, prefix  ="£", suffix = " million"),
         mean = comma(mean, prefix = "£"),
         median = comma(median, prefix = "£"),
         sample = comma(sample),
         people = comma(people)) %>%
  knitr::kable(align = "lrrrrr")

tidydata %>%
  filter(type == "inv",
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip()

tidydata %>%
  filter(type == "inv",
         amount > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         hhtype = fct_reorder(hhtype, share)) %>%
  ggplot(aes(x = hhtype, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across household types") +
  coord_flip()

tidydata %>%
  filter(type == "inv",
         amount > 0) %>%
  group_by(survey, decile) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         decile = factor(decile)) %>%
  ggplot(aes(x = decile, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated investment income across income deciles") +
  coord_flip()

```

<div class = "box">

- Investment income is hugely underreported in the SHS compared to the HBAI, even though we are using the HBAI data before top-income adjustments (which would correct top incomes upwards). 
- most of investment income is held by retired households, and by Two adult households, therefore the underreporting in the SHS might affect the incomes of these groups more.
- similarly, most of investment income is held by the richest households

</div>


# Total income - FRS and SHS

We expect average total income to be matching the FRS well, even if the individual income components might not match well enough for detailed analysis (due to imputation of a lot of missing data). 

- look at distributions, median, quartiles etc
- geographical analysis - is total income good enough in each region? Look at median income by region
- median income by hhld type, urban/rural, economic status, age group, income decile
- does income match better for those charatceristics that were used for the missing income imputation?

## Income distribution

```{r income_distributions}

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = ppwgt, colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  geom_density(size = 1, alpha = 0.5, bw = 0.02) +
  scale_x_log10(limits = c(20, 20000), labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS household income distribution",
       subtitle = "Vertical lines show poverty thresholds and medians",
       x = "Weekly income",
       y = "Number of people") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = ppwgt, colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  coord_cartesian(xlim = c(20, 20000)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "Vertical lines show poverty thresholds and medians",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = ppwgt, colour = survey, fill = survey )) +
  geom_vline(xintercept = HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = SHSmedian, colour = cols_survey[2]) +
  geom_vline(xintercept = 0.6*HBAImedian, colour = cols_survey[1]) +
  geom_vline(xintercept = 0.6*SHSmedian, colour = cols_survey[2]) +
  coord_cartesian(xlim = c(100,1500)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  geom_text(data = tail(tidydata, 1L), 
            aes(x = HBAImedian + 20, y = 1, label = "Medians"), 
            colour = "grey20",
            hjust = 0, 
            show.legend = FALSE) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "Vertical lines show poverty thresholds and medians",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

```


<div class = "box">

- The income distributions look largely similar, with the SHS income distribution being slightly wider.
- Near the relative poverty threshold (£310 in 2016-19), the SHS cumulative income curve is higher, meaning more households sit below that threshold in the SHS compared to the HBAI.

</div>

## Income decile points

```{r income_deciles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, 
                                        probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), 
                                        weights = ppwgt)))) %>%
  unnest(x) %>%
  ggplot(aes(x = name, y = value, fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = 40,
                label = comma(value, accuracy = 1, prefix = "£")),
            colour = 'white',
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  scale_x_discrete(labels = sprintf("%1.0f", seq(1,9))) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Income decile points",
       subtitle = "These are the nine income thresholds that split the population into 10 equal-sized groups")


# tidydata %>%
#   filter(type == "total") %>%
#   group_by(survey) %>% 
#   summarise(x=list(enframe(wtd.quantile(amount, 
#                                         probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), 
#                                         weights = ppwgt)))) %>%
#   unnest(x) %>%
#   mutate(Percentile = name,
#          value = comma(value, 1, prefix = "£")) %>%
#   select(-name) %>%
#   spread(survey, value) %>%
#   knitr::kable()

```

<div class = "box">

- The income decile points are at similar levels for high incomes and diverge towards lower incomes.
- This suggests that it would be advisable to calculate poverty thresholds for each survey separately, based on each survey's data.

</div>

## Median income by council area

```{r median_council, include = FALSE}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

councilinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "council") 

# Table 

mutate(councilinc, 
       sample = ifelse(is.na(HBAI_sample), "too small", 
                         ifelse(HBAI_sample >= 50, "ok", "too small")),
       HBAI_median = ifelse(sample == "ok", comma(HBAI_median, accuracy = 1, prefix = "£"), NA),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£")) %>%
  arrange(council) %>%
  select(council, sample, everything())


# Chart - Median income by council
councilinc$council <- decode(councilinc$council, search = councilnames, replace = councilshort)

councilinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = council, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(400, 700)) +
  scale_y_continuous(limits = c(400, 650)) +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  labs(title = "Median income by council - HBAI vs. SHS")

```


```{r median_council_ci}

# Chart - Median income by council with C.I.
# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

HBAI_CI_all <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "HBAI") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

SHS_CI_all <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "SHS") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

rbind(HBAI_CI_all, SHS_CI_all)


SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         Basic.lower = ifelse(n < 50, NA, Basic.lower),
         Basic.upper = ifelse(n < 50, NA, Basic.upper),
         Percentile.lower = ifelse(n < 50, NA, Percentile.lower),
         Percentile.upper = ifelse(n < 50, NA, Percentile.upper)) %>%
  filter(!is.na(Median))


levels <-  filter(CI, n > 50) %>% 
  select(survey, council, Median) %>%
  spread(survey, Median) %>%
  mutate(diff = abs(HBAI-SHS)) %>%
  arrange(desc(diff)) %>%
  filter(!is.na(diff)) %>%
  mutate(council = factor(council, levels = as.character(council), ordered = TRUE)) %>%
  arrange(council)

CI$council <- factor(CI$council, levels(levels$council))


ggplot(data = filter(CI, !is.na(council))) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = council, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(data = filter(CI, survey == "HBAI", !is.na(council)),
            mapping = aes(x = council, y = 780, label =  n),
            hjust = 1,
            colour = cols_survey[1],
            show.legend = FALSE) +
  geom_text(data = filter(CI, survey == "SHS", !is.na(council)),
            mapping = aes(x = council, y = 810, label =  n),
            hjust = 1,
            colour = cols_survey[2],
            show.legend = FALSE) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 2018/19',
         subtitle = 'Sorted by income difference; sample sizes shown on right') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 
  
```


<div class = "box">

- Using 95% confidence intervals (C.I.), median incomes overlap (to some degree) for all council areas where the HBAI sample size is large enough to estimate the median (sample >=50, true for 22 out of the 32 council areas).
- For the HBAI, the C.I. are calculated using a bootstrapping method which resamples the dataset without accounting for the complex survey design. The HBAI C.I. are therefore only illustrative and may be wider.
- For some council areas, the overlaps are only marginal, such as Glasgow, Renfrewshire, Aberdeenshire, East Dunbartonshire, and Stirling, even though some of these have relatively large HBAI sample sizes (Aberdeenshire, Glasgow, Renfrewshire).
- It would be good to check what the overlaps look like for different data years, i.e. SHS 2019 (pre-release access only) or HBAI 2017/18.

</div>

## Median income by urban/rural area

```{r median_urbrur, include = FALSE}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

urbrurinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "urbrur") 

# Table - Median income by urban/rural class

mutate(urbrurinc, 
       HBAI_median = comma(HBAI_median, accuracy = 1, prefix = "£"),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       urbrurclass = urbrurclasses) %>%
  arrange(urbrur) %>%
  select(urbrurclass, HBAI_median, SHS_median, HBAI_sample, SHS_sample) %>%
  knitr::kable(align = "lrrrr")

```


```{r median_urbrur_ci}

# Note that HBAI bootstrap mechanism is SRS!

UR_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

UR_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

UR_SHS_CI$survey <- "SHS"
UR_HBAI_CI$survey <- "HBAI"

UR_CI <- rbind(UR_HBAI_CI, UR_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

UR_CI$urbrur <- decode(UR_CI$urbrur, search = urbrurcodes, replace = urbrurclasses)
UR_CI$urbrur <- factor(UR_CI$urbrur, levels = urbrurclasses)

ggplot(data = UR_CI, aes(x = fct_rev(urbrur), y = Median)) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(colour = survey), size = 2) +
  geom_segment(aes(xend = urbrur,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(aes(y = ifelse(survey == "HBAI", 700, 750), 
                label = comma(Median, accuracy = 1, prefix = "£"),
                colour = survey),
            hjust = 1,
            show.legend = FALSE) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819',
         subtitle = 'Median values shown on right') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- Incomes overlap fairly well for urban and accessible rural areas.
- Incomes in remote rural areas overlap slightly less, but also have the smalles HBAI sample.
- Income in small towns overlaps the least.

</div>

## Median income by age group 

- child, working-age, pensioners
- also: age group of HIH??

```{r median_agegroup, include = FALSE}

# Table - Median income by age group

filter(tidydata, type == "total") %>%
  group_by(survey) %>%
  summarise(People = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            Children = wtd.quantile(amount, probs = 0.5, weights = chwgt),
            WorkingAgeAdults = wtd.quantile(amount, probs = 0.5, weights = wawgt),
            Pensioners = wtd.quantile(amount, probs = 0.5, weights = pnwgt)) %>%
  mutate(People = comma(People, accuracy = 1, prefix  ="£"),
         Children = comma(Children, accuracy = 1, prefix  ="£"),
         WorkingAgeAdults = comma(WorkingAgeAdults, accuracy = 1, prefix  ="£"),
         Pensioners = comma(Pensioners, accuracy = 1, prefix  ="£")) %>%
  knitr::kable(align = "lrrrr")

```

```{r median_agegroup_ci}

# Note that HBAI bootstrap mechanism is SRS!

ch_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ch_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                mutate(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                mutate(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                mutate(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ch_HBAI_CI$group <- "Children"
wa_HBAI_CI$group <- "WorkingAgeAdults"
pn_HBAI_CI$group <- "Pensioners"

ch_SHS_CI$group <- "Children"
wa_SHS_CI$group <- "WorkingAgeAdults"
pn_SHS_CI$group <- "Pensioners"

Age_HBAI_CI <- rbind(ch_HBAI_CI, wa_HBAI_CI, pn_HBAI_CI) %>%
  mutate(survey = "HBAI")

Age_SHS_CI <- rbind(ch_SHS_CI, wa_SHS_CI, pn_SHS_CI) %>%
  mutate(survey = "SHS")

Age_CI <- rbind(Age_HBAI_CI, Age_SHS_CI) %>%
  select(survey, group, Median, Normal.lower, Normal.upper, n) %>%
  mutate(group = factor(group, levels = agegrouplevels),
         group = fct_rev(group))

ggplot(data = Age_CI) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = group, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = group,
                   xend = group,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  geom_text(aes(x = group, 
                y = ifelse(survey == "HBAI", 700, 740), 
                colour = survey, 
                label = comma(Median, prefix = "£", accuracy = 1)),
            show.legend = FALSE,
            hjust = 1) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- Working-age adults' and children's incomes overlap well.
- Pensioners' incomes don't overlap.

</div>

## Median income by household type

```{r median_hhtype, include = FALSE}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, hhtype) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

hhtypeinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "hhtype") 

# Table - Median income by hhtype

mutate(hhtypeinc, 
       HBAI_median = comma(HBAI_median, accuracy = 1, prefix = "£"),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       hhtype = factor(hhtype, levels = hhtypenames)) %>%
  arrange(hhtype)

```


```{r median_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

hhtype_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

hhtype_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

hhtype_SHS_CI$survey <- "SHS"
hhtype_HBAI_CI$survey <- "HBAI"

hhtype_CI <- rbind(hhtype_HBAI_CI, hhtype_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

hhtype_CI$hhtype <- factor(hhtype_CI$hhtype, levels = hhtypenames)

ggplot(data = hhtype_CI) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box" >

- Incomes for most hhld types overlap well, except pensioners
- Single pensioner and pensioner couples' income don't overlap, with SHS pensioners' incomes lower than in the HBAI.
- Incomes of households with 3 or more adults and no children overlap little, but have very wide C.I., indicating large variation of incomes in this group.

</div>

## Median income by economic status of highest income householder

```{r median_eco, include = FALSE}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, HIHemp) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

HIHempinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = ppwgt)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "HIHemp") %>%
  mutate(HBAI_median = ifelse(HBAI_sample < 50, NA, HBAI_median))

# Table - Median income by HIHemp

mutate(HIHempinc, 
       HBAI_median = ifelse(is.na(HBAI_median), NA, comma(HBAI_median, accuracy = 1, prefix = "£")),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       HIHemp = factor(HIHemp, levels = empstatnames)) %>%
  arrange(HIHemp)


```


```{r median_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!

HIHemp_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, type == "total", survey == "HBAI") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

HIHemp_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, type == "total", survey == "SHS") %>%
                  mutate(weight = ppwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

HIHemp_SHS_CI$survey <- "SHS"
HIHemp_HBAI_CI$survey <- "HBAI"

HIHemp_CI <- rbind(HIHemp_HBAI_CI, HIHemp_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

HIHemp_CI$HIHemp <- factor(HIHemp_CI$HIHemp, levels = empstatnames)

ggplot(data = HIHemp_CI) +
  geom_hline(yintercept = HBAImedian, colour = cols_survey[1], alpha = 0.2, size = 1.5) +
  geom_hline(yintercept = SHSmedian, colour = cols_survey[2], alpha = 0.2, size = 1.5) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 800)) 

```

<div class = "box">

- incomes of full- and part-time employees match well, suggesting that income from employed earnings may also match well.
- self-employed income varies widely and overlaps only little between the two surveys.
- The HBAI unemployed sample is too small to produce estimates.
- Incomes of the retired don't match well, similarly to pensioners' incomes in the household type breakdown.
- Incomes of the disabled also doesn't match too well.

</div>

# Income components

In SHS and FRS, which income sources contribute how much to total income? 


```{r components}

# Make chart showing total income amount and components
# de-equivalise

tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ggplot(aes(x = type,
           y = amount,
           fill = survey)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = amount + 70000000,
                label = comma(amount, scale = 1E-6),
                colour = survey),
            show.legend = FALSE,
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(scale = 1E-9, 
                                          prefix = "£", 
                                          suffix = " billion", 
                                          accuracy = 0.1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Aggregated weekly income by income type", x = NULL, y = NULL)

```

Which income components contribute most to the differences?

```{r aggregate_components}

# Make table showing differences in income and income compononents

tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  spread(survey, amount) %>%
  mutate(totdiff = HBAI[1] - SHS[1],
         diff = HBAI - SHS,
         reldiff = diff/HBAI,
         diffcontr = diff/totdiff) %>%
  arrange(desc(abs(diffcontr))) %>%
  mutate(HBAI = comma(HBAI, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         SHS = comma(SHS, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         absdiff = comma(diff, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         diffcontr = percent(diffcontr),
         reldiff = percent(reldiff)) %>%
  select(type, HBAI, SHS, absdiff, diffcontr) %>%
  knitr::kable(align = "lrrrr")

incdiff <- tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  spread(survey, amount) %>%
  head(1L) %>%
  mutate(diff = percent(1- SHS/HBAI, accuracy = 0.1)) %>%
  select(diff) %>% 
  pull()

```

<div class = "box">

- Total income aggregated to the  whole of Scotland is largely made up of earnings, followed by benefits (which include the state pension) and occupational pensions. Overall, SHS total income is `r incdiff` lower than HBAI total income. The differences come mainly from lower benefit and much lower investment income in the SHS, and then also from lower occupational pensions. Income from earnings are higher in the SHS. Other income components are relatively small and therefore contribute little to the overall differences in income.
- Do investment incomes matter for poverty (= low income) measurement though?

</div>

```{r aggr_comp_quintiles}

# Make chart showing total income amount and components

tidydata %>%
  group_by(survey, type, quintile) %>%
  summarise(aggr = sum(hhwgt*amount*equ)) %>%
  ungroup() %>%
  arrange(quintile, type) %>%
  mutate(diff = ifelse(survey == "SHS", lag(aggr)-aggr, 0)) %>%
  filter(survey == "SHS") %>%
  select(type, diff, quintile) %>%
  ggplot(aes(x = type,
           y = diff)) +
  geom_col(position = 'dodge') +
  scale_y_continuous(label = comma_format(scale = 1E-6, prefix = "£", suffix = " mn", accuracy = 1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Difference in aggregated weekly income by income type and income quintile",
       subtitle = "Positive values = HBAI income is larger", x = NULL, y = NULL) +
  facet_wrap(vars(quintile))

```


<div class = "box">

- For all quintiles, the aggregated total income is higher in the HBAI compared to SHS, with the absolute difference increasing with higher incomes. Note that we showed earlier that this was similar for _median_ incomes, but that the differences *decreased* with higher incomes.
- For the lowest income quintile, aggregated earnings incomes reported in the SHS are higher than in the HBAI. Benefits are considerably lower though and largely explain why total SHS income is lower than HBAI income in this quintile.
- In the second income quintile (this is where the poverty threshold sits), the higher HBAI earnings income largely explains the differences in total aggregated incomes in this quintile.
- In the third and fourth income quintiles, SHS earnings are again higher than HBAI earnings. However, differences in benefit, occupational pension, and inverstment incomes lead to a lower total income in the SHS in these quintiles.
- In the top quintile, total income differences are due to differences in incomes from all major sources, but in particular occupational pensions and income from investments.

</div>

```{r component_shares_decile}

# Make table showing differences in income and income compononents

tidydata %>%
  filter(type != "total") %>%
  group_by(survey, decile, type) %>%
  summarise(amount = sum(amount*hhwgt*equ)) %>%
  ungroup() %>%
  mutate(decile = factor(decile)) %>%
  group_by(survey, decile) %>%
  ggplot(aes(x = decile, y = amount, fill = type)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = cols_types) +
  labs(x  = "Total income decile", y = NULL,
       title = "Share of aggregated total income by type of income and decile") +
  facet_wrap(~survey, nrow = 2) +
  theme(legend.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

```



<div class = "box">

- The lower the total income is, the less important earnings and the more important benefits become.

</div>


# Pensioners' incomes

```{r pensioners_sources}

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(ifelse(amount != 0, amount, NA), weights = hhwgt, na.rm = TRUE),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            n = sum(ifelse(amount != 0, ppwgt, 0)),
            sample = n()) %>% 
  filter(sample >= 50) %>%
  ggplot(aes(x = type, y = tot, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  facet_wrap(vars(hhtype), scales = "free") +
  labs(x = NULL, y = NULL, 
       title = "Aggregated income and income sources for pensioner households",
       subtitle = "Note different y-scales") +
  theme(legend.title = element_blank(),
        legend.position = "top")

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(ifelse(amount != 0, amount, NA), weights = hhwgt, na.rm = TRUE),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            n = sum(ifelse(amount != 0, ppwgt, 0)),
            sample = n()) %>% 
  filter(sample >=50) %>%
  ggplot(aes(x = type, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL, 
       title = "Mean income and income sources for pensioner households",
       subtitle = "Each bar only includes hhlds who have that type of income; sample >= 50") +
  theme(legend.title = element_blank(),
        legend.position = "top")

tidydata %>%
  filter(hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, type, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(ifelse(amount != 0, amount, NA), weights = hhwgt, na.rm = TRUE),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            n = sum(ifelse(amount != 0, ppwgt, 0)),
            sample = n()) %>% 
  filter(sample >= 100) %>%
  ggplot(aes(x = type, y = n, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  facet_wrap(vars(hhtype)) +
  labs(x = NULL, y = NULL, 
       title = "Numbers of people receiving income and income sources for pensioner households",
       subtitle = "Sample >= 100") +
  theme(legend.title = element_blank(),
        legend.position = "top")
```


<div class="box">

- aggregated income for One pensioner, one adult matches better between SHS and HBAI than aggregated income for Single pensioners and Pensioner Couples. This is because this group's income comes largely from earnings and much less from benefits. Earnings are higher in the SHS, whereas the other main income types (mainly benefits) are much lower.
- the differences in income come mainly from benefit income (state pension?), occupational pensions and investment income. 
- the difference in investment income is caused by much fewer people reporting any investment income in the SHS compared to the HBAI.

</div>

```{r state_pension}

# State pension caseload and amount by hhtype

tidybens %>%
  filter(type == "State Pension",
         amount > 0,
         hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ifelse(amount != 0, ppwgt, 0))) %>%
  ggplot(aes(x = hhtype, y = mean, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL, 
       title = "Mean state pension (of those who receive any) by hhtype",
       subtitle = "Includes pensioner hhlds only")

tidybens %>%
  filter(type == "State Pension",
        hhtype %in% c("Single pensioner", "Two pensioners", "One adult, one pensioner")) %>%
  group_by(survey, hhtype) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            mean = wtd.mean(amount, weights = hhwgt),
            n = sum(ifelse(amount != 0, ppwgt, 0))) %>%
  ggplot(aes(x = hhtype, y = n, fill = survey)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL, 
       title = "Number of people in hhlds receiving state pension by hhtype",
       subtitle = "Includes pensioner hhlds only")

```

<div class = "box">

- The average amount of state pension received matches well between HBAI and SHS
- However, the SHS reports fewer recipients of state pension

</div>

Occupational pensions

```{r occ_pension}

tidydata %>%
  filter(type == "occ",
         amount > 0) %>%
  group_by(survey) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  mutate(tot = comma(tot, scale = 1E-6, prefix  ="£", suffix = " million"),
         mean = comma(mean, prefix = "£"),
         median = comma(median, prefix = "£"),
         sample = comma(sample),
         people = comma(people)) %>%
  knitr::kable(align = "lrrrrr")

tidydata %>%
  filter(type == "occ",
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(tot = sum(amount*hhwgt*equ),
            mean = wtd.mean(amount, weights = hhwgt),
            median = wtd.quantile(amount, probs = 0.5, weights = ppwgt),
            sample = n(),
            people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(share = tot/sum(tot),
         HIHemp = fct_reorder(HIHemp, share)) %>%
  ggplot(aes(x = HIHemp, y = share, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Share of aggregated occupational pensions income across household types") +
  coord_flip()

```

<div class = "box">

- the SHS only slightly underreports income from occupational pensions compared to the HBAI.
- the underreporting is due to non-reporting
- most of occ pension income goes to retired people

</div>

# Self-employed's incomes

- higher earnings in SHS -> due to variation? Check SHS19
- leads to higher incomes
- benefits??
- other income sources? what about deductions?