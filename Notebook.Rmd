---
title: "SHS income project"
output: 
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup}

# Load packages

library(plyr) # needed for groupwiseMedian function
library(tidyverse)
library(naniar) # for dealing with missing values
library(haven) # for SAS importing
library(labelled) # to remove labels from imported data
library(scales) # for comma and percent formats
library(ggrepel) # for non-overlapping chart annotation
library(Hmisc) # for weighted quartiles
library(boot) # needed for groupwiseMedian function

# Load functions

source("functions.R")

# Load datasets

adult_1819 <- read_sas("../Full SAS Datasets/adult_1819.sas7bdat")
househol_1819 <- read_sas("../Full SAS Datasets/househol_1819.sas7bdat")
hbai1819 <- read_sas("../Full SAS Datasets/hbai1819.sas7bdat")
person18 <- read_sas("../Full SAS Datasets/person18.sas7bdat")
hhold18 <- read_sas("../Full SAS Datasets/hhold18.sas7bdat")

```


# Introduction

The general idea is to look at income first. Identify the areas of income measurement with the biggest discrepancies, dig deep, until the differences can be explained. Once the differences are understood, identify households in poverty and see if they show the same characteristics as those identified in the HBAI.

Documents:

* [PID (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A27886326/details)
* [Project plan (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A28035002/details)


# Total income - FRS and SHS

We expect average total income to be matching the FRS well, even if the individual income components might not match well enough for detailed analysis (due to imputation of a lot of missing data). 

- look at distributions, median, quartiles etc
- geographical analysis - is total income good enough in each region? Look at median income by region
- median income by hhld type, urban/rural, economic status, age group, income decile
- does income match better for those charatceristics that were used for the missing income imputation?

```{r make_tidy_data}

# Create tidy SHS dataset

# Equivalise: 
# get number of children under 14 from person dataset; 
# get number of adults and children over 14

# Age group weights:
# get number of dependent children; working-age adults; pensioners per hhld

personshs <- person18 %>%
  # Remove permanently absent hhld members
  select(UNIQID, HA5, HA7, HA10, HA13, HA31:HA310, PENAGE) %>%
  filter(is.na(HA10)|HA10 != 1,
         is.na(HA13)|HA13 != 1) %>%
  mutate(u14 = ifelse(HA5 < 14, 1, 0),
         o64 = ifelse(HA5 >= 65, 1, 0),
         pp = 1,
         kid = ifelse(HA31 %in% c(4, 5) |
                        HA32 %in% c(4, 5) |
                        HA33 %in% c(4, 5) |
                        HA34 %in% c(4, 5) |
                        HA35 %in% c(4, 5) |
                        HA36 %in% c(4, 5) |
                        HA37 %in% c(4, 5) |
                        HA38 %in% c(4, 5) |
                        HA39 %in% c(4, 5) |
                        HA310 %in% c(4, 5) , 1, 0),
         depchld = ifelse(HA5 <= 16, 1, 0),
         p1719 = ifelse(HA5 <= 19 & HA5 >= 17, 1, 0),
         inedu = ifelse(HA7 %in% c(7, 8), 1, 0),
         athome = ifelse(HA10 != 1 & !is.na(HA10), 1, 0),
         depchld = ifelse(kid == 1 & p1719 == 1 & inedu == 1 & athome == 1, 1, depchld)) %>%
  group_by(UNIQID) %>%
  summarise(u14 = sum(u14),
            pp = sum(pp),
            ch = sum(depchld),
            o64 = sum(o64),
            pn = ifelse(is.na(sum(PENAGE)), o64, sum(PENAGE)),
            wa = pp - ch - pn)


# Note there is one hhld with one dependent child and no (present) adults
# check <- filter(personshs, wa == 0 & pn == 0)

tidyshs <- hhold18 %>%
  select(UNIQID, MSCINC01:MSCINC10, EARNINC, BENINC, LA_GRWT, COUNCIL, SHS_6CLA, HIHECON) %>%
  left_join(personshs, by = "UNIQID") %>%
  replace_na(list(MSCINC01 = 0, MSCINC02 = 0, MSCINC03 = 0, MSCINC04 = 0, MSCINC05 = 0, 
                  MSCINC06 = 0, MSCINC07 = 0,  MSCINC08 = 0, MSCINC09 = 0, MSCINC10 = 0,
                  EARNINC = 0, BENINC= 0)) %>%
  mutate(equ = 0.67 + (pp-u14-1)*0.33 + u14*0.2,
         earn = EARNINC*7/(365*equ),
         ben = BENINC*7/365,
         privben = (MSCINC02 + MSCINC06)*7/(365*equ),
         occ = MSCINC01*7/(365*equ),
         inv = MSCINC07*7/(365*equ),
         oth = (MSCINC03 + MSCINC04 + MSCINC05 + MSCINC08 + MSCINC09 + MSCINC10)*7/(365*equ),
         total = (earn + ben + privben + occ + inv + oth),
         weight = round(LA_GRWT*pp),
         chwgt = round(LA_GRWT*ch),
         wawgt = round(LA_GRWT*wa),
         pnwgt = round(LA_GRWT*pn),
         council = COUNCIL,
         urbrur = SHS_6CLA,
         HIHemp = HIHECON,
         hhtype = ifelse(pp == 1 & wa == 1, 1, 
                         ifelse(pp == 2 & wa == 2, 2, 
                                ifelse(pp >= 3 & wa == pp & pn == 0, 3, 
                                       ifelse(ch >= 1 & wa == 1 & pn == 0, 4, 
                                              ifelse(ch >= 1 & wa == 2 & pn == 0, 5, 
                                                     ifelse(pp == 1 & pn == 1, 6, 
                                                            ifelse(pp == 2 & pn == 2, 7, 
                                                                   ifelse(pp == 2 & wa == 1 & pn == 1, 8, 9)))))))),
         ID = row_number()) %>%
  select(ID, weight, chwgt, wawgt, pnwgt, 
         total, earn, ben, privben, occ, inv, oth, equ,
         council, urbrur, hhtype, HIHemp, pp, ch, wa, pn) %>%
  remove_labels() %>%
  gather(key = type, value = amount, -ID, -weight, -chwgt, -wawgt, -pnwgt, 
         -council, -urbrur, -hhtype, -HIHemp, -pp, -ch, -wa, -pn, -equ) %>%
  mutate(survey = "SHS")

tidyshs$council <- decode(tidyshs$council,
                          search = SHScodes, 
                          replace = councilnames,  
                          default = "unknown")

tidyshs$hhtype <- decode(tidyshs$hhtype,
                          search = hhtypecodes, 
                          replace = hhtypenames,
                          default = "unknown")

tidyshs$HIHemp <- decode(tidyshs$HIHemp,
                          search = SHS_HIHECONcodes, 
                          replace = SHS_HIHECONrecode,
                          default = 7)

# Create tidy HBAI dataset

# Get Highest Income Householder (= Household Reference Person)
# from person dataset

tidyadult <- adult_1819 %>%
  filter(HRPID == 1) %>%
  select(SERNUM, EMPSTATI) %>%
  rename(HIHemp = EMPSTATI)

# Get council and urban/rural class from househol dataset

tidyhousehol <- househol_1819 %>%
  filter(COUNTRY == 3) %>%
  mutate(council = LAC,
         urbrur = URINDS) %>%
  select(SERNUM, council, urbrur)


# Recode to 6-tier classification

tidyhousehol$urbrur <- decode(tidyhousehol$urbrur,
                              search = c(1, 2, 3, 4, 5, 6, 7, 8),
                              replace = c(1, 2, 3, 4, 4, 5, 6, 6))

# Get person, child, wa and pensioner weights

HBAIweights <- hbai1819 %>%
  filter(GVTREGN == 12) %>%
  select(SERNUM, gs_newpp, gs_newch, gs_newwa, gs_newpn) %>%
  group_by(SERNUM) %>%
  summarise(weight = sum(gs_newpp),
            chwgt = sum(gs_newch),
            wawgt = sum(gs_newwa),
            pnwgt = sum(gs_newpn))

tidyhbai <- hbai1819 %>%
  filter(GVTREGN == 12,
         BENUNIT == 1) %>%
  left_join(HBAIweights, by = "SERNUM") %>%
  left_join(tidyadult, by = "SERNUM") %>%
  mutate(equ = eqobhchh,
         earn = enternhh/equ,
         ben = ebeninhh/equ,
         privben = epribnhh/equ,
         occ = hntocchh/equ,
         inv = hntinvhh/equ,
         oth =  emiscihh/equ,
         total = (earn + ben + privben + occ + inv + oth),
         pp = ADULTH + DEPCHLDH,
         ch = DEPCHLDH,
         wa = round(pp*wawgt/weight),
         pn = round(pp*pnwgt/weight),
         hhtype = ifelse(pp == 1 & wa == 1, 1, 
                         ifelse(pp == 2 & wa == 2, 2, 
                                ifelse(pp >= 3 & wa == pp & pn == 0, 3, 
                                       ifelse(ch >= 1 & wa == 1 & pn == 0, 4, 
                                              ifelse(ch >= 1 & wa == 2 & pn == 0, 5, 
                                                     ifelse(pp == 1 & pn == 1, 6, 
                                                            ifelse(pp == 2 & pn == 2, 7, 
                                                                   ifelse(pp == 2 & wa == 1 & pn == 1, 8, 9)))))))),
         ID = row_number()) %>%
  select(ID, weight, chwgt, wawgt, pnwgt, hhtype, HIHemp, pp, ch, wa, pn, 
         total, earn, ben, privben, occ, inv, oth, equ, SERNUM) %>%
  left_join(tidyhousehol, by = "SERNUM") %>%
  gather(key = type, value = amount, -ID, -SERNUM, -weight, -chwgt, -wawgt, -pnwgt, -pp, -ch, -wa, -pn, -council, -urbrur, -hhtype, - HIHemp, -equ) %>%
  mutate(survey = "HBAI") %>%
  select(-SERNUM) %>%
  remove_labels() 

tidyhbai$council <- decode(tidyhbai$council, 
                           search = FRScodes, 
                           replace = councilnames, 
                           default = "unknown")

tidyhbai$hhtype <- decode(tidyhbai$hhtype,
                          search = hhtypecodes, 
                          replace = hhtypenames,
                          default = "unknown")

tidyhbai$HIHemp <- decode(tidyhbai$HIHemp,
                          search = FRS_empstatcodes, 
                          replace = FRS_empstatrecode,
                          default = "unknown")

# Combine datasets to a hhld level dataset with different income components (using hhld weight)

tidydata <- rbind(tidyhbai, tidyshs) %>%
  mutate(survey = factor(survey, ordered = TRUE),
         n = 1)

tidydata$HIHemp <- decode(tidydata$HIHemp,
                          search = empstatcodes, 
                          replace = empstatnames,
                          default = "unknown")

tidydata$type <- factor(tidydata$type, levels = inctypes)


# Get decile points

 decilepoints <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), weights = weight)))) %>%
  unnest(x) %>%
  mutate(name = str_c("dec", str_sub(name, 1L, 2L))) %>%
  spread(name, value)

deciles <- tidydata %>%
  filter(type == "total") %>%
  select(ID, survey, amount) %>%
  left_join(decilepoints, by = "survey") %>%
  mutate(decile = ifelse(amount < dec10, 1,
                         ifelse(amount < dec20, 2,
                                ifelse(amount < dec30, 3,
                                       ifelse(amount < dec40, 4,
                                              ifelse(amount < dec50, 5, 
                                                     ifelse(amount < dec60, 6,
                                                            ifelse(amount < dec70, 7,
                                                                   ifelse(amount < dec80, 8,
                                                                          ifelse(amount < dec90, 9, 10)))))))))) %>%
  select(ID, survey, decile)

tidydata <- tidydata %>%
  left_join(deciles, by = c("survey", "ID"))

tidydata$quintile <- decode(tidydata$decile,
                            search = c(seq(1,10)),
                            replace = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5),
                            default = NA)

# Check for missing data

# View(miss_var_summary(tidyhbai))
# View(miss_var_summary(tidyshs))
# View(miss_var_summary(tidydata))


```

## Income distribution

```{r income_distributions}

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  geom_density(size = 1, alpha = 0.5, bw = 0.02) +
  scale_x_log10(limits = c(20, 20000), labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Number of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  coord_cartesian(xlim = c(20, 20000)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  coord_cartesian(xlim = c(100,1500)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

```

## Income quartiles and decile points

### Weekly total household income quartiles

```{r income_quartiles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, probs=c(0.25, 0.5, 0.75), weights = weight)))) %>%
  unnest(x) %>%
  mutate(value = comma(value, 1, prefix = "£"),
         Quantile = name) %>%
  select(-name) %>%
  spread(survey, value)

```

### Weekly total household income decile points

```{r income_deciles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), weights = weight)))) %>%
  unnest(x) %>%
  mutate(Quantile = name,
         value = comma(value, 1, prefix = "£")) %>%
  select(-name) %>%
  spread(survey, value)

```

## Median income by council area

### Council area medians 

```{r median_council}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

councilinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "council") 

# Table 

mutate(councilinc, 
       sample = ifelse(is.na(HBAI_sample), "too small", 
                         ifelse(HBAI_sample >= 50, "ok", "too small")),
       HBAI_median = ifelse(sample == "ok", comma(HBAI_median, accuracy = 1, prefix = "£"), NA),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£")) %>%
  arrange(council) %>%
  select(council, sample, everything())


# Chart - Median income by council
councilinc$council <- decode(councilinc$council, search = councilnames, replace = councilshort)

councilinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = council, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(400, 700)) +
  scale_y_continuous(limits = c(400, 650)) +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  labs(title = "Median income by council - HBAI vs. SHS")

```

### Council area medians with confidence intervals

```{r median_council_ci}

# Chart - Median income by council with C.I.
# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

HBAI_CI_all <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "HBAI") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

SHS_CI_all <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "SHS") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

rbind(HBAI_CI_all, SHS_CI_all)


SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         Basic.lower = ifelse(n < 50, NA, Basic.lower),
         Basic.upper = ifelse(n < 50, NA, Basic.upper),
         Percentile.lower = ifelse(n < 50, NA, Percentile.lower),
         Percentile.upper = ifelse(n < 50, NA, Percentile.upper)) %>%
  filter(!is.na(Median))


levels <-  filter(CI, survey == "HBAI", n > 50) %>% 
  arrange(n) %>%
  mutate(council = factor(council, levels = as.character(council), ordered = TRUE)) %>%
  arrange(council)

CI$council <- factor(CI$council, levels(levels$council))


ggplot(data = filter(CI, !is.na(council))) +
  geom_point(aes(x = council, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 
  
```

## Median income by urban/rural area

### Urban/rural medians

```{r median_urbrur}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

urbrurinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "urbrur") 

# Table - Median income by urban/rural class

mutate(urbrurinc, 
       HBAI_median = comma(HBAI_median, accuracy = 1, prefix = "£"),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       urbrurclass = urbrurclasses) %>%
  arrange(urbrur) %>%
  select(urbrur, urbrurclass, everything())


# Chart - Median income by urban/rural class

urbrurinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = urbrurclasses, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  scale_x_continuous(limits = c(400, 600)) +
  scale_y_continuous(limits = c(450, 600)) 

```

### Urban/rural medians with confidence intervals

```{r median_urbrur_ci}

# Note that HBAI bootstrap mechanism is SRS!

UR_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

UR_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

UR_SHS_CI$survey <- "SHS"
UR_HBAI_CI$survey <- "HBAI"

UR_CI <- rbind(UR_HBAI_CI, UR_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

UR_CI$urbrur <- decode(UR_CI$urbrur, search = urbrurcodes, replace = urbrurclasses)
UR_CI$urbrur <- factor(UR_CI$urbrur, levels = urbrurclasses)

ggplot(data = UR_CI) +
  geom_point(aes(x = urbrur, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = urbrur,
                   xend = urbrur,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 

```

## Median income by age group 

- child, working-age, pensioners
- also: age group of HIH??

```{r median_agegroup}

# Table - Median income by age group

filter(tidydata, type == "total") %>%
  group_by(survey) %>%
  summarise(People = wtd.quantile(amount, probs = 0.5, weights = weight),
            Children = wtd.quantile(amount, probs = 0.5, weights = chwgt),
            WorkingAgeAdults = wtd.quantile(amount, probs = 0.5, weights = wawgt),
            Pensioners = wtd.quantile(amount, probs = 0.5, weights = pnwgt)) %>%
  mutate(People = comma(People, accuracy = 1, prefix  ="£"),
         Children = comma(Children, accuracy = 1, prefix  ="£"),
         WorkingAgeAdults = comma(WorkingAgeAdults, accuracy = 1, prefix  ="£"),
         Pensioners = comma(Pensioners, accuracy = 1, prefix  ="£"))

```

```{r median_agegroup_ci}

# Note that HBAI bootstrap mechanism is SRS!

ch_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ch_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ch_HBAI_CI$group <- "Children"
wa_HBAI_CI$group <- "WorkingAgeAdults"
pn_HBAI_CI$group <- "Pensioners"

ch_SHS_CI$group <- "Children"
wa_SHS_CI$group <- "WorkingAgeAdults"
pn_SHS_CI$group <- "Pensioners"

Age_HBAI_CI <- rbind(ch_HBAI_CI, wa_HBAI_CI, pn_HBAI_CI) %>%
  mutate(survey = "HBAI")

Age_SHS_CI <- rbind(ch_SHS_CI, wa_SHS_CI, pn_SHS_CI) %>%
  mutate(survey = "SHS")

Age_CI <- rbind(Age_HBAI_CI, Age_SHS_CI) %>%
  select(survey, group, Median, Normal.lower, Normal.upper, n) %>%
  mutate(group = factor(group, levels = agegrouplevels))

ggplot(data = Age_CI) +
  geom_point(aes(x = group, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = group,
                   xend = group,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 

```

## Median income by household type

### Household type medians

```{r median_hhtype}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, hhtype) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

hhtypeinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "hhtype") 

# Table - Median income by hhtype

mutate(hhtypeinc, 
       HBAI_median = comma(HBAI_median, accuracy = 1, prefix = "£"),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       hhtype = factor(hhtype, levels = hhtypenames)) %>%
  arrange(hhtype)

# Chart - Median income by hhtype

hhtypeinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = hhtype, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  scale_x_continuous(limits = c(350, 700)) +
  scale_y_continuous(limits = c(350, 700)) 

```

### Household type medians with confidence intervals

```{r median_hhtype_ci}

# Note that HBAI bootstrap mechanism is SRS!

hhtype_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

hhtype_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

hhtype_SHS_CI$survey <- "SHS"
hhtype_HBAI_CI$survey <- "HBAI"

hhtype_CI <- rbind(hhtype_HBAI_CI, hhtype_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

hhtype_CI$hhtype <- factor(hhtype_CI$hhtype, levels = hhtypenames)

ggplot(data = hhtype_CI) +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(350, 750)) 

```

## Median income by economic status of highest income householder

### Employment status medians

```{r median_eco}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, HIHemp) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

HIHempinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "HIHemp") %>%
  mutate(HBAI_median = ifelse(HBAI_sample < 50, NA, HBAI_median))

# Table - Median income by HIHemp

mutate(HIHempinc, 
       HBAI_median = ifelse(is.na(HBAI_median), NA, comma(HBAI_median, accuracy = 1, prefix = "£")),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       HIHemp = factor(HIHemp, levels = empstatnames)) %>%
  arrange(HIHemp)

# Chart - Median income by hhtype

HIHempinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = HIHemp, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  scale_x_continuous(limits = c(300, 650)) +
  scale_y_continuous(limits = c(250, 650)) 

```

### Employment status medians with confidence intervals

```{r median_eco_ci}

# Note that HBAI bootstrap mechanism is SRS!

HIHemp_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

HIHemp_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

HIHemp_SHS_CI$survey <- "SHS"
HIHemp_HBAI_CI$survey <- "HBAI"

HIHemp_CI <- rbind(HIHemp_HBAI_CI, HIHemp_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

HIHemp_CI$HIHemp <- factor(HIHemp_CI$HIHemp, levels = empstatnames)

ggplot(data = HIHemp_CI) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 650)) 

```


## Any further breakdowns - i.e. age group and income decile??

## Conclusions for total income

- overall income distribution...
- overall income decile points...
- incomes in council areas with larger HBAI sample sizes match...
- council areas where income doesn't match...
- urban / rural classes
- pensioners' incomes are lower in SHS
- economic status ...
- areas to further investigate: pensioners' incomes
- any other household type breakdowns of overall income requried??


# Income components

In SHS and FRS, which income sources contribute how much to total income? 


```{r components}

# Make chart showing total income amount and components

ggplot(tidydata,
       aes(x = type,
           weight = weight*amount,
           fill = survey)) +
  geom_bar(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(scale = 1E-9, prefix = "£", suffix = " billion")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Aggregated weekly income by income type", x = NULL, y = NULL)

```

Which income components contribute most to the differences?

```{r aggregate_components}

# Make table showing differences in income and income compononents

components <- tidydata %>%
  group_by(survey, type) %>%
  summarise(amount = sum(amount*weight)) %>%
  spread(survey, amount) %>%
  mutate(totdiff = HBAI[1] - SHS[1],
         diff = HBAI - SHS,
         reldiff = diff/HBAI,
         diffcontr = diff/totdiff) %>%
  arrange(desc(diffcontr)) %>%
  mutate(HBAI = comma(HBAI, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         SHS = comma(SHS, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         absdiff = comma(diff, scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1),
         diffcontr = percent(diffcontr),
         reldiff = percent(reldiff)) %>%
  select(type, HBAI, SHS, absdiff, reldiff, diffcontr)

select(components, type, HBAI, SHS, absdiff, diffcontr)

```

Total income aggregated to the  whole of Scotland is largely made up of earnings, followed by benefits (which include the state pension) and occupational pensions. Overall, SHS total income is `r components$reldiff[1]` lower than HBAI total income. The differences come mainly from lower benefit and much lower investment income in the SHS, and then also from lower occupational pensions. Other income components are relatively small and therefore contribute little to the overall differences in income.

Do investment incomes matter for poverty (= low income) measurement though?

```{r aggr_comp_quintiles}

# Make chart showing total income amount and components

ggplot(tidydata, 
       aes(x = type,
           weight = weight*amount,
           fill = survey)) +
  geom_bar(position = 'dodge') +
  scale_fill_manual(values = cols_survey) +
  scale_y_continuous(label = comma_format(scale = 1E-6, prefix = "£", suffix = " mn", accuracy = 1)) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(title = "Aggregated weekly income by income type and income quintile",
       subtitle = "Note different y axes",
       x = NULL, y = NULL) +
  facet_wrap(vars(quintile), scales = "free_y")

```


```{r aggr_comp_quintiles_table, include = FALSE}

# Make table showing differences in income and income compononents

tidydata %>%
  group_by(survey, quintile, type) %>%
  summarise(amount = sum(amount*weight)) %>%
  unite(temp, survey, quintile) %>%
  spread(temp, amount) %>%
  ungroup() %>%
  mutate(totdiff_1 = HBAI_1[1] - SHS_1[1],
         diff_1 = HBAI_1 - SHS_1,
         diffcontr_1 = diff_1/totdiff_1) %>%
  mutate_at(c("HBAI_1", "HBAI_2", "HBAI_3", "HBAI_4","HBAI_5", 
              "SHS_1","SHS_2","SHS_3","SHS_4","SHS_5","diff_1"),  
            comma_format(scale = 1E-6, prefix = "£", suffix = " million", accuracy = 1)) %>%
  mutate(dec1 = percent(diffcontr_1)) %>%
  select(type, HBAI_1, SHS_1, diff_1, dec1)


```


# Earnings 

Aggregated earnings income matches well, although less so once broken down to income quintiles. But it's average earnings that count, not the aggregate. Earnings are the most important source of income, so it's worth looking at this in a bit more detail. 


```{r earnings}

earnings <- tidydata %>%
  filter(type == "earn", 
         HIHemp %in% empstatnames[1:3]) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight),
            mean = wtd.mean(amount, weights = weight),
            sum = sum(amount*weight),
            sample = sum(n)) 

earnings %>%
  mutate(sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn"),
         sample = comma(sample)) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£"))

earnings %>% select(survey, HIHemp, median) %>%
  spread(survey, median) %>%
  ggplot(aes(label = HIHemp, x = HBAI, y = SHS)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_text_repel() +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(200, 700)) +
  scale_y_continuous(limits = c(300, 650)) +
  labs(title = "Median hhld earnings by HIH economic status - HBAI vs. SHS")

earnings %>% select(survey, HIHemp, mean) %>%
  spread(survey, mean) %>%
  ggplot(aes(label = HIHemp, x = HBAI, y = SHS)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_text_repel() +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(200, 700)) +
  scale_y_continuous(limits = c(350, 700)) +
  labs(title = "Mean hhld earnings by HIH economic status - HBAI vs. SHS")

```

```{r earnings_ci}

# Note that HBAI bootstrap mechanism is SRS!

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI", 
                              HIHemp %in% empstatnames[1:3]) ,
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "HIHemp",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS", 
                              HIHemp %in% empstatnames[1:3]),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

earn_CI$HIHemp = factor(earn_CI$HIHemp, levels = empstatnames)

ggplot(data = earn_CI) +
  geom_point(aes(x = fct_rev(HIHemp), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = HIHemp,
                   xend = HIHemp,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 700)) 


```

```{r earnings_ci_2}

# Earnings by hhld income quintile

# Note that HBAI bootstrap mechanism is SRS!

earn_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "quintile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "HBAI", 
                              HIHemp %in% empstatnames[1:3]),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)
# SHS bootstrap mechanism includes council strata

earn_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "quintile",
                data = filter(tidydata, 
                              type == "earn", 
                              survey == "SHS", 
                              HIHemp %in% empstatnames[1:3]),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

earn_SHS_CI$survey <- "SHS"
earn_HBAI_CI$survey <- "HBAI"

earn_CI <- rbind(earn_HBAI_CI, earn_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

ggplot(data = earn_CI) +
  geom_point(aes(x = quintile, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = quintile,
                   xend = quintile,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = "Hhld income quintile",
         y = "Median and 95% C.I",
         title = 'Weekly median net household earnings, SHS 2018 and HBAI 1819',
         subtitle = 'Excludes hhlds where HIH not working') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(200, 1000)) 

```

# Benefit income

- median benefit income
- main benefits
- number of benefit (any) recipients (in subsections)

Which benefits are the biggest (amountt and/or caseload) and differ the most between SHS and HBAI? 

- Look at child / working-age / pensioner benefits separately (IS and PC were identified as problematic previously)

- Look at this by geographic area - this hadn't been done previously

- List benefit amounts for SHS and FRS. 
- Check differences and identify which benefits contribute most to overall beenfit income discrepancy
- Check caseload and amounts
- Also against admin data

```{r benefits}

tidydata %>%
  filter(type == "ben",
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight),
            mean = wtd.mean(amount, weights = weight),
            sum = sum(amount*weight),
            sample = sum(n)) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn")) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(HIHemp, survey)

tidydata %>%
  filter(type == "ben",
         amount > 0) %>%
  group_by(survey, HIHemp) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  mutate(HIHemp = factor(HIHemp, levels = empstatnames)) %>%
  select(survey, HIHemp, median) %>%
  spread(survey, median) %>%
  ggplot(aes(label = HIHemp, x = HBAI, y = SHS)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_text_repel() +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(0, 400)) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Median hhld benefit income by HIH economic status - HBAI vs. SHS",
       subtitle = "Excludes hhlds with no benefit income")

tidydata %>%
  filter(type == "ben", 
         amount > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight),
            mean = wtd.mean(amount, weights = weight),
            sum = sum(amount*weight),
            sample = sum(n)) %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames),
         sum = comma(sum, scale = 1E-6, prefix = "£", suffix = " mn")) %>%
  mutate_at(c("median", "mean"), comma_format(prefix = "£")) %>%
  arrange(hhtype, survey)


tidydata %>%
  filter(type == "ben",
         amount > 0) %>%
  group_by(survey, hhtype) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames)) %>%
  select(survey, hhtype, median) %>%
  spread(survey, median) %>%
  ggplot(aes(label = hhtype, x = HBAI, y = SHS)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  geom_text_repel() +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(0, 350)) +
  scale_y_continuous(limits = c(0, 300)) +
  labs(title = "Median hhld benefit income by hhld type - HBAI vs. SHS",
       subtitle = "Excludes hhlds with no benefit income")


```

```{r bens_ci}

# Note that HBAI bootstrap mechanism is SRS!

ben_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "HBAI", 
                              amount > 0) ,
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ben_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "hhtype",
                data = filter(tidydata, 
                              type == "ben", 
                              survey == "SHS", 
                              amount > 0),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ben_SHS_CI$survey <- "SHS"
ben_HBAI_CI$survey <- "HBAI"

ben_CI <- rbind(ben_HBAI_CI, ben_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

ben_CI$hhtype = factor(ben_CI$hhtype, levels = hhtypenames)

ggplot(data = ben_CI) +
  geom_point(aes(x = fct_rev(hhtype), y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = hhtype,
                   xend = hhtype,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Median household benefit income, SHS 2018 and HBAI 1819',
         subtitle = "Households with zero benefits excluded") +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(0, 500)) 

```



## State pension

## Low income benefits

## Child benefit

## Disability benefits


# Investment income

# Occupational pensions income

# Employed earnings income

# Self-employed earnings income

# Characteristics of low income households

We may understand now the differences in income measured in SHS and FRS. So what does that mean for poverty? Do SHS and FRS identify the same kind of households as being in poverty?

## Household characteristics

Hhld type (working-age/pensioners, children, number of adults), economic status, tenure, ethnicity(?)

Responses to financial questions & matdep questions?

## Area characteristics

LA, urban/rural, SIMD deciles (??)

# Annex - Survey variables

Relevant variable names in SHS and FRS datasets. 

* SHS variable list (see SHS income project - SHS Household Variables.xlsx)
* [SHS questionnaires](https://www2.gov.scot/Topics/Statistics/16002/PublicationQuestionnaire)

SHS variables:

* ANNETINC_BROAD
* EARNINC
* BENINC
* MSCINC
* LA_GRWT

BENINC = sum(BENINC_HIHSP, BENINC_OA1, BENINC_OA2, BENINC_OA3) for BENINC01-BENINC40

      (1) Universal Credit
      (2) Housing Benefit
      (3) Council Tax Reduction
      (4) Working Tax Credit
      (5) Child Tax Credit
      (6) Income Support
      (7) Jobseeker’s Allowance
      (8) Employment and Support Allowance
      (9) Carer’s Allowance
      (10) Child Benefit
      (11) Guardian’s Allowance
      (12) Maternity Allowance
      (13) Statutory Maternity/Paternity pay, Statutory Adoption Pay
      (14) Statutory sick pay
      (15) Personal Independence Payments
      (16) Disability Living Allowance
      (17) Attendance allowance
      (18) Severe disablement allowance
      (19) Incapacity benefit
      (20) Industrial Injuries Disablement Benefit
      (21) Pension Credit
      (22) State Retirement Pension
      (23) Widow’s Pension, Bereavement Allowance, or Widowed Parent’s Allowance
      (24) Armed Forces Compensation Scheme
      (25) War Widow’s/Widower’s Pension
      (26) Funeral Expenses Payment
      (27) Sure Start Maternity Grant
      (28) Best Start Grant
      (29) Discretionary Housing Payment
      (30) Loan or grant from DWP
      (31) Loan or grant from Local Authority
      (32) Winter Fuel Payments
      (33) Cold Weather Payments
      (34) Extended payment of Housing Benefit
      (35) Bereavement Payment
      (36) Return to Work Payment
      (37) Community Care Grant from the Scottish Welfare Fund
      (38) Crisis Grant from the Scottish Welfare Fund
      (39) Budgeting Loan from Social Fund/Budgeting Advances from Universal Credit
      (40) Healthy Start Vouchers

MSCINC = sum(MSCINC_HIHSP, MSCINC_OA1, MSCINC_OA2, MSCINC_OA3) for MSCINC01-MSCINC10)

      (1) Income from Occupational/employer (non-State) pension(s)
      (2) Income from Benefit from annuity, trust or covenant
      (3) Income from Maintenance payments
      (4) Income from Rent from property or subletting, including boarders
      (5) Income from Dig money from other household members
      (6) Income from Benefit from accident/sickness scheme etc
      (7) Income from Investment income (eg Dividends from shares/interest from savings)
      (8) Income from Student loan
      (9) Income from Grant
      (10) Income from Regular non-work income, from any other source (please specify)

HBAI variables:

* GVTREGN
* gs_newhh
* ehcost
* entinchh
* ebeninhh
* enternhh
* hntinvhh
* hntocchh
* epribnhh
* emiscih

* HOUSEHOL	URINDS	HOL_327X	Urban and Rural Indicators for Scotland	

      1	Large Urban Area
    	2	Other Urban Area
    	3	Accessible Small Town
    	4	Remote Small Town
    	5	Very Remote Small Town
    	6	Accessible Rural
    	7	Remote Rural
    	8	Very Remote Rural

