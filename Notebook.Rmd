---
title: "SHS income project"
output: 
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup}

# Load packages

library(plyr) # needed for groupwiseMedian function
library(tidyverse)
library(haven) # for SAS importing
library(labelled) # to remove labels from imported data
library(scales) # for comma and percent formats
library(ggrepel) # for non-overlapping chart annotation
library(Hmisc) # for weighted quartiles
library(boot) # needed for groupwiseMedian function

# Load functions

source("functions.R")

# Load datasets

adult_1819 <- read_sas("../Full SAS Datasets/adult_1819.sas7bdat")
househol_1819 <- read_sas("../Full SAS Datasets/househol_1819.sas7bdat")
hbai1819 <- read_sas("../Full SAS Datasets/hbai1819.sas7bdat")
person18 <- read_sas("../Full SAS Datasets/person18.sas7bdat")
hhold18 <- read_sas("../Full SAS Datasets/hhold18.sas7bdat")

```


# Introduction

The general idea is to look at income first. Identify the areas of income measurement with the biggest discrepancies, dig deep, until the differences can be explained. Once the differences are understood, identify households in poverty and see if they show the same characteristics as those identified in the HBAI.

Documents:

* [PID (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A27886326/details)
* [Project plan (on eRDM)](https://erdm.scotland.gov.uk:8443/documents/A28035002/details)


# Total income - FRS and SHS

We expect average total income to be matching the FRS well, even if the individual income components might not match well enough for detailed analysis (due to imputation of a lot of missing data). 

- look at distributions, median, quartiles etc
- geographical analysis - is total income good enough in each region? Look at median income by region
- median income by hhld type, urban/rural, economic status, age group, income decile
- does income match better for those charatceristics that were used for the missing income imputation?

```{r make_tidy_data}

# Create tidy SHS dataset

# Equivalise: 
# get number of children under 14 from person dataset; 
# get number of adults and children over 14

# Age group weights:
# get number of dependent children; working-age adults; pensioners per hhld

personshs <- person18 %>%
  # Remove permanently absent hhld members
  select(UNIQID, HA5, HA7, HA10, HA13, HA31:HA310, PENAGE) %>%
  filter(is.na(HA10)|HA10 != 1,
         is.na(HA13)|HA13 != 1) %>%
  mutate(u14 = ifelse(HA5 < 14, 1, 0),
         o64 = ifelse(HA5 >= 65, 1, 0),
         pp = 1,
         kid = ifelse(HA31 %in% c(4, 5) |
                        HA32 %in% c(4, 5) |
                        HA33 %in% c(4, 5) |
                        HA34 %in% c(4, 5) |
                        HA35 %in% c(4, 5) |
                        HA36 %in% c(4, 5) |
                        HA37 %in% c(4, 5) |
                        HA38 %in% c(4, 5) |
                        HA39 %in% c(4, 5) |
                        HA310 %in% c(4, 5) , 1, 0),
         depchld = ifelse(HA5 <= 16, 1, 0),
         p1719 = ifelse(HA5 <= 19 & HA5 >= 17, 1, 0),
         inedu = ifelse(HA7 %in% c(7, 8), 1, 0),
         athome = ifelse(HA10 != 1 & !is.na(HA10), 1, 0),
         depchld = ifelse(kid == 1 & p1719 == 1 & inedu == 1 & athome == 1, 1, depchld)) %>%
  group_by(UNIQID) %>%
  summarise(u14 = sum(u14),
            pp = sum(pp),
            ch = sum(depchld),
            o64 = sum(o64),
            pn = ifelse(is.na(sum(PENAGE)), o64, sum(PENAGE)),
            wa = pp - ch - pn)
  

# Note there is one hhld with one dependent child and no (present) adults
# check <- filter(personshs, wa == 0 & pn == 0)

tidyshs <- hhold18 %>%
  select(UNIQID, MSCINC01:MSCINC10, EARNINC, BENINC, LA_GRWT, COUNCIL, SHS_6CLA) %>%
  left_join(personshs, by = "UNIQID") %>%
  replace_na(list(MSCINC01 = 0, MSCINC02 = 0, MSCINC03 = 0, MSCINC04 = 0, MSCINC05 = 0, 
                  MSCINC06 = 0, MSCINC07 = 0,  MSCINC08 = 0, MSCINC09 = 0, MSCINC10 = 0,
                  EARNINC = 0, BENINC= 0)) %>%
  mutate(equ = 0.67 + (pp-u14-1)*0.33 + u14*0.2,
         total_earn = EARNINC*7/(365*equ),
         total_ben = BENINC*7/(365*equ),
         total_privben = MSCINC02*7/(365*equ) + MSCINC06*7/(365*equ),
         total_occ = MSCINC01*7/(365*equ),
         total_inv = MSCINC07*7/(365*equ),
         total_oth = (MSCINC03 + MSCINC04 + MSCINC05 + MSCINC08 + MSCINC09 + MSCINC10)*7/(365*equ),
         total = total_earn + total_ben + total_privben + total_occ + total_inv + total_oth,
         weight = round(LA_GRWT*pp),
         chwgt = round(LA_GRWT*ch),
         wawgt = round(LA_GRWT*wa),
         pnwgt = round(LA_GRWT*pn),
         council = COUNCIL,
         urbrur = SHS_6CLA,
         hhtype = ifelse(pp == 1 & wa == 1, 1, 
                         ifelse(pp == 2 & wa == 2, 2, 
                                ifelse(pp >= 3 & wa == pp & pn == 0, 3, 
                                       ifelse(ch >= 1 & wa == 1 & pn == 0, 4, 
                                              ifelse(ch >= 1 & wa == 2 & pn == 0, 5, 
                                                     ifelse(ch >= 1 & wa >= 3 & pn == 0, 6,
                                                            ifelse(pp == 1 & pn == 1, 7, 
                                                                   ifelse(pp == 2 & pn == 2, 8, 
                                                                          ifelse(pp == 2 & wa == 1 & pn == 1, 9, 10)))))))))) %>%
  select(weight, chwgt, wawgt, pnwgt, total, total_earn, total_ben, total_privben, total_occ, total_inv, total_oth, council, urbrur, hhtype, pp, ch, wa, pn) %>%
  remove_labels() %>%
  gather(key = type, value = amount, -weight, -chwgt, -wawgt, -pnwgt, 
         -council, -urbrur, -hhtype, -pp, -ch, -wa, -pn) %>%
  mutate(survey = "SHS")

tidyshs$council <- decode(tidyshs$council,
                          search = SHScodes, 
                          replace = councilnames,  
                          default = "unknown")

tidyshs$hhtype <- decode(tidyshs$hhtype,
                          search = hhtypecodes, 
                          replace = hhtypenames,
                          default = "unknown")


# Create tidy HBAI dataset

# Get council and urban/rural class from househol dataset

tidyhousehol <- househol_1819 %>%
  filter(COUNTRY == 3) %>%
  mutate(council = LAC,
         urbrur = URINDS,
         hhtype = HHCOMPS) %>%
  select(SERNUM, council, urbrur, hhtype)

# Recode to 6-tier classification

tidyhousehol$urbrur <- decode(tidyhousehol$urbrur,
                              search = c(1, 2, 3, 4, 5, 6, 7, 8),
                              replace = c(1, 2, 3, 4, 4, 5, 6, 6))

tidyhousehol$hhtype <- decode(tidyhousehol$hhtype,
                              search = FRShhcodes,
                              replace = FRShhrecode)

tidyhousehol$hhtype <- decode(tidyhousehol$hhtype,
                              search = hhtypecodes,
                              replace = hhtypenames)

# Get person, child, wa and pensioner weights

HBAIweights <- hbai1819 %>%
  filter(GVTREGN == 12) %>%
  select(SERNUM, gs_newpp, gs_newch, gs_newwa, gs_newpn) %>%
  group_by(SERNUM) %>%
  summarise(weight = sum(gs_newpp),
            chwgt = sum(gs_newch),
            wawgt = sum(gs_newwa),
            pnwgt = sum(gs_newpn))

tidyhbai <- hbai1819 %>%
  filter(GVTREGN == 12,
         BENUNIT == 1) %>%
  left_join(HBAIweights, by = "SERNUM") %>%
  mutate(total_earn = enternhh/eqobhchh,
         total_ben = ebeninhh/eqobhchh,
         total_privben = epribnhh/eqobhchh,
         total_occ = hntocchh/eqobhchh,
         total_inv = hntinvhh/eqobhchh,
         total_oth =  emiscihh/eqobhchh,
         total = total_earn + total_ben + total_privben + total_occ + total_inv + total_oth) %>%
  select(weight, chwgt, wawgt, pnwgt, total, total_earn, total_ben, total_privben, total_occ, total_inv, total_oth, SERNUM) %>%
  left_join(tidyhousehol, by = "SERNUM") %>%
  gather(key = type, value = amount, -SERNUM, -weight, -chwgt, -wawgt, -pnwgt, -council, -urbrur, -hhtype) %>%
  mutate(survey = "HBAI") %>%
  select(-SERNUM) %>%
  remove_labels() 

tidyhbai$council <- decode(tidyhbai$council, 
                           search = FRScodes, 
                           replace = councilnames, 
                           default = "unknown")

# Combine datasets to a hhld level dataset with different income components (using hhld weight)

tidydata <- rbind(tidyhbai, tidyshs) %>%
  mutate(survey = factor(survey, ordered = TRUE),
         n = 1)

```

## Income distribution

```{r income_distributions}

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  geom_density(size = 1, alpha = 0.5, bw = 0.02) +
  scale_x_log10(limits = c(20, 20000), labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = comma_format(scale = 1E-6, suffix = " million")) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Number of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  coord_cartesian(xlim = c(20, 20000)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

tidydata %>%
  filter(type == "total") %>%
  ggplot(aes(x = amount, weight = weight, colour = survey, fill = survey )) +
  coord_cartesian(xlim = c(100,1500)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.5) +
  scale_x_log10(labels = comma_format(prefix = "£")) +
  scale_y_continuous(labels = percent_format(1)) +
  scale_color_manual(values = cols_survey) +
  scale_fill_manual(values = cols_survey) +
  labs(title = "SHS and FRS cumulative household income distribution",
       subtitle = "HBAI income excludes children's income and deductions, and is not SPI'd or deflated",
       x = "Weekly income",
       y = "Proportion of households") +
  theme(legend.position = "top",
        legend.title = element_blank())

```

## Income quartiles and decile points

### Weekly total household income quartiles

```{r income_quartiles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, probs=c(0.25, 0.5, 0.75), weights = weight)))) %>%
  unnest(x) %>%
  mutate(value = comma(value, 1, prefix = "£"),
         Quantile = name) %>%
  select(-name) %>%
  spread(survey, value)

```

### Weekly total household income decile points

```{r income_deciles}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey) %>% 
  summarise(x=list(enframe(wtd.quantile(amount, probs=c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9), weights = weight)))) %>%
  unnest(x) %>%
  mutate(Quantile = name,
         value = comma(value, 1, prefix = "£")) %>%
  select(-name) %>%
  spread(survey, value)

```

## Median income by council area

### Council area medians 

```{r median_council}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

councilinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, council) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "council") 

# Table 

mutate(councilinc, 
       sample = ifelse(is.na(HBAI_sample), "too small", 
                         ifelse(HBAI_sample >= 50, "ok", "too small")),
       HBAI_median = ifelse(sample == "ok", comma(HBAI_median, accuracy = 1, prefix = "£"), NA),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£")) %>%
  arrange(council) %>%
  select(council, sample, everything())


# Chart - Median income by council
councilinc$council <- decode(councilinc$council, search = councilnames, replace = councilshort)

councilinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = council, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  scale_x_continuous(limits = c(400, 700)) +
  scale_y_continuous(limits = c(400, 650)) +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  labs(title = "Median income by council - HBAI vs. SHS")

```

### Council area medians with confidence intervals

```{r median_council_ci}

# Chart - Median income by council with C.I.
# Note that HBAI bootstrap mechanism is SRS!

HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

HBAI_CI_all <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "HBAI") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

# SHS bootstrap mechanism includes council strata

SHS_CI <- groupwiseMedian3(var = "amount",
                group = "council",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3)

SHS_CI_all <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = TRUE,
                percentile = TRUE,
                digits = 3) %>%
  mutate(survey = "SHS") %>%
  select(survey, Median, n, Conf.level, Normal.lower, Normal.upper)

rbind(HBAI_CI_all, SHS_CI_all)


SHS_CI$survey <- "SHS"
HBAI_CI$survey <- "HBAI"

CI <- rbind(HBAI_CI, SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper),
         Basic.lower = ifelse(n < 50, NA, Basic.lower),
         Basic.upper = ifelse(n < 50, NA, Basic.upper),
         Percentile.lower = ifelse(n < 50, NA, Percentile.lower),
         Percentile.upper = ifelse(n < 50, NA, Percentile.upper)) %>%
  filter(!is.na(Median))


levels <-  filter(CI, survey == "HBAI", n > 50) %>% 
  arrange(n) %>%
  mutate(council = factor(council, levels = as.character(council), ordered = TRUE)) %>%
  arrange(council)

CI$council <- factor(CI$council, levels(levels$council))


ggplot(data = filter(CI, !is.na(council))) +
  geom_point(aes(x = council, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = council,
                   xend = council,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
  
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 
  
```

## Median income by urban/rural area

### Urban/rural medians

```{r median_urbrur}

samplesize <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(sample = sum(n)) %>%
  spread(survey, sample) %>%
  rename(HBAI_sample = HBAI,
         SHS_sample = SHS)

urbrurinc <- tidydata %>%
  filter(type == "total") %>%
  group_by(survey, urbrur) %>%
  summarise(median = wtd.quantile(amount, probs = 0.5, weights = weight)) %>%
  spread(survey, median) %>%
  rename(HBAI_median = HBAI,
         SHS_median = SHS) %>%
  left_join(samplesize, by = "urbrur") 

# Table - Median income by urban/rural class

mutate(urbrurinc, 
       HBAI_median = comma(HBAI_median, accuracy = 1, prefix = "£"),
       SHS_median = comma(SHS_median, accuracy = 1, prefix = "£"),
       urbrurclass = urbrurclasses) %>%
  arrange(urbrur) %>%
  select(urbrur, urbrurclass, everything())


# Chart - Median income by urban/rural class

urbrurinc %>%
  filter(HBAI_sample >= 50) %>%
  ggplot(aes(label = urbrurclasses, x = HBAI_median, y = SHS_median)) +
  geom_point(aes(size = HBAI_sample, alpha = HBAI_sample)) +
  geom_text_repel() +
  geom_abline(slope = 1, intercept = 0) +
   theme(legend.position = "top") +
  guides(size = guide_legend("HBAI sample size"), 
         alpha = guide_legend("HBAI sample size")) +
  scale_x_continuous(limits = c(400, 600)) +
  scale_y_continuous(limits = c(450, 600)) 

```

### Urban/rural medians with confidence intervals

```{r median_urbrur_ci}

# Note that HBAI bootstrap mechanism is SRS!

UR_HBAI_CI <- groupwiseMedian2(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "HBAI"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

UR_SHS_CI <- groupwiseMedian3(var = "amount",
                group = "urbrur",
                data = filter(tidydata, type == "total", survey == "SHS"),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

UR_SHS_CI$survey <- "SHS"
UR_HBAI_CI$survey <- "HBAI"

UR_CI <- rbind(UR_HBAI_CI, UR_SHS_CI) %>%
  mutate(Median = ifelse(n < 50, NA, Median),
         Normal.lower = ifelse(n < 50, NA, Normal.lower),
         Normal.upper = ifelse(n < 50, NA, Normal.upper)) %>%
  filter(!is.na(Median))

UR_CI$urbrur <- decode(UR_CI$urbrur, search = urbrurcodes, replace = urbrurclasses)
UR_CI$urbrur <- factor(UR_CI$urbrur, levels = urbrurclasses)

ggplot(data = UR_CI) +
  geom_point(aes(x = urbrur, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = urbrur,
                   xend = urbrur,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 

```

## Median income by age group 

- child, working-age, pensioners
- also: age group of HIH??

```{r median_agegroup}

# Table - Median income by age group

filter(tidydata, type == "total") %>%
  group_by(survey) %>%
  summarise(People = wtd.quantile(amount, probs = 0.5, weights = weight),
            Children = wtd.quantile(amount, probs = 0.5, weights = chwgt),
            WorkingAgeAdults = wtd.quantile(amount, probs = 0.5, weights = wawgt),
            Pensioners = wtd.quantile(amount, probs = 0.5, weights = pnwgt)) %>%
  mutate(People = comma(People, accuracy = 1, prefix  ="£"),
         Children = comma(Children, accuracy = 1, prefix  ="£"),
         WorkingAgeAdults = comma(WorkingAgeAdults, accuracy = 1, prefix  ="£"),
         Pensioners = comma(Pensioners, accuracy = 1, prefix  ="£"))

```

```{r median_agegroup_ci}

# Note that HBAI bootstrap mechanism is SRS!

ch_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_HBAI_CI <- groupwiseMedian2(var = "amount",
                data = filter(tidydata, type == "total", survey == "HBAI") %>% 
                  select(-weight) %>% 
                  rename(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

# SHS bootstrap mechanism includes council strata

ch_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = chwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

wa_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = wawgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

pn_SHS_CI <- groupwiseMedian3(var = "amount",
                data = filter(tidydata, type == "total", survey == "SHS") %>% 
                  select(-weight) %>% 
                  rename(weight = pnwgt),
                conf = 0.95,
                R = 100,
                normal = TRUE,
                basic = FALSE,
                percentile = FALSE,
                digits = 3)

ch_HBAI_CI$group <- "Children"
wa_HBAI_CI$group <- "WorkingAgeAdults"
pn_HBAI_CI$group <- "Pensioners"

ch_SHS_CI$group <- "Children"
wa_SHS_CI$group <- "WorkingAgeAdults"
pn_SHS_CI$group <- "Pensioners"

Age_HBAI_CI <- rbind(ch_HBAI_CI, wa_HBAI_CI, pn_HBAI_CI) %>%
  mutate(survey = "HBAI")

Age_SHS_CI <- rbind(ch_SHS_CI, wa_SHS_CI, pn_SHS_CI) %>%
  mutate(survey = "SHS")

Age_CI <- rbind(Age_HBAI_CI, Age_SHS_CI) %>%
  select(survey, group, Median, Normal.lower, Normal.upper, n) %>%
  mutate(group = factor(group, levels = agegrouplevels))

ggplot(data = Age_CI) +
  geom_point(aes(x = group, y = Median, colour = survey), size = 2) +
  geom_segment(aes(x = group,
                   xend = group,
                 y = Normal.lower, 
                 yend = Normal.upper,
                 colour = survey),
               size = 3,
               alpha = 0.5) +
    scale_colour_manual(values = cols_survey) +
    labs(x = NULL,
         y = "Median and 95% C.I",
         title = 'Weekly median net household income, SHS 2018 and HBAI 1819') +
  scale_y_continuous(labels = comma_format(prefix = "£")) +
  theme(legend.position = "top",
        legend.title = element_blank()) +
    coord_flip(ylim = c(300, 800)) 

```

## Median income by household type

## Median income be economic status

## Any further breakdowns - i.e. age group and income decile



# Income components

In SHS and FRS, which income sources contribute how much to total income? 

Also, do medians!


```{r chart_compare_inc_components}

# Make chart showing total income amount and components

ggplot(tidydata, 
       aes(x = type,
           y = amount,
           fill = survey,
           label = ifelse(survey == "SHS", '', comma(amount, 
                         scale = 1E-9, 
                         accuracy = 0.1, 
                         prefix = "£", 
                         suffix = " billion")))) +
  geom_bar(stat = 'identity',
           position = 'dodge') 

```

Which income components contribute most to the differences?

```{r table_compare_inc_components}

# Make table showing differences in income and income compononents


```

SHS total income is r str_sub(data$diff_contribution[1], 2,5) lower than HBAI total income. The differences come mainly from lower benefit and much lower investment income in the SHS, and then also from lower occupational pensions and higher earnings. Little would be gained from investigating private benefit and other income as these contribute only little to the overall differences in income.

# Benefit income

Which benefits are the biggest and differ the most between SHS and HBAI? 

- Look at child / working-age / pensioner benefits separately (IS and PC were identified as problematic previously)

- Look at this by geographic area - this hadn't been done previously

- List benefit amounts for SHS and FRS. 
- Check differences and identify which benefits contribute most to overall beenfit income discrepancy
- Check caseload and amounts
- Also against admin data

## State pension

## Low income benefits

## Child benefit

## Disability benefits


# Investment income

# Occupational pensions income

# Employed earnings income

# Self-employed earnings income

# Characteristics of low income households

We may understand now the differences in income measured in SHS and FRS. So what does that mean for poverty? Do SHS and FRS identify the same kind of households as being in poverty?

## Household characteristics

Hhld type (working-age/pensioners, children, number of adults), economic status, tenure, ethnicity(?)

Responses to financial questions & matdep questions?

## Area characteristics

LA, urban/rural, SIMD deciles (??)

# Annex - Survey variables

Relevant variable names in SHS and FRS datasets. 

* SHS variable list (see SHS income project - SHS Household Variables.xlsx)
* [SHS questionnaires](https://www2.gov.scot/Topics/Statistics/16002/PublicationQuestionnaire)

SHS variables:

* ANNETINC_BROAD
* EARNINC
* BENINC
* MSCINC
* LA_GRWT

BENINC = sum(BENINC_HIHSP, BENINC_OA1, BENINC_OA2, BENINC_OA3) for BENINC01-BENINC40

      (1) Universal Credit
      (2) Housing Benefit
      (3) Council Tax Reduction
      (4) Working Tax Credit
      (5) Child Tax Credit
      (6) Income Support
      (7) Jobseeker’s Allowance
      (8) Employment and Support Allowance
      (9) Carer’s Allowance
      (10) Child Benefit
      (11) Guardian’s Allowance
      (12) Maternity Allowance
      (13) Statutory Maternity/Paternity pay, Statutory Adoption Pay
      (14) Statutory sick pay
      (15) Personal Independence Payments
      (16) Disability Living Allowance
      (17) Attendance allowance
      (18) Severe disablement allowance
      (19) Incapacity benefit
      (20) Industrial Injuries Disablement Benefit
      (21) Pension Credit
      (22) State Retirement Pension
      (23) Widow’s Pension, Bereavement Allowance, or Widowed Parent’s Allowance
      (24) Armed Forces Compensation Scheme
      (25) War Widow’s/Widower’s Pension
      (26) Funeral Expenses Payment
      (27) Sure Start Maternity Grant
      (28) Best Start Grant
      (29) Discretionary Housing Payment
      (30) Loan or grant from DWP
      (31) Loan or grant from Local Authority
      (32) Winter Fuel Payments
      (33) Cold Weather Payments
      (34) Extended payment of Housing Benefit
      (35) Bereavement Payment
      (36) Return to Work Payment
      (37) Community Care Grant from the Scottish Welfare Fund
      (38) Crisis Grant from the Scottish Welfare Fund
      (39) Budgeting Loan from Social Fund/Budgeting Advances from Universal Credit
      (40) Healthy Start Vouchers

MSCINC = sum(MSCINC_HIHSP, MSCINC_OA1, MSCINC_OA2, MSCINC_OA3) for MSCINC01-MSCINC10)

      (1) Income from Occupational/employer (non-State) pension(s)
      (2) Income from Benefit from annuity, trust or covenant
      (3) Income from Maintenance payments
      (4) Income from Rent from property or subletting, including boarders
      (5) Income from Dig money from other household members
      (6) Income from Benefit from accident/sickness scheme etc
      (7) Income from Investment income (eg Dividends from shares/interest from savings)
      (8) Income from Student loan
      (9) Income from Grant
      (10) Income from Regular non-work income, from any other source (please specify)

HBAI variables:

* GVTREGN
* gs_newhh
* ehcost
* entinchh
* ebeninhh
* enternhh
* hntinvhh
* hntocchh
* epribnhh
* emiscih

* HOUSEHOL	URINDS	HOL_327X	Urban and Rural Indicators for Scotland	

      1	Large Urban Area
    	2	Other Urban Area
    	3	Accessible Small Town
    	4	Remote Small Town
    	5	Very Remote Small Town
    	6	Accessible Rural
    	7	Remote Rural
    	8	Very Remote Rural

