---
title: "SHS income project - 2nd interim report (poverty analysis)"
# output:
#   bookdown::gitbook:
#     config:
#       fontsettings:
#         family: sans
#         theme: white
#       sharing: no
#       toc:
#         collapse: section
#         scroll_highlight: yes
#     split_by: section+number
output:
  word_document:
    reference_docx: template.docx
    toc: yes
---

```{r setup, include = FALSE}

# Set global chunk options

knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.5, 
                      echo = FALSE,
                      warning = FALSE)

# load data

source("scr/prepPovertydata.R")

```

# Project summary

A brief summary of the project initiation document to recall purpose and scope of the project.

The SHS income project is about assessing how accurately the Scottish Household Survey (SHS) measures household income, by comparing SHS data to data from Household Below Average Incomes (HBAI), the “gold standard” for household income data in the UK. 

The **purpose** of this assessment is to understand whether SHS income data is accurate enough to allow household income and poverty analysis in Scotland where this is not possible using the HBAI or administrative data sources. For example, income and poverty analysis in Scotland is not possible with HBAI or admin data for certain subgroups of the population where the HBAI sample is too small, and where these subgroups are not identified in the administrative data. This is also the case for a wide range of contexts which are not covered or not covered in as much detail in the HBAI or admin data, such as travel patterns, social capital, satisfaction with services, house condition, digital inclusion and financial inclusion.

It should be noted that by undertaking this work, we are not proposing a wholesale shift in reporting income and poverty statistics from HBAI to SHS income data; the HBAI will remain the main source of national (Scotland-level) poverty and household income statistics, with SHS statistics providing supplementary income and poverty analysis where not available from HBAI or administrative data.

The **scope** of this project is to assess the accuracy of the new SHS income variable, and whether it measures income accurately enough to produce poverty estimates. Further improvements of the income variable are not in scope; however, we are making suggestions to the SHS team for potential improvements that do not require new survey questions.

The **stages** of this project are as follows:

- We shared the project initiation document in early May 2020. 
- The 1st interim report, containing detailed income analysis, was shared on 30 July 2020, with detailed comments received from Ailie Clarkson and Nick Bailey. 
- This is the 2nd interim report plan, containing poverty analysis.
- A final project report will describe the analysis undertaken and the conclusions drawn in terms of strengths and limitations of SHS income data.

# Income analysis summary

A brief summary of the income analysis paper and comments.

In the 1st interim report (shared on 30 July), we compared net household income data from the SHS 2018 with that from the HBAI 2018/19 by looking at the main income components as well as total income. Below is the summary of our findings and the implications.

We found that overall, average earnings were reasonably similar between surveys, with SHS earnings slightly higher than HBAI earnings. Note though that for lower household incomes, SHS earnings were slightly lower than HBAI earnings. While average earnings for households with employed household heads were comparable between the two surveys, earnings for the small number of households with a self-employed head were much higher in the SHS compared to the HBAI, probably due to differences in survey methodology.

Earnings determine total income of employed and self-employed households, the majority of households in Scotland. For example, households where the head is employed have fairly consistent earnings levels across the two surveys, and therefore their total income also matches well. In contrast, households with a self-employed head show very different earnings levels in the two surveys, and therefore also very different income levels.

Average benefit income was consistently lower in the SHS compared to the HBAI, due to underreporting and non-reporting of benefits. The impact of under- and non-reporting of the State Pension dwarfed the impact of all other (also underreported) benefits and thereby affected almost all pensioner households. Underreporting of disability benefits affected households where these benefits are a major or the main income source, such as those who are economically inactive due to disability or longterm illness.

Benefit income drives total income of economically inactive and unemployed households. For example, pensioners’ incomes largely consist of the State Pension and to a smaller degree, occupational pensions. Both are considerably lower in the SHS, and therefore total income of pensioners is lower. Similarly, a large part of total income of households with a disabled household head come from disability-related benefits, which are equally much lower in the SHS, resulting in too low total incomes.

The total income distribution is similar for both surveys, although the SHS distribution is slightly wider than the HBAI equivalent. As a result, a larger proportion of the population sit below the SHS poverty threshold in the SHS income distribution.

Within the limited means of comparing regional incomes between surveys, we found no indication that there were any local areas with particularly large income discrepancies, and no reason to expect any.

In conclusion, incomes between SHS and HBAI compare reasonably well, and we believe that the SHS produces very good income estimates considering its wide remit. However, there are some types of households which cause problems due to underreporting of benefits and differences in self-employed earnings: The largest group among them are pensioner households; other groups are households that are economically inactive due to disability, and households with a self-employed household head.

The implications of all findings for poverty measurement are as follows:

- SHS income data enables us to calculate robust before housing costs (BHC) poverty rates. These will be higher than those based on the HBAI due to the shape of the income distribution and due to pensioners’ incomes which are too low.
- The differences between poverty estimates based on different surveys always need to be clearly communicated when publishing any estimates.
- It might also be best to exclude pensioners from any SHS based poverty analysis.
- Furthermore, when disaggregating statistics by economic status, one should be aware that poverty of self-employed households may be underestimated.
- And finally, regional poverty breakdowns should be possible where sample sizes allow, although it would be advisable to always include some measure of uncertainty.

The members of the QA group found that the analysis undertaken was thorough, they considered the findings plausible and agreed with the conclusions.

More re comments ...

# Poverty analysis summary

A summary of the results and conclusions of the poverty analysis. These are based on the tables and charts in Annex 1 (HBAI comparison) and Annex 2 (CiLIF comparison).



# Project conclusions

Key conclusions; suggestions for further work (not part of this project)

We would therefore recommend to continue to collect income data from all adults. We would also suggest to review how State Pension data is collected in the SHS, and whether changes to the questionnaire wording or data editing / imputation routines may improve the data quality for this key benefit.

- suggestions for future work which is outwith the scope of this project (improving pension income reporting and consider imputation; improved council tax imputation)

We looked in detail at the sources of income, but haven’t fully addressed the following remaining issues:

a)	Housing costs. There are some differences between surveys in what’s considered a housing cost. The main difference affects home owners with a mortgage: While the HBAI considers only the mortgage interest as a housing cost, the SHS also includes capital repayments. Either method has merit, but each will lead to a quite different result for these households - we expect housing costs for home owners with a mortgage to be higher in the SHS, and income after housing cost lower, than in the HBAI. It appears not possible to strip out capital repayments from the SHS housing costs to align them with the HBAI. In addition to mortgages, the HBAI also includes rent, water and sewerage charges, and (structural) home insurance as housing costs. In the SHS, housing costs also include rent. SHS 2018 does not yet contain the housing cost variable. Once the SHS 2019 dataset is published in September, we can compare housing costs by tenure across surveys to understand the impact of the different definitions.

b)	Self-employed earnings are much higher in the SHS compared to the HBAI. Checking with SHS datas from previous years shows that this high level of self-employed earnings is consistent across years. The difference between surveys could be caused by questionnaire wording, survey time spent on self-employed earnings, or different definitions of self-employment. As households with a self-employed household head make up only 7% of all households (according to SHS 2018) this issue is not a priority. However, if QA group members have expertise in this area we would be grateful to hear about it.

c)	The SHS doesn’t collect information on children’s incomes. An Ipsos Mori report showed that children’s income made up 1% of single parents’ income in the FRS, and that it was less important for couples households with children. Children’s incomes include earnings, trust funds, scholarships, bursaries or grants. Since median incomes appear to agree fairly well across surveys for both household types, we decided not to pursue this issue any further.

d)	In the analysis here, we didn’t use the usual HBAI BHC income variable on which the official income and poverty statistics are based, but income without top-income adjustments. The reason for this is that the HBAI top-income adjusted figures are only available for gross earnings, but we’re comparing net earnings. However, the effect on the median of total income is small. The HBAI median without top-income adjustment is £515, whereas the top-income adjusted median is £517. Lower incomes will be affected less by this lack of top-income adjustment, and therefore we decided not to pursue this issue any further.

e)	The bootstrapping mechanism that calculates the 95% confidence intervals of HBAI median incomes draws sub-samples from the survey sample via simple random sampling. However, in order to be precise, it should really draw the samples in the same way as the original sample was drawn, using the complex sampling design of the FRS. This might widen the C.I.s even further. It may be possible to calculate these more accurate confidence intervals for the HBAI data using a resamples dataset that DWP provide; however, this will be time consuming and is unlikely to add much new information.



# Projects outputs

Details of the remaining output, the final report, which will be published.

The main output from this project is a report of the analysis undertaken to understand the quality of the SHS income variable and the conclusions drawn in terms of strengths and limitations of the new SHS income variable.

The conclusions also make a recommendation as to whether the additional income questions should remain in the SHS questionnaire.

Within the report, brief guidance on strengths and limitations of the new SHS income variable will be produced for SHS users. This guidance explains how poverty analysis based on the SHS income variable might differ from official statistics and why, and when to use SHS income data rather than the conventional, more robust income datasets. (Also, what the definitional housing costs differences are and how they will affect poverty rates, even though we haven't looked in detail at housing cost data quality (Ipsos Mori might have, check their report))

A non-technical summary of the report will be provided for the wider stakeholder group.

# Annex 1: HBAI and SHS - relative poverty

In the analysis that follows, we compared SHS-derived poverty estimates to HBAI-derived poverty estimates. The HBAI estimates used here differ from official statistics in two ways:

- they use a poverty threshold based on the Scottish median rather than the UK median
- they are based on a household income that doesn't include children's incomes and is not adjusted for top-income underreporting

_**Should I do this, or use official stats??**_

More people are in poverty in the SHS compared to the HBAI. This is largely driven by pensioners, whose poverty risk is exaggerated in the SHS. However, if we exclude households with pensioners, we still have slightly more working-age adults and children in poverty in the SHS than in the HBAI. We therefore also expect slightly higher poverty rates in the SHS in the analysis that follows.

(Note that 'adults' in the tables below refer to working-age adults.)

```{r poverty_numbers}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, low60bhc) %>%
  summarise(total = comma(sum(ppwgt), 10000),
            children = comma(sum(chwgt), 10000),
            adults = comma(sum(wawgt), 10000),
            pensioners = comma(sum(pnwgt), 10000)) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Numbers in relative poverty")

```

```{r poverty_composition}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, low60bhc) %>%
  summarise(total = sum(ppwgt),
            children = sum(chwgt),
            adults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(children = percent(children/total, 1),
         adults = percent(adults/total, 1),
         pensioners = percent(pensioners/total, 1),
         total = percent(1, 1) ) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Composition of those in relative poverty")

```

```{r poverty_rates}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, low60bhc) %>%
  summarise(total = sum(ppwgt),
            children = sum(chwgt),
            adults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(total = percent(total/sum(total), 1),
         children = percent(children/sum(children), 1),
         adults = percent(adults/sum(adults), 1),
         pensioners = percent(pensioners/sum(pensioners), 1)) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Proportion of individuals in relative poverty")


```

**Households with pensioners are excluded from the analysis that follows.** This also reduces the number of children and working-age adults in poverty, as some of them live in households with pensioners.

```{r poverty_numbers_exc}

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc) %>%
  summarise(total = comma(sum(chwgt + wawgt), 10000),
            children = comma(sum(chwgt), 10000),
            adults = comma(sum(wawgt), 10000)) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Numbers in relative poverty")

```

```{r poverty_composition_exc}

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc) %>%
  summarise(total = sum(chwgt+wawgt),
            children = sum(chwgt),
            adults = sum(wawgt)) %>%
  mutate(children = percent(children/total, 1),
         adults = percent(adults/total, 1),
         total = percent(1, 1) ) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Composition of those in relative poverty")

```

```{r poverty_rates_exc}

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc) %>%
  summarise(total = sum(chwgt + wawgt),
            children = sum(chwgt),
            adults = sum(wawgt)) %>%
  mutate(total = percent(total/sum(total), 1),
         children = percent(children/sum(children), 1),
         adults = percent(adults/sum(adults), 1)) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc) %>%
  knitr::kable(align = "lrrrr", caption = "Proportion of individuals in relative poverty")


```


## by household type 

For this analysis, note that

a) we expect SHS poverty rates to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals to be at least as wide as the SHS-based confidence intervals.

```{r pov_hhtype}

SHS_pp_rate <- svyby(~low60bhc, ~hhtype, SHSdesign_pp, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, hhtype, rate, lower, upper)

tidydata %>%
  filter(type == "total",
         survey == "HBAI",
         pnwgt == 0) %>%
  group_by(hhtype) %>%
  mutate(allpeople = sum(ppwgt),
         sample = n()) %>%
  group_by(hhtype, low60bhc) %>%
  summarise(people = sum(ppwgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, hhtype, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(rate))) %>%
  ggplot(aes(x = hhtype, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by household type", 60),
       subtitle = str_wrap("Excludes households with pensioners; poverty is BHC; sample >= 100", 70))
  
```

## by economic status

For this analysis, note that

a) we expect SHS poverty rates in general to be slightly higher than HBAI poverty rates,
b) we expect HBAI-based confidence intervals to be at least as wide as the SHS-based confidence intervals,
c) self-employed incomes are higher in the SHS, and therefore contrary to a), we expect the poverty rate to be lower for this group, and
d) households who depend on benefits such as disability-related ones tend to underreport income in the SHS compared to the HBAI; we therefore expect poverty rates to be higher in the SHS for these groups.

```{r pov_eco}

SHS_pp_rate <- svyby(~low60bhc, ~HIHemp, SHSdesign_pp, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, HIHemp, rate, lower, upper)

tidydata %>%
  filter(type == "total",
         survey == "HBAI",
         pnwgt == 0) %>%
  group_by(HIHemp) %>%
  mutate(allpeople = sum(ppwgt),
         sample = n()) %>%
  group_by(HIHemp, low60bhc) %>%
  summarise(people = sum(ppwgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, HIHemp, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, desc(rate))) %>%
  ggplot(aes(x = HIHemp, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by economic status of household head", 60),
       subtitle = str_wrap("Excludes households with pensioners; poverty is BHC; sample >= 100", 70))
  
```

## by council area

For this analysis, note that

a) we expect SHS poverty rates in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals to be at least as wide as the SHS-based confidence intervals.

```{r pov_council, fig.asp = 0.9}

SHS_pp_rate <- svyby(~low60bhc, ~council, SHSdesign_pp, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, council, rate, lower, upper)

tidydata %>%
  filter(type == "total",
         survey == "HBAI",
         pnwgt == 0) %>%
  group_by(council) %>% 
  mutate(allpeople = sum(ppwgt),
         sample = n()) %>% 
  group_by(council, low60bhc) %>%
  summarise(people = sum(ppwgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%  
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, council, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, survey, desc(rate))) %>%
  ggplot(aes(x = council, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by council area", 60),
       subtitle = str_wrap("Excludes households with pensioners; poverty is BHC; sample >= 100", 70))
  
```

## by urban/rural area

For this analysis, note that

a) we expect SHS poverty rates in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals to be at least as wide as the SHS-based confidence intervals.

```{r pov_urb}

SHS_pp_rate <- svyby(~low60bhc, ~urbrur, SHSdesign_pp, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, urbrur, rate, lower, upper)

tidydata %>%
  filter(type == "total",
         survey == "HBAI",
         pnwgt == 0) %>%
  group_by(urbrur) %>%
  mutate(allpeople = sum(ppwgt),
         sample = n()) %>%
  group_by(urbrur, low60bhc) %>%
  summarise(people = sum(ppwgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, urbrur, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(urbrur = factor(urbrur),
         urbrur = fct_reorder2(urbrur, survey, desc(rate))) %>%
  ggplot(aes(x = urbrur, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by urban / rural area", 60),
       subtitle = str_wrap("Excludes households with pensioners; poverty is BHC; sample >= 100", 70))
  
```

## by tenure

For this analysis, note that

a) we expect SHS poverty rates in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals to be at least as wide as the SHS-based confidence intervals.

```{r pov_tenure}

SHS_pp_rate <- svyby(~low60bhc, ~tenure, SHSdesign_pp, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, tenure, rate, lower, upper)

tidydata %>%
  filter(type == "total",
         survey == "HBAI",
         pnwgt == 0) %>%
  group_by(tenure) %>%
  mutate(allpeople = sum(ppwgt),
         sample = n()) %>%
  group_by(tenure, low60bhc) %>%
  summarise(people = sum(ppwgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, tenure, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(tenure = factor(tenure),
         tenure = fct_reorder2(tenure, survey, desc(rate))) %>%
  ggplot(aes(x = tenure, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by tenure", 60),
       subtitle = str_wrap("Excludes households with pensioners; poverty is BHC; sample >= 100", 70))
  
```

# Annex 2: CiLIF and SHS - relative child poverty

Children in low-income families (CiLIF) is DWP and HMRC's new admin-data based local child poverty measure. CiLIF numbers of children in relative poverty were calibrated to match HBAI numbers broken down by UK region, work status, and family type.


```{r cilif_all}

allcilif <- cilif_council %>%
  summarise(CiLIF = sum(Cilif))

SHS_CI <- confint(svytotal(~low60bhc, SHSdesign_ch))

tidydata %>%
  filter(type == "total",
         low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(SHS = sum(chwgt)) %>%
  spread(survey, SHS) %>%
  cbind(allcilif) %>%
  mutate(CiLIF = comma(CiLIF),
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI[1], 10000),
                     "-",
                     comma(SHS_CI[2], 10000),
                     ")")) %>%
  knitr::kable(align = "rrr", caption = "Number of children in relative poverty")
  

```

By definition, the CiLIF figure matches the official child poverty estimate for Scotland (200,000 children), which comes from the HBAI. The HBAI estimate in the table above (190,000) however is based on a different poverty line (derived from Scottish data only) and a slightly different definition of household income (it excludes children's incomes and is not adjusted for top incomes).

## by family type


```{r cilif_hhtype}

svyby(~low60bhc, ~hhtype, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  filter(hhtype %in% c("Single adult with children", "Two adults with children")) %>%
  left_join(cilif_hhtype, by = "hhtype") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(hhtype, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

## by work status

Note that the term 'working' refers to paid work.

```{r cilif_eco}

svyby(~low60bhc, ~work, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_work, by = "work") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(work, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

## by council area

```{r cilif_council, fig.asp = 0.8}

cp <- tidydata %>%
  filter(type == "total",
         survey == "SHS",
         pnwgt == 0) %>%
  group_by(council) %>%
  mutate(allchildren = sum(chwgt),
         sample = n()) %>%
  group_by(council, low60bhc) %>%
  mutate(samplepov = ifelse(low60bhc == 1, sum(n()), 0)) %>%
  ungroup() %>%
  filter(samplepov >= 30)

cpnumbers <- svyby(~low60bhc, ~council, SHSdesign_ch, svytotal, vartype=c("ci","ci"))
  
cilifcomparison <- cpnumbers %>%
  left_join(cilif_council, by = "council") %>%
  mutate(council = fct_reorder(council, Cilif)) %>%
  rename(SHS = low60bhc ) %>%
  gather(source, children, -council,  -ci_l, -ci_u) %>%
  arrange(source)

corr <- cor.test(cilifcomparison$children[1:(length(cilifcomparison$children)/2)], cilifcomparison$children[(1+length(cilifcomparison$children)/2):length(cilifcomparison$children)], method=c("pearson", "kendall", "spearman"))

Pearson <- corr$estimate

cilifcomparison %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, source, desc(children))) %>%
  ggplot(aes(x = council, y = children, colour = source)) +
  geom_point(aes(size = source)) +
  geom_errorbar(data = filter(cilifcomparison, source == "SHS"),
                aes(ymin = ci_l,
                    ymax = ci_u)) +
  coord_flip() +
  scale_colour_manual(values = wes_palettes[["Moonrise2"]]) +
  scale_size_manual(values = c(3,2)) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Number of children in relative poverty BHC by council, SHS and CiLIF", 60),
       subtitle = str_wrap("Excludes council areas with SHS samples (in poverty) < 30", 70)) +
  annotate("text", x = 3, y = Inf, label = str_c("Pearson correlation: ", percent(Pearson, 0.1)), hjust = 1)

```

## by urban/rural area

```{r cilif_urbrur}

cilif_urbrur <- cilif_urbrur %>%
  mutate(urbrur = ifelse(urbrur %in% c("Accessible Small Towns", "Remote Small Towns"), "Small Towns",
                         ifelse(urbrur %in% c("Accessible Rural", "Remote Rural"), "Rural", urbrur))) %>%
  group_by(urbrur) %>%
  summarise(Cilif = sum(Cilif))


svyby(~low60bhc, ~urbrur, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_urbrur, by = "urbrur") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(urbrur, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

<!-- # Other comparisons - don't include in paper -->

<!-- Comparing SHS income with SIMD quintile, financial management perception, material deprivation -->

<!-- ## with SIMD -->

<!-- Should this be SIMD income domain? -->

<!-- ```{r cpov_simd_ci} -->

<!-- cp <- tidydata %>% -->
<!--   filter(type == "total", -->
<!--          survey == "SHS", -->
<!--          pnwgt == 0) %>% -->
<!--   mutate(simd = factor(simd), -->
<!--          simdquint = fct_collapse(simd,  -->
<!--                              "1" = c("1","2"), -->
<!--                              "2" = c("3", "4"), -->
<!--                              "3" = c("5", "6"), -->
<!--                              "4" = c("7", "8"), -->
<!--                              "5" = c("9", "10"))) %>% -->
<!--   group_by(simdquint) %>% -->
<!--   mutate(allchildren = sum(chwgt), -->
<!--          sample = n()) %>% -->
<!--   ungroup() -->

<!-- SHSdesign <- svydesign(id = ~1, strata = ~council, weights = ~chwgt, data = cp, fpc = ~allchildren) -->

<!-- cprates <- svyby(~low60bhc, ~simdquint, SHSdesign, svymean, vartype=c("se","ci","ci")) -->

<!-- cprates %>% -->
<!--  ggplot(aes(x = simdquint, y =  low60bhc, ymin = ci_l, ymax = ci_u)) + -->
<!--   geom_point() + -->
<!--   geom_errorbar() + -->
<!--   geom_text(aes(y = 0.6, label = str_c(percent(low60bhc, 1), " (", percent(ci_l, 1), "-", percent(ci_u, 1), ")")), -->
<!--             hjust = 0) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "Proportion of children in relative poverty BHC by SIMD quintile", -->
<!--        subtitle = "Excludes households with pensioners") + -->
<!--   scale_y_continuous(limits = c(-0.1, 0.8), labels = NULL) + -->
<!--   coord_flip() -->

<!-- ``` -->

<!-- ## with perception of own financial management -->

<!-- ```{r managing_financially_pov_exc} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS", -->
<!--          type == "total", -->
<!--          !is.na(finman), -->
<!--          pnwgt == 0) %>% -->
<!--   group_by(low60bhc, finman) %>% -->
<!--   summarise(fm = sum(ppwgt)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(low60bhc) %>% -->
<!--   mutate(people = sum(fm), -->
<!--          fmrate = fm/people) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(low60bhc = factor(low60bhc)) %>% -->
<!--   ggplot(aes(x = low60bhc, y = fmrate, fill = finman)) +  -->
<!--   geom_col(position = "stack", colour = "white") + -->
<!--   coord_flip() + -->
<!--   scale_x_discrete(labels = c("Not in poverty", "In poverty")) + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   scale_fill_manual(values = cols_finman) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How households are managing financially by poverty status", -->
<!--        subtitle = "Excludes households with pensioners, but income deciles based on all households") + -->
<!--   theme(legend.position = "right") -->

<!-- ``` -->

<!-- ```{r managing_financially_exc} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS", -->
<!--          type == "total", -->
<!--          !is.na(finman), -->
<!--          pnwgt == 0) %>% -->
<!--   group_by(decile, finman) %>% -->
<!--   summarise(fm = sum(ppwgt)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(decile) %>% -->
<!--   mutate(people = sum(fm), -->
<!--          fmrate = fm/people) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(decile = factor(decile)) %>% -->
<!--   ggplot(aes(x = decile, y = fmrate, fill = finman)) +  -->
<!--   geom_col(position = "stack", colour = "white") + -->
<!--   coord_flip() + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   scale_fill_manual(values = cols_finman) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How households are managing financially by income decile", -->
<!--        subtitle = "Excludes households with pensioners, but income deciles based on all households") + -->
<!--   theme(legend.position = "right") -->

<!-- ``` -->

<!-- ## with material deprivation -->

<!-- ```{r matdep} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS", -->
<!--          type == "total", -->
<!--          pnwgt == 0) %>% -->
<!--   group_by(decile, md) %>% -->
<!--   summarise(mdhh = sum(hhwgt)) %>% -->
<!--   group_by(decile) %>% -->
<!--   mutate(allhouseholds = sum(mdhh), -->
<!--          rate = mdhh/allhouseholds, -->
<!--          md = factor(md, levels = c(0:8), labels = c("Can afford all",  -->
<!--                                                      "Cannot afford 1 or 2 items",  -->
<!--                                                      "Cannot afford 1 or 2 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 6-8 items",  -->
<!--                                                      "Cannot afford 6-8 items",  -->
<!--                                                      "Cannot afford 6-8 items"))) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(decile = factor(decile)) %>% -->
<!--   ggplot(aes(x = decile, y = rate, fill = md)) + -->
<!--   geom_col() + -->
<!--   scale_fill_manual(values = cols_finman[3:6]) + -->
<!--   coord_flip() + -->
<!--   theme(legend.position = "right") + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How many basic necessities households cannot afford by income decile", -->
<!--        subtitle = "Excludes households with pensioners, but income deciles based on all households")  -->

<!-- ``` -->



