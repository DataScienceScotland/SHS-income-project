---
title: "SHS income project - poverty"
output: 
  html_notebook:
    code_folding: hide
    number_sections: yes
    toc: yes
    
editor_options: 
  chunk_output_type: inline
---


```{r setup, include = FALSE}

# Set global chunk options

knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.5)

# Load packages

library(plyr) # needed for groupwiseMedian function
library(tidyverse)
library(naniar) # for dealing with missing values
library(labelled) # to remove labels from imported data
library(scales) # for comma and percent formats
library(ggrepel) # for non-overlapping chart annotation
library(Hmisc) # for weighted quartiles
library(boot) # needed for groupwiseMedian function
library(readxl)

# Load functions

source("scr/functions.R")

# Load colour scheme and other strings

source("scr/strings.R")
source("scr/colours.R")

# Load datasets

adult_1819 <- readRDS("output/adult_1819.rds")
househol_1819 <- readRDS("output/househol_1819.rds")
benefits_1819 <- readRDS("output/benefits_1819.rds")
hbai1819 <- readRDS("output/hbai1819.rds")
person18 <- readRDS("output/person18.rds")
hhold18 <- readRDS("output/hhold18.rds")

# Create tidy datasets

source("scr/prepSHSdata.R")
source("scr/prepHBAIdata.R")

# Combine all data

source("scr/prepdata.R")

# Change some theme elements (charts)

theme_update(legend.position = "top",
             legend.title = element_blank(),
             panel.background = element_blank(),
             panel.grid.major.x = element_line(colour = "grey95"),
             panel.grid.minor.x = element_line(colour = "grey95"),
             panel.grid.major.y = element_line(colour = "grey95"),
             axis.ticks = element_blank(),
             text = element_text(size=16))

```

# Characteristics of low income households

We may understand now the differences in income measured in SHS and FRS. So what does that mean for poverty? Do SHS and FRS identify the same kind of households as being in poverty?

## Household characteristics

Hhld type (working-age/pensioners, children, number of adults), economic status, tenure, ethnicity(?)

Responses to financial questions & matdep questions?

```{r poverty_numbers}

tidydata %>%
  filter(type == "total") %>%
  group_by(survey, low60bhc) %>%
  summarise(people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt),
            pensioners = sum(pnwgt)) %>%
  mutate(pprate = people/sum(people),
         chrate = children/sum(children),
         warate = waadults/sum(waadults),
         pnrate = pensioners/sum(pensioners),
         chcomp = children/people,
         wacomp = waadults/people,
         pncomp = pensioners/people) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc, -children, -waadults, -pensioners) %>%
  gather(key, value, -survey) %>%
  mutate(measure = ifelse(key %in% c("people", "children", "waadults", "pensioners"), "Number",
                          ifelse(key %in% c("pprate", "chrate", "warate", "pnrate"), "Rate",
                                 "Composition")),
         key = ifelse(str_starts(key, "pp"), "people", 
                      ifelse(str_starts(key, "ch"), "children", 
                             ifelse(str_starts(key, "wa"), "waadults", 
                                    ifelse(str_starts(key, "pn"), "pensioners", key))))) %>%
  mutate(key = factor(key, levels = c("people", "children", "waadults", "pensioners")),
         key = fct_rev(key),
         measure = factor(measure, levels = c("Number", "Composition", "Rate"))) %>%
  ggplot(aes(x = key, y = value, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = ifelse(measure == "Number", comma(value, 10000), percent(value, 1)),
                y = ifelse(measure == "Number", 20000, 0.01)),
            position = position_dodge(width = 1),
            hjust = 0,
            colour = "white") +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank(),
        axis.ticks = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Numbers, composition, and rates of individuals in relative poverty BHC",
       subtitle = "Assuming Scottish, survey-specific poverty thresholds") +
    coord_flip() +
  facet_wrap(~measure, scales = "free")


```


```{r poverty_numbers_excl_pn}

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc) %>%
  summarise(people = sum(ppwgt),
            children = sum(chwgt),
            waadults = sum(wawgt)) %>%
  mutate(pprate = people/sum(people),
         chrate = children/sum(children),
         warate = waadults/sum(waadults),
         chcomp = children/people,
         wacomp = waadults/people) %>%
  filter(low60bhc == 1) %>%
  select(-low60bhc, -children, -waadults) %>%
  gather(key, value, -survey) %>%
  mutate(measure = ifelse(key %in% c("people", "children", "waadults"), "Number",
                          ifelse(key %in% c("pprate", "chrate", "warate"), "Rate",
                                 "Composition")),
         key = ifelse(str_starts(key, "pp"), "people", 
                      ifelse(str_starts(key, "ch"), "children", 
                             ifelse(str_starts(key, "wa"), "waadults", key)))) %>%
  mutate(key = factor(key, levels = c("people", "children", "waadults")),
         key = fct_rev(key),
         measure = factor(measure, levels = c("Number", "Composition", "Rate"))) %>%
  ggplot(aes(x = key, y = value, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = ifelse(measure == "Number", comma(value, 10000), percent(value, 1)),
                y = ifelse(measure == "Number", 20000, 0.01)),
            position = position_dodge(width = 1),
            hjust = 0,
            colour = "white") +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank(),
        axis.ticks = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Numbers, composition, and rates of individuals in relative poverty BHC",
       subtitle = "Excluding pensioner hhlds; assuming Scottish, survey-specific poverty thresholds") +
    coord_flip() +
  facet_wrap(~measure, scales = "free")


```


```{r poverty_hhtype_excl_pn}

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc, hhtype) %>%
  summarise(people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey, hhtype) %>%
  mutate(rate = people/sum(people)) %>%
  filter(low60bhc == 1) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(comp = people/sum(people)) %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames),
         hhtype = fct_rev(hhtype)) %>%
  ggplot(aes(x = hhtype, y = comp, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(y = comp + 0.02,
                label = percent(comp, 1),
                colour = survey),
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Composition of people in relative poverty BHC by household type",
       subtitle = "Excluding pensioners; assuming Scottish, survey-specific poverty thresholds") +
  coord_flip()

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc, hhtype) %>%
  summarise(people = sum(ppwgt)) %>%
  ungroup() %>%
  group_by(survey, hhtype) %>%
  mutate(rate = people/sum(people)) %>%
  filter(low60bhc == 1) %>%
  ungroup() %>%
  group_by(survey) %>%
  mutate(comp = people/sum(people)) %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames),
         hhtype = fct_rev(hhtype)) %>%
  ggplot(aes(x = hhtype, y = rate, fill = survey)) +
  geom_col(position = "dodge") +
  geom_text(aes(y = rate + 0.02,
                label = percent(rate, 1),
                colour = survey),
            position = position_dodge(width = 1)) +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Relative poverty rates BHC",
       subtitle = "Excluding pensioners; assuming Scottish, survey-specific poverty thresholds") +
  coord_flip()

tidydata %>%
  filter(type == "total",
         pnwgt == 0) %>%
  group_by(survey, low60bhc, hhtype) %>%
  summarise(people = sum(ppwgt)) %>%
  filter(low60bhc == 1) %>%
  ungroup() %>%
  mutate(hhtype = factor(hhtype, levels = hhtypenames),
         hhtype = fct_rev(hhtype)) %>%
  ggplot(aes(x = hhtype, y = people, fill = survey)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = cols_survey) +
  scale_colour_manual(values = cols_survey) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        axis.text.x = element_blank()) +
  labs(x = NULL, y = NULL,
       title = "Number of people in relative poverty rates BHC",
       subtitle = "Excluding pensioners; assuming Scottish, survey-specific poverty thresholds") +
  coord_flip()

```


## Area characteristics

LA, urban/rural, SIMD deciles (??)

```{r pov_council_numbers, fig.asp = 0.8}

cilif <- read_excel("ext/docs/Cilif.xlsx") 
  
cilifcomparison <- tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(council, low60bhc) %>%
  summarise(SHS = sum(chwgt),
            sample = n()) %>%
  ungroup() %>%
  filter(low60bhc == 1) %>%
  select(council, SHS, sample ) %>%
  left_join(cilif, by = "council") %>%
  mutate(council = fct_reorder(council, Cilif)) %>%
  gather(source, children, -council, -sample)  %>%
  arrange(source)

cilifcomparison %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = council, y = children, fill = source)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(values = wes_palettes[["Moonrise2"]]) +
  labs(x = NULL, y = NULL,
       title = "Number of children in relative poverty BHC by council, SHS, and Cilif")

cor.test(cilifcomparison$children[1:32], cilifcomparison$children[33:64], method=c("pearson", "kendall", "spearman"))

```

```{r pov_council_rates, fig.asp = 0.8}

tidydata %>%
  filter(type == "total",
         survey == "SHS") %>%
  group_by(council, low60bhc) %>%
  summarise(children = sum(chwgt),
            sample = n()) %>%
  ungroup() %>%
  group_by(council) %>%
  mutate(chrate = children/sum(children)) %>%
  filter(low60bhc == 1) %>%
  ungroup() %>%
  mutate(council = fct_reorder(council, chrate)) %>%
  filter(sample >= 50) %>%
  ggplot(aes(x = council, y = chrate)) +
  geom_col() +
  coord_flip()

```