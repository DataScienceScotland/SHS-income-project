---
title: "SHS income project - 2nd interim report"
output:
  word_document:
    reference_docx: template.docx
    toc: yes
    toc_depth: 1
---

```{r setup, include = FALSE}

# Set global chunk options

knitr::opts_chunk$set(fig.width = 10, fig.asp = 0.5, 
                      echo = FALSE,
                      warning = FALSE)

# load data

source("scr/prepPovertydata.R")

```

# Project summary

The SHS income project is about assessing how accurately the Scottish Household Survey (SHS) measures household income, by comparing SHS data to data from Household Below Average Incomes (HBAI), the “gold standard” for household income data in the UK. 

The **purpose of the project** is to understand whether SHS income data is accurate enough to allow household income and poverty analysis in Scotland where this is not possible using the HBAI or administrative data sources. For example, income and poverty analysis in Scotland is not possible with HBAI or admin data for certain subgroups of the population where the HBAI sample is too small, and where these subgroups are not identified in the administrative data. This is also the case for a wide range of contexts which are not covered or not covered in as much detail in the HBAI or admin data, such as travel patterns, social capital, satisfaction with services, house condition, digital inclusion and financial inclusion.

It should be noted that by undertaking this work, we are not proposing a wholesale shift in reporting income and poverty statistics from HBAI to SHS income data; the HBAI will remain the main source of national (Scotland-level) poverty and household income statistics, with SHS statistics providing supplementary income and poverty analysis where not available from HBAI or administrative data.

The **scope of the project** is to assess the accuracy of the new SHS income variable, and whether it measures income accurately enough to produce poverty estimates. Further improvements of the income variable are not in scope; however, we are making suggestions to the SHS team for potential improvements.

The **stages of the project** are as follows:

- We shared the project initiation document in early May 2020. 
- The 1st interim report, containing detailed income analysis, was shared on 30 July 2020, with detailed comments received from Ailie Clarkson and Nick Bailey. 
- This is the 2nd interim report, which summarises the previous work and provides new analysis comparing poverty estimates based on SHS data with HBAI and administrative data.
- A final project report will describe the analysis undertaken and the conclusions drawn in terms of strengths and limitations of the SHS income data.

# Income analysis summary

In the 1st interim report (shared on 30 July), we compared net household income data from the SHS 2018 with that from the HBAI 2018/19 by looking at the main income components as well as total income. Below is the summary of our findings and the implications.

We found that overall, average earnings were reasonably similar between surveys, with SHS earnings slightly higher than HBAI earnings. Note though that for lower household incomes, SHS earnings were slightly lower than HBAI earnings. While average earnings for households with employed household heads were comparable between the two surveys, earnings for the small number of households with a self-employed head were much higher in the SHS compared to the HBAI, probably due to differences in survey methodology.

Earnings determine total income of employed and self-employed households, the majority of households in Scotland. For example, households where the head is employed have fairly consistent earnings levels across the two surveys, and therefore their total income also matches well. In contrast, households with a self-employed head show very different earnings levels in the two surveys, and therefore also very different income levels.

Average benefit income was consistently lower in the SHS compared to the HBAI, due to underreporting and non-reporting of benefits. The impact of under- and non-reporting of the State Pension dwarfed the impact of all other (also underreported) benefits and thereby affected almost all pensioner households. Underreporting of disability benefits affected households where these benefits are a major or the main income source, such as those who are economically inactive due to disability or long-term illness.

Benefit income drives total income of economically inactive and unemployed households. For example, pensioners’ incomes largely consist of the State Pension and to a smaller degree, occupational pensions. Both are considerably lower in the SHS, and therefore total income of pensioners is lower. Similarly, a large part of total income of households with a disabled household head come from disability-related benefits, which are equally much lower in the SHS, resulting in too low total incomes.

The total income distribution is similar for both surveys, although the SHS distribution is slightly wider than the HBAI equivalent. As a result, a larger proportion of the population sit below the SHS poverty threshold in the SHS income distribution.

Within the limited means of comparing regional incomes between surveys, we found no indication that there were any local areas with particularly large income discrepancies, and no reason to expect any.

In conclusion, incomes between SHS and HBAI compare reasonably well, and we believe that the SHS produces very good income estimates considering its wide remit. However, there are some types of households where income estimates are problematic due to underreporting of benefits and differences in self-employed earnings: The largest group among them are pensioner households; other groups are households that are economically inactive due to disability, and households with a self-employed household head.

The implications of the findings for poverty measurement are as follows:

- SHS income data enables us to calculate robust before housing costs (BHC) poverty rates. These will be higher than those based on the HBAI due to the shape of the income distribution and due to pensioners’ incomes which are too low.
- The differences between poverty estimates based on different surveys always need to be clearly communicated when publishing any estimates.
- It might also be best to exclude pensioners from any SHS based poverty analysis.
- Furthermore, when disaggregating statistics by economic status, one should be aware that poverty of self-employed households may be underestimated.
- And finally, regional poverty breakdowns should be possible where sample sizes allow, although it would be advisable to always include some measure of uncertainty.

The members of the QA group found that the income analysis undertaken was thorough, they considered the findings plausible, and agreed with the conclusions. There were a number of comments relating to how the SHS income data could be improved using imputation (council tax, state pension, disability benefits) and the suggestion to allow negative self-employed earnings responses in the SHS, consistent with HBAI.

# Poverty analysis summary

This section summarises the poverty analysis in the [Annex][ANNEX].

We compared relative poverty estimates before housing costs (BHC) that are based on SHS income data with those based on HBAI income data^[In contrast to the income analysis shared previously, the HBAI income variable used here is the 'standard' income used in official statistics, and the HBAI poverty threshold is based on the UK median.] and CiLIF data (Children in low-income families)^[https://www.gov.uk/government/publications/children-in-low-income-families-local-area-statistics-background-information-and-methodology/background-information-and-methodology-children-in-low-income-families-local-area-statistics]. CiLIF is DWP and HMRC's new admin-data based local child poverty measure. CiLIF numbers of children in relative poverty were calibrated to match (three-year-averaged) HBAI numbers broken down by UK region, work status, family type, and child age.

## SHS and HBAI {-}

While we would expect poverty rates and numbers to differ slightly when using different data sources, we need to test that the SHS and HBAI identify the same household characteristics to be associated with a high (and a low) poverty risk. As we will show, this is the case.

We found that more people are in poverty in the SHS compared to the HBAI. This is largely driven by pensioners, whose poverty risk is exaggerated in the SHS (as discussed in the [Income analysis summary][Income analysis summary]). However, we also have slightly more working-age adults and children in poverty in the SHS than in the HBAI, and similarly, higher poverty rates. The composition of children and working-age adults in poverty is similar across surveys.

Disaggregating the Scottish child and working-age population by household type, economic status, tenure, council area (where available) and urban/rural area shows good agreement between SHS and HBAI. While poverty rates are generally slightly higher in the SHS, those groups of the population who have an elevated poverty risk in the HBAI also have an elevated poverty risk in the SHS. 

While there is generally good agreement in the disaggregated poverty estimates between surveys, there are some discrepancies when disaggregating by economic status. These were expected and can be explained by the income data quality issues identified in the SHS income analysis: benefit underreporting contributes to fairly large differences in poverty rates between SHS and HBAI for inactive and retired households^[Poverty rates for retired, disabled and other inactive households are considerably higher in the SHS, but no significance testing was undertaken.], and similarly, the higher self-employed incomes in the SHS lead to much lower poverty rates in the SHS compared to the HBAI for this group.

All other discrepancies between disaggregated groups in the SHS and HBAI are likely to be within the measurement uncertainty of the two surveys, with the SHS poverty rates generally slightly higher than the HBAI poverty rate.

## SHS and CiLIF {-}

SHS and CiLIF child poverty estimates for all children also match well. We therefore expect child poverty numbers to be comparable as well in the disaggregated data that follows.

Disaggregating child poverty numbers by family type, family work status, council area and urban/rural area shows very good agreement between SHS and CiLIF numbers. There are only two discrepancies: the number of children in poverty who live in non-working families (more children in poverty in the SHS), and those who live in East Renfrewshire (fewer children in poverty in the SHS). Non-working families are likely to depend on benefits, which are underreported in the SHS. This contributes to the higher numbers in poverty in the SHS. There is no obvious reason for East Renfrewhsire to have fewer children in poverty in the SHS, but the estimate is based on only 40 cases and may not less robust than those for larger council areas.

The implications of all findings for poverty measurement are as follows:

- The SHS income variable can produce reliable (BHC) poverty estimates for children and working-age adults, although some care needs to be taken when looking specifically at economically inactive or self-employed households.
- SHS-based poverty estimates differ from the Official Statistics and can therefore not be compared directly
- Guidance is required that clearly explains when to use which data source, with the Official Statistics taking priority over SHS-based poverty estimates.

# Project conclusions

The income and poverty analyses lead to the following conclusions:

1. The SHS income variable compares reasonably well with HBAI income, and produces very good income estimates considering the wide remit of the survey.
2. The SHS income variable produces reliable BHC poverty estimates for children and working-age adults, although care needs to be taken when looking specifically at economically inactive or self-employed households.
3. SHS-based regional poverty breakdowns are possible where sample sizes allow, although it would be advisable to always include some measure of uncertainty.
4. It might be best to exclude pensioners from any SHS-based income and poverty analysis until state pension reporting is improved.
5. SHS-based income and poverty estimates differ from the Official Statistics and can therefore not be compared directly; this needs to be highlighted and differences explained in any publications using this data.
6. Guidance is required that clearly explains when to use which data source, with the Official Statistics followed by CiLIF taking priority over SHS-based poverty estimates.

We also have the following suggestions for the SHS:

- Continue to collect income data from all adults
- Consider allowing negative incomes for self-employed people
- Impute council tax and add variable to the SHS dataset
- Review how State Pension data is collected in the SHS, and whether changes to the questionnaire wording or data editing / imputation routines may improve the data quality for this key benefit

And finally, further work (outwith the scope of this project) could be done in these areas:

- Housing costs: The SHS includes a housing cost variable which could be used to produce after housing cost (AHC) income and poverty measures. There are some differences between surveys in what is considered a housing cost. The main difference affects home owners with a mortgage: While the HBAI considers the mortgage interest a housing cost but not capital repayments, the SHS includes both. Either method has merit, but each will lead to a quite different result for these households: We expect housing costs for home owners with a mortgage to be higher in the SHS compared to the HBAI; therefore AHC poverty will be higher for this group as well. Further work might involve a comparison of housing costs across surveys, investigating the impact of the different definitions on AHC poverty estimates, and finding ways to clearly communicate the differences between HBAI- and SHS-based housing costs.
-	Self-employed earnings: Self-employed earnings are much higher in the SHS compared to the HBAI. Checking with SHS data from previous years shows that this high level of self-employed earnings is consistent across years. The difference between surveys could be caused by questionnaire wording, survey time spent on self-employed earnings, or different definitions of self-employment. Further work could investigate the causes of the difference further.

# Next steps

The final output from this project is a report of the analysis undertaken to understand the quality of the SHS income variable and the conclusions drawn in terms of strengths and limitations of SHS income and poverty estimates. Within the final report, brief guidance will explain how poverty analysis based on the SHS income variable is expected to differ from official statistics and why, and when to use SHS income data rather than the conventional, more robust income datasets. A non-technical summary of the report will be provided as well.

**The QA group is invited to give their final comments on the analysis undertaken, the conclusions drawn, and the suggestions for improving the SHS.**

# ANNEX

## HBAI and SHS - relative poverty

In the analysis that follows, we compare SHS-derived poverty estimates (SHS 2018 data) to HBAI-derived poverty estimates (HBAI 2018/19 data)^[While the different reporting periods may contribute to differences in the income distributions, we expect this contribution to be small compared to, for example, questionnaire differences.]. Note that we use the standard HBAI poverty definition which is based on UK median income^[The 'standard' HBAI income variable is used to produce official income and poverty statistics. It differs in two important ways from the SHS income variable: First, in includes children's incomes, and second, it is adjusted for top incomes underreporting.] and the standard HBAI income variable (as opposed to the more comparable HBAI income variable that was used in the detailed income analysis done previously). The SHS-based poverty estimates are based on Scottish median income.

Ranges show the 95% confidence intervals for SHS-based estimates. We did not calculate the equivalent HBAI confidence intervals but they are likely to be wider, as they are based on smaller samples.

The tables below show that there are more people in poverty in the SHS compared to the HBAI. This is largely driven by pensioners, whose poverty risk is exaggerated in the SHS (as discussed in [Income analysis summary][Income analysis summary]). However, if we exclude pensioners, we still have slightly more^[When comparing central estimates, more people are in relative poverty in the SHS than the HBAI. While we cannot accurately calculate uncertainty estimates for HBAI data, we don't expect the differences for working-age adults and children to be statistically significant. We expect uncertainty around HBAI-based estimates to be at least as large as uncertainty around SHS-based estimates, as sample sizes are smaller in the HBAI.] working-age adults and children in poverty in the SHS than in the HBAI. We therefore also expect slightly higher poverty rates in the SHS in the analysis that follows.

```{r poverty_numbers}

SHS_CI_ch <- confint(svytotal(~low60bhc, SHSdesign_ch))
SHS_CI_wa <- confint(svytotal(~low60bhc, SHSdesign_wa))
SHS_CI_pn <- confint(svytotal(~low60bhc, SHSdesign_pn))
SHS_CI_pp <- confint(svytotal(~low60bhc, SHSdesign_pp))

ch <- tidydata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(children = sum(chwgt)) %>%
  spread(survey, children) %>%
  mutate(group = "Children",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_ch[1], 10000),
                     "-",
                     comma(SHS_CI_ch[2], 10000),
                     ")")) 

wa <- tidydata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(adults = sum(wawgt)) %>%
  spread(survey, adults) %>%
  mutate(group = "Working-age adults",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_wa[1], 10000),
                     "-",
                     comma(SHS_CI_wa[2], 10000),
                     ")")) 

pn <- tidydata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(pensioners = sum(pnwgt)) %>%
  spread(survey, pensioners) %>%
  mutate(group = "Pensioners",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_pn[1], 10000),
                     "-",
                     comma(SHS_CI_pn[2], 10000),
                     ")")) 

pp <- tidydata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(total = sum(ppwgt)) %>%
  spread(survey, total) %>%
  mutate(group = "Total",
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI_pp[1], 10000),
                     "-",
                     comma(SHS_CI_pp[2], 10000),
                     ")")) 

rbind(ch, wa, pn, pp) %>%
  select(group, HBAI, SHS) %>%
  knitr::kable(align = "lrr", caption = "Numbers in relative poverty")

```

**Pensioners are excluded from the analysis that follows.** 

```{r poverty_rates_exc}

ch <- svymean(~low60bhc, SHSdesign_ch)[[1]]
ch_lower <- confint(svymean(~low60bhc, SHSdesign_ch))[[1]]
ch_upper <- confint(svymean(~low60bhc, SHSdesign_ch))[[2]]

wa <- svymean(~low60bhc, SHSdesign_wa)[[1]]
wa_lower <- confint(svymean(~low60bhc, SHSdesign_wa))[[1]]
wa_upper <- confint(svymean(~low60bhc, SHSdesign_wa))[[2]]

pp <- svymean(~low60bhc, SHSdesign_chwa)[[1]]
pp_lower <- confint(svymean(~low60bhc, SHSdesign_chwa))[[1]]
pp_upper <- confint(svymean(~low60bhc, SHSdesign_chwa))[[2]]
   
SHS <- tribble(
  ~group, ~rate, ~lower, ~upper,
  "Children", ch, ch_lower, ch_upper,
  "Working-age adults", wa, wa_lower, wa_upper,
  "Total", pp, pp_lower, pp_upper) 

SHS <- SHS %>%
  mutate(SHS = str_c(percent(rate, 1), " (", percent(lower, 1), "-", percent(upper, 1), ")" )) %>%
  select(group, SHS)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(low60bhc) %>%
  summarise(children = sum(chwgt),
            adults = sum(wawgt),
            total = sum(ppwgt)) %>%
  mutate(chrate = children/sum(children),
         warate = adults/sum(adults),
         pprate = total/sum(total))  %>%
  filter(low60bhc == 1) %>%
  select(chrate, warate, pprate) %>%
  gather(group, HBAI) %>%
  mutate(group = ifelse(group == "chrate", "Children", 
                        ifelse(group == "warate", "Working-age adults", "Total")),
         HBAI = percent(HBAI, 1)) %>%
  left_join(SHS, by = "group") %>%
  knitr::kable(align = "lrr", caption = "Relative poverty rates (excluding pensioners)")

```

```{r poverty_comp_exc}

tidydata %>%
  filter(survey != "Admin") %>%
  group_by(survey, low60bhc) %>%
  summarise(children = sum(chwgt),
            adults = sum(wawgt),
            total = sum(chwgt + wawgt)) %>%
  filter(low60bhc == 1) %>%
  mutate(ch = children/total,
         ad = adults/total,
         all = 1) %>%
  select(survey, ch, ad, all) %>%
  gather(group, comp, -survey) %>%
  spread(survey, comp) %>%
  arrange(HBAI) %>%
  mutate(group = ifelse(group == "ch", "Children", 
                        ifelse(group == "ad", "Working-age adults", "Total")),
         HBAI = percent(HBAI, 1),
         SHS = percent(SHS, 1)) %>%
  
  knitr::kable(align = "lrr", caption = "Composition of groups in relative poverty (excluding pensioners)")

```

### by household type 

For this analysis, note that

a) we expect SHS poverty rates (central estimates) to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_hhtype}

SHS_pp_rate <- svyby(~low60bhc, ~hhtype, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, hhtype, rate, lower, upper)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(hhtype) %>%
  mutate(allpeople = sum(chwgt+wawgt),
         sample = n()) %>%
  group_by(hhtype, low60bhc) %>%
  summarise(people = sum(chwgt+wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, hhtype, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(hhtype = factor(hhtype),
         hhtype = fct_reorder2(hhtype, survey, desc(rate))) %>%
  filter(hhtype != "Two pensioners",
         hhtype != "Single pensioner") %>%
  ggplot(aes(x = hhtype, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by household type", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))
  
```

### by economic status 

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates,
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals,
c) self-employed incomes are higher in the SHS, and therefore contrary to a), we expect the poverty rate to be lower for this group, and
d) households who depend on benefits such as disability-related ones tend to underreport income in the SHS compared to the HBAI; we therefore expect poverty rates to be higher in the SHS for these groups.

```{r pov_eco}

SHS_pp_rate <- svyby(~low60bhc, ~HIHemp, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, HIHemp, rate, lower, upper)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(HIHemp) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(HIHemp, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, HIHemp, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(HIHemp = factor(HIHemp),
         HIHemp = fct_reorder2(HIHemp, survey, desc(rate))) %>%
  ggplot(aes(x = HIHemp, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_size_manual(values = c(3, 2)) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by economic status of household head", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))
  
```

### by council area 

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_council, fig.asp = 0.9}

SHS_pp_rate <- svyby(~low60bhc, ~council, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, council, rate, lower, upper)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(council) %>% 
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>% 
  group_by(council, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%  
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, council, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, survey, desc(rate))) %>%
  ggplot(aes(x = council, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by council area", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))
  
```

### by urban/rural area 

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_urb}

SHS_pp_rate <- svyby(~low60bhc, ~urbrur, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, urbrur, rate, lower, upper)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(urbrur) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(urbrur, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, urbrur, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(urbrur = factor(urbrur),
         urbrur = fct_reorder2(urbrur, survey, desc(rate))) %>%
  ggplot(aes(x = urbrur, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by urban / rural area", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 60))
  
```

### by tenure 

For this analysis, note that

a) we expect SHS poverty rates (central estimates) in general to be slightly higher than HBAI poverty rates, and
b) we expect HBAI-based confidence intervals (not calculated) to be at least as wide as the SHS-based confidence intervals.

```{r pov_tenure}

SHS_pp_rate <- svyby(~low60bhc, ~tenure, SHSdesign_chwa, svymean, vartype=c("ci","ci")) %>%
    mutate(rate = low60bhc,
         lower =ci_l,
         upper = ci_u,
         survey = "SHS") %>%
  select(survey, tenure, rate, lower, upper)

tidydata %>%
  filter(survey == "HBAI") %>%
  group_by(tenure) %>%
  mutate(allpeople = sum(chwgt + wawgt),
         sample = n()) %>%
  group_by(tenure, low60bhc) %>%
  summarise(people = sum(chwgt + wawgt),
            allpeople = max(allpeople),
            sample = max(sample)) %>%
  ungroup() %>%
  filter(low60bhc == 1,
         sample >= 100) %>%
  mutate(survey = "HBAI",
         rate = people/allpeople) %>%
  select(survey, tenure, rate) %>%
  bind_rows(SHS_pp_rate) %>%
  mutate(tenure = factor(tenure),
         tenure = fct_reorder2(tenure, survey, desc(rate))) %>%
  ggplot(aes(x = tenure, y = rate, colour = survey, ymin = lower, ymax = upper)) +
  geom_point(aes(size = survey),
             show.legend = FALSE) +
  geom_errorbar() +
  geom_text(aes(y = Inf, 
                label = ifelse(survey == "SHS",
                               str_c(percent(rate, 1)," (", percent(lower, 1), "-", percent(upper, 1), ")"), 
                               NA)),
            hjust = 1,
            show.legend = FALSE) +
  coord_flip() +
  scale_colour_manual(values = cols_survey) +
  scale_y_continuous(limits = c(0,1), labels = percent_format()) +
  scale_size_manual(values = c(3, 2)) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Proportion of people in relative poverty by tenure", 50),
       subtitle = str_wrap("Excludes pensioners; poverty is BHC; sample >= 100", 55))
  
```

## CiLIF and SHS - relative child poverty

Children in low-income families (CiLIF)^[https://www.gov.uk/government/publications/children-in-low-income-families-local-area-statistics-background-information-and-methodology/background-information-and-methodology-children-in-low-income-families-local-area-statistics] is DWP and HMRC's new admin-data based local child poverty measure. CiLIF numbers of children in relative poverty were calibrated to match (three-year-averaged) HBAI numbers broken down by UK region, work status, family type, and child age.

By definition, the CiLIF figure matches the official child poverty estimate for Scotland (200,000 children), which is the three-year average of the HBAI-based number of children in relative poverty befre housing costs in Scotland. The HBAI estimate in the table below (180,000) however is the single-year estimate.

Child poverty rates are not available for CiLIF because we don't have accurate estimates of the dependent child population^[A dependent child is any person aged 0-15, or aged 16-19 who is still in full-time non-advanced education and living at home.] for the disaggegrations included below.

We can see that SHS and CiLIF child poverty estimates match fairly well. We therefore expect child poverty numbers in the disaggregated data that follows to be comparable as well. (Note that the analysis compares SHS 2018 data and CiliF 2016-19 data.)


```{r cilif_all}

allcilif <- cilif_council %>%
  summarise(CiLIF = sum(Cilif))

SHS_CI <- confint(svytotal(~low60bhc, SHSdesign_ch))

tidydata %>%
  filter(low60bhc == 1) %>%
  group_by(survey) %>%
  summarise(SHS = sum(chwgt)) %>%
  spread(survey, SHS) %>%
  cbind(allcilif) %>%
  mutate(CiLIF = comma(CiLIF),
         HBAI = comma(HBAI, 10000),
         SHS = str_c(comma(SHS, 10000),
                     " (",
                     comma(SHS_CI[1], 10000),
                     "-",
                     comma(SHS_CI[2], 10000),
                     ")")) %>%
  knitr::kable(align = "rrr", caption = "Number of children in relative poverty")
  

```

### by family type 

```{r cilif_hhtype}

svyby(~low60bhc, ~hhtype, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  filter(hhtype %in% c("Single adult with children", "Two adults with children")) %>%
  left_join(cilif_hhtype, by = "hhtype") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(hhtype, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

### by work status 

Note that the term 'working' refers to adults who are in paid employment or self-employment.

```{r cilif_eco}

svyby(~low60bhc, ~work, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_work, by = "work") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(work, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

### by council area 

```{r cilif_council, fig.asp = 0.8}

cp <- tidydata %>%
  filter(survey == "SHS") %>%
  group_by(council) %>%
  mutate(allchildren = sum(chwgt),
         sample = n()) %>%
  group_by(council, low60bhc) %>%
  mutate(samplepov = ifelse(low60bhc == 1, sum(n()), 0)) %>%
  ungroup() %>%
  filter(samplepov >= 30)

cpnumbers <- svyby(~low60bhc, ~council, SHSdesign_ch, svytotal, vartype=c("ci","ci"))
  
cilifcomparison <- cpnumbers %>%
  left_join(cilif_council, by = "council") %>%
  mutate(council = fct_reorder(council, Cilif)) %>%
  rename(SHS = low60bhc ) %>%
  gather(source, children, -council,  -ci_l, -ci_u) %>%
  arrange(source)

corr <- cor.test(cilifcomparison$children[1:(length(cilifcomparison$children)/2)], cilifcomparison$children[(1+length(cilifcomparison$children)/2):length(cilifcomparison$children)], method=c("pearson", "kendall", "spearman"))

Pearson <- corr$estimate

cilifcomparison %>%
  mutate(council = factor(council),
         council = fct_reorder2(council, source, desc(children))) %>%
  ggplot(aes(x = council, y = children, colour = source)) +
  geom_point(aes(size = source)) +
  geom_errorbar(data = filter(cilifcomparison, source == "SHS"),
                aes(ymin = ci_l,
                    ymax = ci_u)) +
  coord_flip() +
  scale_colour_manual(values = wes_palettes[["Moonrise2"]]) +
  scale_size_manual(values = c(3,2)) +
  scale_y_continuous(labels = comma_format()) +
  labs(x = NULL, y = NULL,
       title = str_wrap("Number of children in relative poverty BHC by council, SHS and CiLIF", 50),
       subtitle = str_wrap("Excludes council areas with SHS samples (in poverty) < 30", 60)) +
  annotate("text", x = 3, y = Inf, label = str_c("Pearson correlation: ", percent(Pearson, 0.1)), hjust = 1)

```

### by urban/rural area 

```{r cilif_urbrur}

cilif_urbrur <- cilif_urbrur %>%
  mutate(urbrur = ifelse(urbrur %in% c("Accessible Small Towns", "Remote Small Towns"), "Small Towns",
                         ifelse(urbrur %in% c("Accessible Rural", "Remote Rural"), "Rural", urbrur))) %>%
  group_by(urbrur) %>%
  summarise(Cilif = sum(Cilif))


svyby(~low60bhc, ~urbrur, SHSdesign_ch, svytotal, vartype=c("ci","ci")) %>%
  left_join(cilif_urbrur, by = "urbrur") %>%
  mutate(SHS = str_c(comma(low60bhc, 10000),
                     " (",
                     comma(ci_l, 10000),
                     "-",
                     comma(ci_u, 10000),
                     ")"),
         CiLIF = comma(Cilif)) %>%
  select(urbrur, SHS, CiLIF) %>%
  knitr::kable(align = "lrr", caption = "Number of children in relative poverty")

```

<!-- # Other comparisons - don't include in paper -->

<!-- Comparing SHS income with SIMD quintile, financial management perception, material deprivation -->

<!-- ## with SIMD -->

<!-- Should this be SIMD income domain? -->

<!-- ```{r cpov_simd_ci} -->

<!-- cp <- tidydata %>% -->
<!--   filter(survey == "SHS") %>% -->
<!--   mutate(simd = factor(simd), -->
<!--          simdquint = fct_collapse(simd,  -->
<!--                              "1" = c("1","2"), -->
<!--                              "2" = c("3", "4"), -->
<!--                              "3" = c("5", "6"), -->
<!--                              "4" = c("7", "8"), -->
<!--                              "5" = c("9", "10"))) %>% -->
<!--   group_by(simdquint) %>% -->
<!--   mutate(allchildren = sum(chwgt), -->
<!--          sample = n()) %>% -->
<!--   ungroup() -->

<!-- SHSdesign <- svydesign(id = ~1, strata = ~council, weights = ~chwgt, data = cp, fpc = ~allchildren) -->

<!-- cprates <- svyby(~low60bhc, ~simdquint, SHSdesign, svymean, vartype=c("se","ci","ci")) -->

<!-- cprates %>% -->
<!--  ggplot(aes(x = simdquint, y =  low60bhc, ymin = ci_l, ymax = ci_u)) + -->
<!--   geom_point() + -->
<!--   geom_errorbar() + -->
<!--   geom_text(aes(y = 0.6, label = str_c(percent(low60bhc, 1), " (", percent(ci_l, 1), "-", percent(ci_u, 1), ")")), -->
<!--             hjust = 0) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "Proportion of children in relative poverty BHC by SIMD quintile", -->
<!--        subtitle = "Excludes pensioners") + -->
<!--   scale_y_continuous(limits = c(-0.1, 0.8), labels = NULL) + -->
<!--   coord_flip() -->

<!-- ``` -->

<!-- ## with perception of own financial management -->

<!-- ```{r managing_financially_pov_exc} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS", -->
<!--          !is.na(finman)) %>% -->
<!--   group_by(low60bhc, finman) %>% -->
<!--   summarise(fm = sum(ppwgt)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(low60bhc) %>% -->
<!--   mutate(people = sum(fm), -->
<!--          fmrate = fm/people) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(low60bhc = factor(low60bhc)) %>% -->
<!--   ggplot(aes(x = low60bhc, y = fmrate, fill = finman)) +  -->
<!--   geom_col(position = "stack", colour = "white") + -->
<!--   coord_flip() + -->
<!--   scale_x_discrete(labels = c("Not in poverty", "In poverty")) + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   scale_fill_manual(values = cols_finman) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How households are managing financially by poverty status", -->
<!--        subtitle = "Excludes pensioners, but income deciles based on all households") + -->
<!--   theme(legend.position = "right") -->

<!-- ``` -->

<!-- ```{r managing_financially_exc} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS", -->
<!--          !is.na(finman)) %>% -->
<!--   group_by(decile, finman) %>% -->
<!--   summarise(fm = sum(ppwgt)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(decile) %>% -->
<!--   mutate(people = sum(fm), -->
<!--          fmrate = fm/people) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(decile = factor(decile)) %>% -->
<!--   ggplot(aes(x = decile, y = fmrate, fill = finman)) +  -->
<!--   geom_col(position = "stack", colour = "white") + -->
<!--   coord_flip() + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   scale_fill_manual(values = cols_finman) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How households are managing financially by income decile", -->
<!--        subtitle = "Excludes pensioners, but income deciles based on all households") + -->
<!--   theme(legend.position = "right") -->

<!-- ``` -->

<!-- ## with material deprivation -->

<!-- ```{r matdep} -->

<!-- tidydata %>% -->
<!--   filter(survey == "SHS") %>% -->
<!--   group_by(decile, md) %>% -->
<!--   summarise(mdhh = sum(hhwgt)) %>% -->
<!--   group_by(decile) %>% -->
<!--   mutate(allhouseholds = sum(mdhh), -->
<!--          rate = mdhh/allhouseholds, -->
<!--          md = factor(md, levels = c(0:8), labels = c("Can afford all",  -->
<!--                                                      "Cannot afford 1 or 2 items",  -->
<!--                                                      "Cannot afford 1 or 2 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 3-5 items",  -->
<!--                                                      "Cannot afford 6-8 items",  -->
<!--                                                      "Cannot afford 6-8 items",  -->
<!--                                                      "Cannot afford 6-8 items"))) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(decile = factor(decile)) %>% -->
<!--   ggplot(aes(x = decile, y = rate, fill = md)) + -->
<!--   geom_col() + -->
<!--   scale_fill_manual(values = cols_finman[3:6]) + -->
<!--   coord_flip() + -->
<!--   theme(legend.position = "right") + -->
<!--   scale_y_continuous(labels = percent_format()) + -->
<!--   labs(x = NULL, y = NULL, -->
<!--        title = "How many basic necessities households cannot afford by income decile", -->
<!--        subtitle = "Excludes pensioners, but income deciles based on all households")  -->

<!-- ``` -->



